# Architecture File Audit Index

Last updated: 2026-02-23

## Scope

- Source scope: all Python files under `src/ghtrader/` (excluding `__init__.py`).
- Coverage target: 100/100 files audited.
- Priority lens: architecture maintainability and reliability/correctness.
- Mapping dimensions per file: responsibility, dependencies, failure modes, idempotency/recovery, boundary clarity, tests, PRD mapping, risk, top optimization.

## Coverage Summary

| Package | Files |
|---|---:|
| `src/ghtrader/` (root) | 6 |
| `src/ghtrader/cli_commands/` | 6 |
| `src/ghtrader/config_service/` | 3 |
| `src/ghtrader/util/` | 7 |
| `src/ghtrader/control/` + `control/routes/` | 28 |
| `src/ghtrader/data/` | 13 |
| `src/ghtrader/questdb/` | 11 |
| `src/ghtrader/tq/` | 9 |
| `src/ghtrader/trading/` | 4 |
| `src/ghtrader/research/` | 10 |
| `src/ghtrader/datasets/` | 3 |
| **Total** | **100** |

## Root + CLI + Config Service + Util

| file | responsibility | key_dependencies | failure_modes | idempotency_recovery | boundary_clarity | test_mapping | prd_mapping | risk | top_optimization |
|---|---|---|---|---|---|---|---|---|---|
| `src/ghtrader/cli.py` | CLI entrypoint: job registration, logging setup, lock acquisition, signal handling | `click`, `structlog`, `control.db`, `control.locks`, `config_service` | Lock timeout, job registration failure, signal interruption | Lock release on exit; job status update on failure | High (thin entrypoint + delegation) | `test_cli.py`, `test_cli_session_registry.py` | `3.2`, `10.4` | med | Reduce lock polling overhead |
| `src/ghtrader/config.py` | Environment config loading: `.env`, `accounts.env`, QuestDB/TqSdk credentials | `python-dotenv`, `config_service`, `tqsdk.TqAuth` | Missing required env vars; dotenv load failure | Idempotent via `_config_loaded` flag | High | `test_tqsdk_import_boundary.py` | `5.1.3`, `6.5` | low | Cache resolved values |
| `src/ghtrader/fill_labels.py` | Fill-probability labels at price offsets | `pandas`, `numpy`, `questdb.client`, `data.ticks_schema` | QuestDB failures; empty tick data; invalid horizons | DEDUP/UPSERT design prevents duplicates | High | `test_fill_labels.py` | `5.4.2` | med | Vectorize fill-offset computation |
| `src/ghtrader/capacity.py` | Capacity matrix reporting and smoke checks | `torch`, `questdb.client`, `shutil` | GPU unavailable; QuestDB unreachable | Idempotent report generation | High | `test_capacity_matrix.py` | `6.3`, `10.4` | low | Cache health probes |
| `src/ghtrader/regime.py` | HMM-based regime detection and persistence | `hmmlearn`, `sklearn`, `pandas`, `numpy`, `questdb.client` | Model-fit failure; QuestDB write failure; insufficient data | UPSERT keys prevent duplicates | Medium (complex state mapping) | none | `5.12` | med | Cache fitted models |
| `src/ghtrader/data_provider.py` | Abstract `DataProvider`/`ExecutionProvider` interfaces | `abc`, `dataclasses` | Interface contract drift in implementations | N/A (ABC only) | High | indirect (`test_tqsdk_import_boundary.py`) | `5.1.3` | low | Keep as strict interface contract |
| `src/ghtrader/cli_commands/data.py` | Data commands: `main-schedule`, `main-l5`, validate, quality, fill-labels | `cli._acquire_locks`, `data.*`, `fill_labels` | Lock conflicts; validation failures; QuestDB errors | Lock preemption on timeout | High | `test_main_l5_validate_hybrid.py`, `test_main_l5_validate_top_gaps.py`, `test_main_l5_validation_*` | `5.1`, `5.2` | med | Parallelize validation checks |
| `src/ghtrader/cli_commands/configuration.py` | Config Service CLI CRUD (`effective`, `set`, `history`, `rollback`, `migrate-env`) | `config_service.resolver` | Invalid value type; rollback to missing revision | Transactional revisions in SQLite | High | `test_cli_config_commands.py`, `test_control_config_api.py` | `7`, `10.4` | low | Enforce destructive confirmations |
| `src/ghtrader/cli_commands/db.py` | QuestDB ops: health/init/migrate/export/cleanup | `questdb.client`, `questdb.serving_db`, `questdb.migrate`, `questdb.queries` | Connection failures; migration errors; cleanup misuse | Dry-run paths for destructive ops | High | `test_questdb_*`, `test_questdb_row_cleanup_strategy.py` | `5.2.4`, `9` | med | Batch schema migrations with checkpoints |
| `src/ghtrader/cli_commands/runtime.py` | Runtime commands: account verify, gateway run, strategy run, dashboard | `tq.runtime`, `tq.gateway`, `trading.strategy_runner`, `control.app` | Account auth failure; gateway crash; strategy error | Lock-based isolation for account gateway | High | `test_control_gateway_api.py`, `test_control_strategy_api.py`, `test_accounts_profiles.py` | `5.11` | high | Add strategy-side lock symmetry |
| `src/ghtrader/cli_commands/research.py` | Research commands: build/train/backtest/paper/benchmark/compare/sweep | `datasets.*`, `research.*`, `tq.eval`, `tq.paper` | Training failure; model load error; data mismatch | Incremental build mode; command-level retries | High | `test_models.py`, `test_benchmark.py`, `test_pipeline.py` | `5.5`, `5.7`, `5.9` | med | Better failure-stage resumability |
| `src/ghtrader/cli_commands/features.py` | Feature store and factor registry commands | `datasets.features`, `datasets.feature_store`, `questdb.client` | Registry sync failure; QuestDB sync errors | Idempotent registry sync | High | `test_feature_store.py`, `test_features.py` | `5.3.4` | low | Batch registry updates |
| `src/ghtrader/config_service/schema.py` | Managed config schema, key typing, editable guards | none (schema only) | Invalid coercion, bound violations | Validation blocks invalid writes | High | `test_config_service_core.py` | `7`, `10.4` | med | Centralize env-only rejection helpers |
| `src/ghtrader/config_service/resolver.py` | Config resolver precedence: config.db -> env fallback | `config_service.store`, `os.environ` | Cache staleness; DB read failure | TTL cache + refresh | High | `test_config_service_core.py` | `7`, `10.4` | med | Explicit consistency checks after migrate |
| `src/ghtrader/config_service/store.py` | Config persistence: revisions, audit, rollback | `sqlite3`, `hashlib`, `json` | DB corruption; concurrent write contention | WAL + transactional writes | High | `test_config_service_core.py` | `7`, `10.4` | med | Enforce env-only key rejection in store layer |
| `src/ghtrader/util/worker_policy.py` | Worker policy resolution and caps | `config_service.resolver`, `os.cpu_count()` | Invalid config values; CPU detection edge cases | Safe defaults + clamps | High | `test_worker_policy.py` | `6.3.1.1` | low | Cache CPU count and derived caps |
| `src/ghtrader/util/observability.py` | In-memory rolling observability store | `threading`, `collections.deque` | Thread contention; memory growth | Bounded windows | High | `test_observability_store.py`, `test_observability_runtime_api.py`, `test_observability_slo.py` | `5.10`, `6.6` | low | Lock-free aggregation path |
| `src/ghtrader/util/l5_detection.py` | Unified L5 depth detection (DataFrame + SQL) | `pandas` | Missing columns; type mismatches | Safe fallbacks | High | `test_l5_detection.py` | `5.2.6` | low | Vectorize mask ops |
| `src/ghtrader/util/hash.py` | Deterministic hash helpers | `hashlib`, `pandas` | Encoding or dtype edge cases | Deterministic algorithm | High | indirect | `6.2` | low | Add explicit compatibility tests |
| `src/ghtrader/util/time.py` | UTC time helpers | `datetime` | timezone edge cases | UTC-only stable format | High | indirect | `6.2` | low | Keep minimal |
| `src/ghtrader/util/safe_parse.py` | Safe parse helpers (`int`, `float`) | none | Invalid input coercion | `None` fallback on parse failure | High | indirect | `6.1`, `6.2` | low | Keep minimal |
| `src/ghtrader/util/json_io.py` | Atomic JSON read/write utilities | `json`, `uuid`, `pathlib` | File I/O errors; serialization failures | tmp + replace atomic writes | High | indirect | `6.2` | low | Add fsync option for durability-critical writes |

## Control Plane (`control/` + `control/routes/`)

| file | responsibility | key_dependencies | failure_modes | idempotency_recovery | boundary_clarity | test_mapping | prd_mapping | risk | top_optimization |
|---|---|---|---|---|---|---|---|---|---|
| `src/ghtrader/control/routes/models.py` | Models API inventory/benchmark endpoints | `auth`, `cache`, `variety_context` | Scan failures; cache misses | TTL cache refresh | clear | none | `5.10`, `10.4` | med | Parallelize artifact scanning |
| `src/ghtrader/control/auth.py` | Optional dashboard/API token auth | `config` | Missing/mismatch token | stateless checks | clear | none | `6.5` | low | Add auth failure rate limit |
| `src/ghtrader/control/jobs.py` | Subprocess job runner and lifecycle | `db`, `job_metadata`, `config` | Spawn failure; PID drift; race on claims | startup reconcile + atomic claim | clear | `test_control_jobs.py`, `test_control_train_launch.py` | `5.10`, `10.4` | high | Better cancellation + heartbeat coherence |
| `src/ghtrader/control/system_info.py` | System metrics and QuestDB health snapshots | `config`, `subprocess`, `threading` | command timeout; tool missing | cached snapshots + fallback | clear | `test_control_explorer_page.py`, `test_ops_page.py` | `5.10`, `6.6` | med | Stagger expensive probes |
| `src/ghtrader/control/supervisors.py` | Scheduler + gateway/strategy supervisors | `jobs`, `supervisor_helpers`, `config` | tick loop errors; duplicate starts | repeated ticks + atomic start claims | clear | `test_gateway_supervisor_tick.py`, `test_strategy_supervisor_tick.py` | `5.10`, `5.11` | high | Add crash health checks + restart policy |
| `src/ghtrader/control/routes/core.py` | Core system/config/observability routes | `auth`, `slo`, `config_service` | config mutation errors; bad payload | rollback path + structured errors | clear | `test_control_api.py`, `test_observability_slo.py` | `5.10`, `7` | med | Harden config set/rollback validation |
| `src/ghtrader/control/views.py` | Main web UI routes and orchestration glue | `auth`, `jobs`, `variety_context`, templates | template/render/runtime coupling failures | cache + best-effort fallbacks | blurred (large mixed responsibilities) | `test_control_variety_routes.py`, `test_control_main_build_dedupe.py`, `test_data_page_cache.py` | `5.10`, `10.4` | high | Split into focused view modules |
| `src/ghtrader/control/views_helpers.py` | UI helper utilities | none | invalid coercion | safe defaulting | clear | none | `5.10` | low | Keep minimal |
| `src/ghtrader/control/views_system.py` | System page-specific views | templates + system_info helpers | render/query failures | graceful error rendering | clear | `test_control_explorer_page.py`, `test_ops_page.py` | `5.10` | low | Extract repeated template context builders |
| `src/ghtrader/control/views_config.py` | Config page-specific views | `config_service` | schema/value render errors | best-effort fallback rendering | clear | `test_control_config_page.py` | `7`, `5.10` | low | Add explicit schema-cache TTL |
| `src/ghtrader/control/app.py` | FastAPI app composition, WS, supervisors, API mounting | `db`, `jobs`, `supervisors`, `routes`, `views`, `redis` | WS disconnect; Redis listener errors; startup coupling failures | supervisor loops + Redis/file fallback | blurred (monolith) | `test_control_api.py`, `test_control_variety_defaults.py`, `test_observability_runtime_api.py` | `3.1`, `5.10`, `10.4` | high | Continue app modularization per PRD 10.4 |
| `src/ghtrader/control/routes/gateway.py` | Gateway status/desired/command APIs | `auth`, `state_helpers`, `redis` | Redis errors; stale file state | file fallback + best-effort publish | clear | `test_control_gateway_api.py`, `test_control_trading_console_api.py` | `5.11.7` | med | Redis reconnection backoff |
| `src/ghtrader/control/routes/accounts.py` | Account profile CRUD/verify routes | `auth`, `accounts_env`, `brokers`, `jobs` | env write failure; verify timeout | atomic file writes + fallback brokers | clear | `test_control_accounts_api.py`, `test_accounts_profiles.py` | `5.11.3` | med | Add secret-safe error shaping |
| `src/ghtrader/control/settings.py` | Dashboard scheduler settings persistence | `config_service`, `json_io` | file write/read errors | atomic writes + defaults | clear | none | `5.10` | low | Add schema versioning |
| `src/ghtrader/control/cache.py` | TTL cache primitives | `threading` | contention/stale cache | TTL eviction | clear | `test_control_cache.py` | `5.10` | low | Add bounded-size map mode |
| `src/ghtrader/control/state_helpers.py` | Shared file/redis state readers and status helpers | `redis`, `json_io` | state decode/read failures | redis fallback to file | clear | none | `3.1`, `5.11.7` | low | Reuse redis client handles |
| `src/ghtrader/control/routes/jobs.py` | Job API endpoints (list/create/cancel/log/progress) | `auth`, `db`, `jobs`, `progress` | stale job state; log read errors | status transitions persisted | clear | `test_control_jobs.py`, `test_job_progress.py` | `5.10.2` | med | Add pagination and filtering |
| `src/ghtrader/control/db.py` | SQLite `JobStore` persistence layer | `sqlite3`, `json` | lock contention; migration failures | WAL + transactional updates | clear | `test_control_jobs.py`, `test_cli_session_registry.py` | `5.10.1`, `5.10.2` | high | Add targeted indices + query limits |
| `src/ghtrader/control/job_metadata.py` | Job metadata inference and merge | `job_command`, `variety_context` | parse/infer mismatch | best-effort derivation | clear | `test_control_job_metadata.py` | `5.10` | low | Tighten metadata schema |
| `src/ghtrader/control/variety_context.py` | Variety (`cu/au/ag`) context helpers | none | invalid variety value | strict validation | clear | `test_control_variety_routes.py`, `test_control_variety_filters.py`, `test_control_variety_defaults.py` | `5.10` | low | Keep minimal |
| `src/ghtrader/control/supervisor_helpers.py` | Supervisor utility functions (job classification + desired scan) | `job_command`, `json_io` | parse/file read failures | defensive defaults | clear | `test_gateway_supervisor_tick.py`, `test_strategy_supervisor_tick.py` | `5.10` | low | Add desired-state cache |
| `src/ghtrader/control/brokers.py` | Broker list fetch/cache helpers | `urllib`, `json_io` | network fetch failure; cache parse issues | stale cache fallback | clear | none | `5.11.3` | low | TTL + jitter refresh |
| `src/ghtrader/control/accounts_env.py` | `accounts.env` parsing and atomic update helpers | `dotenv`, `json_io` | file corruption; write failure | atomic replace semantics | clear | `test_accounts_profiles.py` | `5.11.3` | med | Add conflict-safe update checks |
| `src/ghtrader/control/progress.py` | Job progress file writes/reads | `json`, `os` | write/read errors | best-effort with defaults | clear | `test_job_progress.py` | `5.10.2` | low | Optional fsync for critical stages |
| `src/ghtrader/control/job_command.py` | CLI argv parsing helpers | none | parse ambiguities | deterministic extraction | clear | none | `5.10` | low | Keep minimal |
| `src/ghtrader/control/routes/health.py` | Basic health endpoint | none | N/A | stateless | clear | none | `5.10` | low | Keep minimal |
| `src/ghtrader/control/slo.py` | SLO snapshot collection (`queue/QuestDB/Redis/GPU`) | `config`, `questdb`, `redis` | dependency check failure | returns degraded status payloads | clear | `test_observability_slo.py` | `6.6`, `5.10.4` | med | Parallelize dependency checks |
| `src/ghtrader/control/locks.py` | Cross-session lock management in SQLite | `sqlite3`, `os`, `jobs` table | stale lock; PID reuse; contention | stale lock reaping + timeout/poll | clear | `test_control_locks.py`, `test_cli_session_registry.py` | `5.10.1`, `5.2.3` | high | Improve fairness and timeout diagnostics |

## Data + QuestDB + Tq + Trading

| file | responsibility | key_dependencies | failure_modes | idempotency_recovery | boundary_clarity | test_mapping | prd_mapping | risk | top_optimization |
|---|---|---|---|---|---|---|---|---|---|
| `src/ghtrader/data/main_l5.py` | schedule-driven main_l5 builder and coverage reporting | `questdb.*`, `tq.ingest`, `data.manifest`, `config_service` | schedule mismatch; provider missing-day overflow; worker failure | full rebuild on hash mismatch; update-mode skip; replace-table cleanup | clear orchestrator | `test_main_l5_update.py` | `5.2.3`, `5.2.8`, `5.2.9` | high | optimize parallel worker allocation |
| `src/ghtrader/data/main_schedule.py` | build/refresh main schedule from TqSdk events | `questdb.main_schedule`, `data.trading_calendar`, `tq.main_schedule` | event extraction failure; WAL lag timeout | hash-based no-op update; clear+upsert semantics | clear | `test_main_schedule_update.py`, `test_symbol_normalization.py` | `5.2.9` | med | fast no-op and diff-aware updates |
| `src/ghtrader/data/main_l5_validation.py` | main_l5 validation orchestration and policy gating | `questdb.main_l5_validate`, `questdb.main_l5_validation_queries`, `data.main_l5_validation_*` | TqSdk check failure; query timeout; policy block | incremental checkpoint by day; batch upserts | clear | `test_main_l5_validate_hybrid.py`, `test_main_l5_validate_top_gaps.py`, `test_main_l5_validate_lock_policy.py` | `5.2.2`, `5.2.7` | high | batch/per-day query optimization |
| `src/ghtrader/data/main_l5_validation_builders.py` | build validation summary/gap artifacts | `questdb.main_l5_validate` | segment parse or datetime errors | skip invalid rows safely | clear | `test_main_l5_validation_builders.py` | `5.2.2` | low | keep pure-functional |
| `src/ghtrader/data/main_l5_validation_stats.py` | compute day gap stats and buckets | none | invalid/empty counts | defensive bounds and empty handling | clear | `test_main_l5_validation_stats.py` | `5.2.2`, `5.2.7` | low | keep pure-functional |
| `src/ghtrader/data/main_l5_validation_tqsdk.py` | provider-side missing segment verification via TqSdk | `tqsdk`, `util.l5_detection` | API failure; conversion errors | best-effort mutation + error counters | clear Tq boundary | `test_main_l5_validation_tqsdk.py` | `5.2.2` | med | batch provider checks |
| `src/ghtrader/data/field_quality.py` | field-level quality metrics and invariants | `questdb.field_quality`, `questdb.queries`, `ticks_schema` | query failure; empty frame handling | safe defaults on empty sets | clear | `test_field_quality_upsert.py`, `test_field_quality_invariants.py` | `5.2.6` | med | multi-day batched queries |
| `src/ghtrader/data/gap_detection.py` | read-only gap ledger helpers | `questdb.client` | query failure | return empty on errors | clear | none | `5.2.7` | low | keep minimal |
| `src/ghtrader/data/exchange_events.py` | load/filter exchange event JSON | `util.json_io` | JSON parse and schema errors | normalize invalid events | clear | none | `5.1.2` | low | schema validation |
| `src/ghtrader/data/trading_calendar.py` | holiday/trading-day cache and fallback calendar | `urllib`, `util.json_io` | network failure; cache corruption | weekday fallback + cache refresh | clear | `test_trading_calendar.py` | `5.1.2` | med | TTL + jitter on refresh |
| `src/ghtrader/data/trading_sessions.py` | session metadata cache from TqSdk | `util.json_io` | malformed session payload | returns `None` safely | clear | none | `5.1.2.1` | low | stricter payload validation |
| `src/ghtrader/data/ticks_schema.py` | canonical tick schema + row hash | `pandas`, `numpy` | dtype mismatch | deterministic hash and coercion | clear | `test_questdb_ingest_shape.py` | `5.2.1` | low | hash stability regression test |
| `src/ghtrader/data/manifest.py` | ingest/build manifest I/O | `util.json_io`, `subprocess` | write failure; git hash missing | safe fallback to `unknown` hash | clear | none | `5.2.5`, `6.2` | low | manifest schema versioning |
| `src/ghtrader/questdb/main_l5_validation_queries.py` | validation query helpers | `questdb.client`, `util.l5_detection` | timeout; empty result | safe empty outputs | clear | `test_main_l5_validation_queries.py` | `5.2.2` | med | batch query pushdown |
| `src/ghtrader/questdb/main_l5_validate.py` | validation table DDL/upsert layer | `questdb.client` | DDL/upsert failure | idempotent table ensure and upsert | clear | `test_main_l5_validate_hybrid.py` | `5.2.2` | med | tighten DDL failure observability |
| `src/ghtrader/questdb/main_schedule.py` | main schedule table CRUD and resolver | `questdb.client` | query/connection errors | idempotent upsert | clear | `test_main_schedule_update.py`, `test_symbol_resolver_schedule.py` | `5.2.9` | med | cache frequent lookups |
| `src/ghtrader/questdb/row_cleanup.py` | replace-table deletion strategy | `questdb.client` | partial replace failure risk | fail-fast strategy | clear | `test_questdb_row_cleanup_strategy.py` | `5.2.3` | high | checkpoint and verification counters |
| `src/ghtrader/questdb/serving_db.py` | ILP ingest backend with sender retry | `questdb.ingress`, `psycopg`, `ticks_schema`, `questdb.migrate` | sender closed; batch flush failures; DDL drift | retry/backoff; sender recreate | clear | `test_questdb_sender_compat.py` | `5.2.4` | high | sender lifecycle synchronization |
| `src/ghtrader/questdb/queries.py` | read query layer + Redis cache | `questdb.client`, `redis`, `util.l5_detection` | timeout; stale cache; connection drop | cache fallback + retries | clear | `test_questdb_client_retry.py`, `test_questdb_semantics.py` | `5.2.4` | high | query budget + cache TTL tuning |
| `src/ghtrader/questdb/field_quality.py` | field quality table ops | `questdb.client` | ensure/upsert failures | best-effort DDL and idempotent upsert | clear | `test_field_quality_upsert.py` | `5.2.6` | low | table schema guardrails |
| `src/ghtrader/questdb/migrate.py` | schema migration helpers | `questdb.client` | partial migration | idempotent migration commands | clear | none | `5.2.4` | med | migration ledger table |
| `src/ghtrader/questdb/bench.py` | benchmark utility | `questdb.ingress`, `psycopg`, `questdb.queries` | benchmark runtime failures | safe error dict outputs | clear | `test_benchmark.py` | `5.9` | low | persist benchmark baselines |
| `src/ghtrader/questdb/client.py` | PGWire connection and retry utils | `psycopg` | transient network failures | retry with backoff | clear | `test_questdb_client_retry.py` | `5.2.4` | high | pooled connection strategy |
| `src/ghtrader/questdb/features_labels.py` | features/labels table and metadata ops | `questdb.client`, `questdb.migrate` | DDL evolution failures | idempotent DDL + upsert | clear | none | `5.3.3`, `5.4.5` | med | unify schema evolution policy |
| `src/ghtrader/tq/gateway.py` | AccountGateway loop: market subscription, risk, execution, state | `tqsdk`, `zmq`, `redis`, `trading.execution`, `trading.symbol_resolver`, `tq.runtime` | API disconnect; ZMQ errors; Redis failure; risk kill | reconnect path; flatten on kill; file+redis state mirrors | blurred (large mixed runtime) | `test_tq_gateway_mvp.py`, `test_gateway_supervisor_tick.py`, `test_control_gateway_api.py` | `3.1`, `5.11.1`, `5.11.7` | high | split runtime loop and persist risk-kill state |
| `src/ghtrader/tq/runtime.py` | TqSdk runtime/account utilities and snapshots | `tqsdk`, `data.trading_calendar` | auth/account creation failures | defensive fallbacks | clear | `test_accounts_profiles.py`, `test_trading_observability.py` | `5.11.3`, `5.11.7` | med | cache trading-day resolution |
| `src/ghtrader/tq/ingest.py` | TqSdk historical L5 download + QuestDB write | `tqsdk`, `questdb.serving_db`, `ticks_schema`, `manifest`, `trading_sessions`, `exchange_events` | maintenance failures; timeout storms; ingest errors | retry/backoff + per-thread API reuse | clear | `test_tq_ingest_maintenance_retry.py`, `test_questdb_ingest_shape.py` | `5.1`, `5.2.3` | high | circuit breaker for maintenance storms |
| `src/ghtrader/tq/l5_start.py` | earliest L5 start-date probe | `tq.catalog`, `trading_calendar`, `l5_detection`, `json_io` | probe failure; stale cache | cache fallback | clear | none | `5.1.1` | low | probe result cache hygiene |
| `src/ghtrader/tq/main_schedule.py` | main schedule events extraction source | `tqsdk`, `trading_sessions`, `runtime` | backtest/extraction errors | best-effort extraction | clear | none | `5.2.9` | med | stronger event deduping |
| `src/ghtrader/tq/catalog.py` | contract catalog fetch + cache | `tqsdk`, `json_io` | fetch failure; cache parse failure | stale cache fallback | clear | none | `5.1.1` | low | adaptive cache TTL |
| `src/ghtrader/tq/execution.py` | TqSdk execution adapters | `tqsdk`, `trading.execution` | order submission failures | best-effort + limiter | clear | none | `5.11.4` | high | retry/backoff on order path |
| `src/ghtrader/tq/eval.py` | TqBacktest harness | `tqsdk`, `research.models`, `research.eval`, `datasets.features` | prediction/backtest runtime failures | guarded prediction loop | clear | none | `5.7.1` | med | batch feature evaluation |
| `src/ghtrader/tq/paper.py` | paper trading loop with calibrator | `tqsdk`, `research.models`, `research.online`, `datasets.features` | connect/predict/calibrator failures | live guard + defensive fallback | clear | none | `5.6`, `5.7` | med | calibrator stability tuning |
| `src/ghtrader/trading/strategy_runner.py` | strategy hot loop consuming gateway feed and emitting targets | `zmq`, `redis`, `strategy_control`, `research.models`, `datasets.features`, `tq.runtime` | ZMQ timeout; model load/predict failure; ack failure | safe halt; socket recreate; roll-triggered reinit | clear hot-path boundary | `test_strategy_runner.py`, `test_strategy_supervisor_tick.py` | `3.1`, `5.11.1` | high | robust REQ reconnection and heartbeat protocol |
| `src/ghtrader/trading/strategy_control.py` | strategy desired/state/event persistence | `redis`, `json_io`, `tq.runtime` | redis/file persistence errors | redis optional + file fallback | clear | `test_strategy_control.py` | `5.11.7` | med | state schema version checks |
| `src/ghtrader/trading/symbol_resolver.py` | continuous alias to tradable symbol resolver | `questdb.main_schedule`, `tq.runtime`, `trading_calendar` | missing schedule; day resolution errors | deterministic resolution with explicit errors | clear | `test_symbol_resolver_schedule.py`, `test_trading_symbol_and_orders.py` | `5.11.6` | med | cache per-day symbol mapping |
| `src/ghtrader/trading/execution.py` | order planning + risk clamp utilities | pure logic | invalid position state; SHFE offset edge cases | deterministic pure functions | clear | `test_trading_symbol_and_orders.py`, `test_trading_runtime_utils.py` | `5.11.4`, `5.11.5` | med | consolidate SHFE close-today priority tests |

## Research + Datasets

| file | responsibility | key_dependencies | failure_modes | idempotency_recovery | boundary_clarity | test_mapping | prd_mapping | risk | top_optimization |
|---|---|---|---|---|---|---|---|---|---|
| `src/ghtrader/research/models.py` | deep model zoo + training/inference integration | `models_base`, `models_baselines`, `models_factory`, `distributed`, `torch` | GPU OOM; DDP init failure; scaler mismatch | checkpointed save/load path | medium (very large module) | `test_models.py`, `test_sota_models.py` | `5.5`, `5.5.7` | high | split by model family modules |
| `src/ghtrader/research/models_factory.py` | model create/load dispatch helpers | `models_base`, `ModelType` | unknown model type/suffix mismatch | stateless factory | clear | `test_sota_models.py` | `5.5` | low | cache repeat loads |
| `src/ghtrader/research/models_baselines.py` | tabular baseline models | `sklearn`, `lightgbm`, `xgboost`, `pickle` | missing deps; NaN fit issues; pickle mismatch | deterministic save/load | clear | `test_sota_models.py` | `5.5.1` | med | stronger defaults + early stopping |
| `src/ghtrader/research/models_base.py` | base abstractions + sequence dataset utilities | `torch`, `numpy`, `config` | segment boundary leakage; device mismatch | deterministic batching helpers | clear | `test_models.py` | `5.5` | med | reduce memory copies in sequence assembly |
| `src/ghtrader/research/loop.py` | research-loop template generator | `json_io`, `datetime` | invalid path/symbol template error | idempotent template writes | clear | `test_research_loop_template.py` | `8.3`, `10.1` | low | template schema version field |
| `src/ghtrader/research/benchmark.py` | offline benchmark and walk-forward report generation | `datasets.features`, `datasets.labels`, `research.models`, `sklearn.metrics` | data mismatch; split insufficiency; training failure | run-isolated report generation | clear | `test_benchmark.py` | `5.9`, `5.7` | high | parallel split execution |
| `src/ghtrader/research/pipeline.py` | daily training pipeline + sweep + microsim | `research.eval`, `tq.eval`, `datasets.*`, `regime`, `ray.tune` | cascading step failures; Ray import/runtime issues | step-level resilience + report persistence | medium (multi-responsibility orchestrator) | `test_pipeline.py`, `test_ddp_smoke.py` | `5.8`, `5.18`, `6.3` | high | pipeline checkpoints and stage resumability |
| `src/ghtrader/research/online.py` | online calibrator and delayed label buffer | `numpy`, `deque` | calibrator drift disable; buffer overflow | bounded buffer + reset path | clear | `test_online.py` | `5.6` | med | adaptive LR and decay policies |
| `src/ghtrader/research/eval.py` | metrics + promotion gate + promotion action | `numpy`, `pandas`, `shutil` | threshold misconfig; copy failures | atomic promote path | clear | none | `5.8`, `5.15.3` | med | validate gate config on load |
| `src/ghtrader/research/distributed.py` | DDP setup helpers and seeding | `torch.distributed`, `os.environ` | rank/world-size mismatch; backend init failure | safe no-op for single process | clear | `test_distributed.py`, `test_ddp_smoke.py` | `5.5`, `6.3` | med | backend fallback and timeout tuning |
| `src/ghtrader/datasets/labels.py` | direction label computation + QuestDB storage + splits | `questdb.*`, `pandas`, `numpy`, `ticks_schema` | schedule hash mismatch; horizon/split edge cases | build_id idempotency + deterministic splits | clear | `test_labels.py` | `5.4.1`, `5.4.4` | high | stricter temporal leakage assertions |
| `src/ghtrader/datasets/features.py` | factor engine batch/incremental features + QuestDB writes | `questdb.*`, `pandas`, `numpy`, `deque`, `ticks_schema` | factor compute failure; lookback boundary mistakes | build_id idempotency + defensive incremental state | clear | `test_features.py` | `5.3.1`, `5.3.2`, `5.3.4` | high | incremental state persistence/restore |
| `src/ghtrader/datasets/feature_store.py` | feature registry + online store + staleness monitor | `threading`, `hashlib`, `json`, `questdb.features_labels` | thread-safety bugs; stale policy false positives | append-only registry + bounded online store | clear | `test_feature_store.py` | `5.3.4`, `5.3.5` | med | registry compaction + memory bounds |

