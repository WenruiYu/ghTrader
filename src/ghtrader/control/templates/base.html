<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>{{ title or "ghTrader Control" }}</title>
    <link rel="stylesheet" href="/static/app.css"/>
  </head>
  <body>
    <header class="topbar">
      <div class="brand">ghTrader</div>
      
      <div class="topbar-status" id="topbarStatus">
        <div class="topbar-status-item" id="statusQuestDB" title="QuestDB">
          <span class="status-dot status-dot-unknown"></span>
          <span>DB</span>
        </div>
        <div class="topbar-status-item" id="statusGPU" title="GPU">
          <span class="status-dot status-dot-unknown"></span>
          <span>GPU</span>
        </div>
      </div>
      
      <nav class="nav">
        {% set path = request.url.path %}
        {% set parts = path.split('/') %}
        {% set allowed_vars = allowed_varieties if allowed_varieties is defined else ["cu", "au", "ag"] %}
        {% set nav_var = variety if variety is defined else ((parts[2] if parts|length > 2 and parts[1] == "v" and parts[2] in allowed_vars else "cu")) %}
        {% set nav_section = parts[3] if parts|length > 3 and parts[1] == "v" else "" %}
        {% set nav_prefix = "/v/" ~ nav_var %}
        {% set switch_section = nav_section if nav_section in ["dashboard", "jobs", "data", "models", "trading"] else "dashboard" %}
        {% set qsep = "&" if token_qs else "?" %}
        <a href="{{ nav_prefix }}/dashboard{{ token_qs }}" class="{% if nav_section == 'dashboard' or path == '/' %}active{% endif %}">Dashboard</a>
        <a href="{{ nav_prefix }}/jobs{{ token_qs }}" class="{% if nav_section == 'jobs' or path.startswith('/jobs') %}active{% endif %}">
          Jobs
          {% if running_count is defined and running_count > 0 %}
            <span class="nav-badge">{{ running_count }}</span>
          {% endif %}
        </a>
        <a href="{{ nav_prefix }}/data{{ token_qs }}" class="{% if nav_section == 'data' or path.startswith('/data') or path.startswith('/ops') %}active{% endif %}">Data</a>
        <a href="{{ nav_prefix }}/models{{ token_qs }}" class="{% if nav_section == 'models' or path.startswith('/models') %}active{% endif %}">Models</a>
        <a href="{{ nav_prefix }}/trading{{ token_qs }}" class="{% if nav_section == 'trading' or path.startswith('/trading') %}active{% endif %}">Trading</a>
        <a href="/explorer{{ token_qs }}{% if token_qs %}&{% else %}?{% endif %}var={{ nav_var }}" class="{% if path.startswith('/explorer') %}active{% endif %}">SQL</a>
        <a href="/system{{ token_qs }}{% if token_qs %}&{% else %}?{% endif %}var={{ nav_var }}" class="{% if path.startswith('/system') %}active{% endif %}">System</a>
      </nav>
      <nav class="var-nav" aria-label="Variety switch">
        {% for v in allowed_vars %}
          {% if path.startswith('/explorer') %}
            {% set switch_href = "/explorer" ~ token_qs ~ qsep ~ "var=" ~ v %}
          {% elif path.startswith('/system') %}
            {% set switch_href = "/system" ~ token_qs ~ qsep ~ "var=" ~ v %}
          {% else %}
            {% set switch_href = "/v/" ~ v ~ "/" ~ switch_section ~ token_qs %}
          {% endif %}
          <a href="{{ switch_href }}" class="{% if v == nav_var %}active{% endif %}">{{ v|upper }}</a>
        {% endfor %}
      </nav>
    </header>

    {% set pc = page_context if page_context is defined and page_context is mapping else {} %}
    {% if pc %}
      <div class="workspace-strip">
        <div class="workspace-strip-main">
          <span class="pill">{{ pc.get("workspace_label") or ((variety or "cu")|upper ~ " workspace") }}</span>
          <span class="workspace-strip-title">{{ pc.get("page_title") or (title or "") }}</span>
        </div>
        {% set crumbs = pc.get("breadcrumbs") if pc.get("breadcrumbs") is sequence else [] %}
        {% if crumbs %}
          <nav class="breadcrumbs" aria-label="Breadcrumb">
            {% for crumb in crumbs %}
              {% set crumb_href = crumb.get("href") if crumb is mapping else "" %}
              {% set crumb_label = crumb.get("label") if crumb is mapping else "" %}
              {% if crumb_label %}
                {% if crumb_href %}
                  <a href="{{ crumb_href }}">{{ crumb_label }}</a>
                {% else %}
                  <span class="current">{{ crumb_label }}</span>
                {% endif %}
                {% if not loop.last %}<span class="sep">/</span>{% endif %}
              {% endif %}
            {% endfor %}
          </nav>
        {% endif %}
      </div>
    {% endif %}

    <main class="container">
      {% block alerts %}{% endblock %}
      {% block content %}{% endblock %}
    </main>
    
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
      // Global utilities for all pages
      window.ghTrader = window.ghTrader || {};
      
      // Token handling
      (function() {
        const qs = new URLSearchParams(window.location.search);
        const token = qs.get("token");
        window.ghTrader.token = token;
        
        window.ghTrader.withToken = function(url) {
          if (!token) return url;
          const u = new URL(url, window.location.origin);
          u.searchParams.set("token", token);
          return u.toString();
        };
        
        window.ghTrader.fetchApi = async function(path, options) {
          const url = window.ghTrader.withToken(path);
          const headers = Object.assign({}, options?.headers || {});
          if (token) headers["x-auth-token"] = token;
          return fetch(url, Object.assign({}, options, { headers }));
        };
        
        window.ghTrader.postJson = async function(path, payload) {
          const resp = await window.ghTrader.fetchApi(path, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload || {})
          });
          const body = await resp.json().catch(() => ({}));
          // Standardize error handling: some API endpoints return `{ok:false}` with 200.
          if (!resp.ok || (body && Object.prototype.hasOwnProperty.call(body, "ok") && body.ok === false)) {
            throw new Error(body.error || body.detail || `HTTP ${resp.status}`);
          }
          return body;
        };
      })();

      // Common helpers (vanilla JS)
      window.ghTrader.debounce = function(fn, delayMs) {
        let t = null;
        return function(...args) {
          if (t) clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), delayMs || 0);
        };
      };

      window.ghTrader.setButtonBusy = function(button, busy, opts) {
        if (!button) return;
        const options = opts || {};
        if (busy) {
          if (!button.dataset.idleText) {
            button.dataset.idleText = button.textContent || "";
          }
          button.disabled = true;
          button.setAttribute("aria-busy", "true");
          if (options.loadingText) button.textContent = options.loadingText;
        } else {
          button.disabled = false;
          button.removeAttribute("aria-busy");
          if (button.dataset.idleText) button.textContent = button.dataset.idleText;
        }
      };

      window.ghTrader.withButtonBusy = async function(button, fn, opts) {
        window.ghTrader.setButtonBusy(button, true, opts);
        try {
          return await fn();
        } finally {
          window.ghTrader.setButtonBusy(button, false, opts);
        }
      };

      window.ghTrader.retry = async function(task, retries, delayMs) {
        const maxRetries = Number.isFinite(Number(retries)) ? Number(retries) : 2;
        const sleepMs = Number.isFinite(Number(delayMs)) ? Number(delayMs) : 250;
        let lastErr = null;
        for (let i = 0; i <= maxRetries; i++) {
          try {
            return await task();
          } catch (e) {
            lastErr = e;
            if (i === maxRetries) break;
            await new Promise((r) => setTimeout(r, sleepMs));
          }
        }
        throw lastErr || new Error("retry failed");
      };

      // Initialize tabbed layouts using `.tab-nav-item[data-tab]` + `#tab-<id>` convention.
      window.ghTrader.initTabs = function(options) {
        const opts = options || {};
        const navSelector = opts.navSelector || ".tab-nav-item";
        const contentSelector = opts.contentSelector || ".tab-content";
        const activeClass = opts.activeClass || "active";
        const tabIdPrefix = opts.tabIdPrefix || "tab-";
        const updateHash = !!opts.updateHash;
        const onTab = (typeof opts.onTab === "function") ? opts.onTab : null;

        const navItems = Array.from(document.querySelectorAll(navSelector));
        const contents = Array.from(document.querySelectorAll(contentSelector));

        function activate(tabId) {
          navItems.forEach((t) => t.classList.remove(activeClass));
          contents.forEach((c) => c.classList.remove(activeClass));
          const nav = navItems.find((t) => String(t.dataset.tab || "") === String(tabId));
          const pane = document.getElementById(tabIdPrefix + tabId);
          if (nav) nav.classList.add(activeClass);
          if (pane) pane.classList.add(activeClass);
          if (updateHash) {
            try { history.replaceState(null, "", "#" + tabId); } catch (e) {}
          }
          if (onTab) {
            try { onTab(tabId); } catch (e) {}
          }
        }

        navItems.forEach((item) => {
          item.addEventListener("click", () => activate(item.dataset.tab));
        });

        const h = (String(window.location.hash || "").replace("#", "").trim());
        if (h && navItems.some((t) => String(t.dataset.tab || "") === h)) {
          activate(h);
        }

        return { activate, navItems, contents };
      };
      
      // Toast notifications
      window.ghTrader.toast = function(message, type) {
        type = type || "info";
        const container = document.getElementById("toastContainer");
        if (!container) return;
        const toast = document.createElement("div");
        toast.className = "toast toast-" + type;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          toast.style.transform = "translateX(100%)";
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      };
      
      // Status bar refresh
      (function() {
        async function refreshStatus() {
          try {
            const resp = await window.ghTrader.fetchApi("/api/ui/status");
            if (!resp.ok) return;
            const data = await resp.json();
            
            // QuestDB status
            const qdbEl = document.querySelector("#statusQuestDB .status-dot");
            if (qdbEl) {
              qdbEl.className = "status-dot " + (data.questdb_ok ? "status-dot-ok" : "status-dot-error");
            }
            
            // GPU status
            const gpuEl = document.querySelector("#statusGPU .status-dot");
            if (gpuEl) {
              const status = String(data.gpu_status || "");
              gpuEl.className = "status-dot " + (
                status === "ready" ? "status-dot-ok" :
                status === "running" ? "status-dot-warn" :
                status === "idle" ? "status-dot-idle" : "status-dot-unknown"
              );
            }
          } catch (e) {
            // Silently ignore status refresh errors
          }
        }
        
        // Initial refresh and periodic updates
        refreshStatus();
        setInterval(refreshStatus, 30000);
      })();
    </script>
    
    {% block scripts %}{% endblock %}
  </body>
</html>
