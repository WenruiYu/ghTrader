{% extends "base.html" %}
{% block content %}
  {% set var_query = token_qs ~ ("&" if token_qs else "?") ~ "var=" ~ variety %}
  {% set default_symbol = "KQ.m@SHFE." ~ variety %}
  <div class="section-header">
    <h2>SQL Explorer</h2>
    <div class="section-header-actions">
      <span class="pill">QuestDB</span>
      <a class="btn btn-secondary btn-sm" href="/explorer{{ var_query }}">Refresh</a>
    </div>
  </div>

  <div class="card">
    <p class="muted">
      Read-only SQL over QuestDB (canonical ticks) via PGWire. Only <span class="mono">SELECT</span>/<span class="mono">WITH</span> is allowed.
      Ensure QuestDB is running and tables exist (run <span class="mono">ghtrader db questdb-init</span>).
    </p>

    {% if error %}
      <pre class="mono raw-json text-danger">{{ error }}</pre>
    {% endif %}

    <form class="form" method="post" action="/explorer{{ var_query }}">
      <div class="grid2">
        <div>
          <label>Sample queries</label>
          <select id="sampleQuery">
            <option value="" selected>(select)</option>
            <option value="SELECT count() AS n_ticks FROM ghtrader_ticks_main_l5_v2">Count main_l5 rows</option>
            <option value="SELECT symbol, count() AS n_rows FROM ghtrader_ticks_main_l5_v2 GROUP BY symbol ORDER BY n_rows DESC LIMIT 20">Top symbols by rows (main_l5)</option>
            <option value="SELECT symbol, min(trading_day) AS first_day, max(trading_day) AS last_day, count(DISTINCT trading_day) AS n_days FROM ghtrader_ticks_main_l5_v2 GROUP BY symbol ORDER BY n_days DESC LIMIT 20">Coverage bounds by symbol (main_l5)</option>
            <option value="SELECT ts, symbol, last_price FROM ghtrader_ticks_main_l5_v2 WHERE symbol='{{ default_symbol }}' ORDER BY ts DESC LIMIT 50">Latest ticks for {{ default_symbol }}</option>
          </select>
        </div>
        <div class="muted form-actions">
          Paste your own SELECT/WITH queries below.
        </div>
      </div>
      <div>
        <label>Query</label>
        <textarea name="query" rows="10" class="mono" id="queryBox">{{ query or "" }}</textarea>
      </div>
      <div class="grid2">
        <div>
          <label>Max rows</label>
          <input name="limit" type="number" min="1" step="1" value="{{ limit or 200 }}"/>
        </div>
        <div class="form-actions-right">
          <button type="submit">Run query</button>
        </div>
      </div>
    </form>
  </div>

  <div class="card">
    <h3>Available tables</h3>
    <ul>
      <li><span class="mono">ghtrader_ticks_main_l5_v2</span></li>
    </ul>
    <p class="muted">Tip: tick tables include <span class="mono">dataset_version</span>, <span class="mono">ticks_kind</span>, and <span class="mono">trading_day</span>.</p>
  </div>

  {% if columns and rows %}
    <div class="card">
      <h3>Results ({{ rows|length }} rows)</h3>
      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              {% for c in columns %}
                <th class="mono">{{ c }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
              <tr>
                {% for c in columns %}
                  <td class="mono">{{ r.get(c, "") }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% elif not error %}
    <div class="card">
      <p class="muted">No results yet. Pick a sample query or run your own SQL.</p>
    </div>
  {% endif %}

  <script>
    (function() {
      const sample = document.getElementById("sampleQuery");
      const box = document.getElementById("queryBox");
      if (!sample || !box) return;
      sample.addEventListener("change", () => {
        if (!sample.value) return;
        box.value = sample.value;
        box.focus();
      });
    })();
  </script>
{% endblock %}

