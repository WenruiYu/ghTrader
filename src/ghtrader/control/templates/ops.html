{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Operations</h2>
    <div class="section-header-actions">
      <a href="/jobs{{ token_qs }}" class="btn btn-sm btn-secondary">View All Jobs</a>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="card card-compact">
    <div class="grid3">
      <div class="flex items-center gap-2">
        <div class="kpiLabel">Running</div>
        <div class="kpiValue" style="font-size:24px;">{{ running_count }}</div>
      </div>
      <div class="flex items-center gap-2">
        <div class="kpiLabel">Queued</div>
        <div class="kpiValue" style="font-size:24px;">{{ queued_count }}</div>
      </div>
      <div class="flex items-center gap-2">
        <div class="status-indicator {% if questdb and questdb.ok %}status-indicator-ok{% else %}status-indicator-error{% endif %}">
          <span class="status-dot {% if questdb and questdb.ok %}status-dot-ok{% else %}status-dot-error{% endif %}"></span>
          <span>QuestDB: {% if questdb and questdb.ok %}connected{% else %}offline{% endif %}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="pipeline">Pipeline</button>
    <button class="tab-nav-item" data-tab="ingest">Ingest</button>
    <button class="tab-nav-item" data-tab="build">Schedule & Build</button>
    <button class="tab-nav-item" data-tab="integrity">Integrity</button>
    <button class="tab-nav-item" data-tab="locks">
      Locks
      {% if locks and locks|length > 0 %}<span class="badge">{{ locks|length }}</span>{% endif %}
    </button>
  </div>

  <!-- Tab: Pipeline -->
  <div class="tab-content active" id="tab-pipeline">
    <div class="card">
      <h3 class="mb-2">Happy Path Pipeline</h3>
      <p class="muted text-sm mb-3">Execute the canonical workflow: Update (remote-aware), sync (repair/backfill), compute schedule, build main_l5, then features/labels.</p>

      <form method="post" action="/ops/ingest/update_variety{{ token_qs }}" class="mb-3">
        <input type="hidden" name="exchange" value="SHFE"/>
        <input type="hidden" name="variety" value="cu"/>
        <input type="hidden" name="recent_expired_days" value="10"/>
        <input type="hidden" name="data_dir" value="data"/>
        <input type="hidden" name="runs_dir" value="runs"/>
        <button type="submit" class="btn" style="width:100%;">0) Update cu (active + recent expired)</button>
      </form>
      
      <div class="pipeline-flow mb-3">
        <div class="pipeline-step">
          <div class="pipeline-step-icon">1</div>
          <div class="pipeline-step-label">Sync</div>
        </div>
        <div class="pipeline-arrow"></div>
        <div class="pipeline-step">
          <div class="pipeline-step-icon">2</div>
          <div class="pipeline-step-label">Schedule</div>
        </div>
        <div class="pipeline-arrow"></div>
        <div class="pipeline-step">
          <div class="pipeline-step-icon">3</div>
          <div class="pipeline-step-label">main_l5</div>
        </div>
        <div class="pipeline-arrow"></div>
        <div class="pipeline-step">
          <div class="pipeline-step-icon">4</div>
          <div class="pipeline-step-label">Build</div>
        </div>
        <div class="pipeline-arrow"></div>
        <div class="pipeline-step">
          <div class="pipeline-step-icon">5</div>
          <div class="pipeline-step-label">Train</div>
        </div>
      </div>

      <div class="grid3 mb-2">
        <form method="post" action="/ops/db/serve_sync_variety{{ token_qs }}">
          <input type="hidden" name="exchange" value="SHFE"/>
          <input type="hidden" name="variety" value="cu"/>
          <input type="hidden" name="data_dir" value="data"/>
          <input type="hidden" name="runs_dir" value="runs"/>
          <button type="submit" class="btn" style="width:100%;">1) Sync cu to QuestDB</button>
        </form>
        <form method="post" action="/ops/build/main_schedule{{ token_qs }}">
          <input type="hidden" name="variety" value="cu"/>
          <input type="hidden" name="start_date" value="{{ default_schedule_start }}"/>
          <input type="hidden" name="end_date" value="{{ default_schedule_end }}"/>
          <input type="hidden" name="threshold" value="1.1"/>
          <input type="hidden" name="data_dir" value="data"/>
          <button type="submit" class="btn btn-secondary" style="width:100%;">2) Build Schedule (cu)</button>
        </form>
        <form method="post" action="/ops/build/main_l5{{ token_qs }}">
          <input type="hidden" name="variety" value="cu"/>
          <input type="hidden" name="derived_symbol" value="KQ.m@SHFE.cu"/>
          <input type="hidden" name="data_dir" value="data"/>
          <input type="hidden" name="overwrite" value="false"/>
          <button type="submit" class="btn btn-secondary" style="width:100%;">3) Build main_l5 (cu)</button>
        </form>
      </div>
      <div class="grid3">
        <form method="post" action="/ops/build/build{{ token_qs }}">
          <input type="hidden" name="symbol" value="KQ.m@SHFE.cu"/>
          <input type="hidden" name="horizons" value="10,50,200"/>
          <input type="hidden" name="threshold_k" value="1"/>
          <input type="hidden" name="ticks_lake" value="main_l5"/>
          <input type="hidden" name="overwrite" value="false"/>
          <input type="hidden" name="data_dir" value="data"/>
          <button type="submit" class="btn btn-secondary" style="width:100%;">4) Build Features/Labels</button>
        </form>
        <a href="/models{{ token_qs }}" class="btn btn-secondary" style="width:100%; text-align:center; display:block; text-decoration:none;">5) Train Model</a>
        <a href="/trading{{ token_qs }}" class="btn btn-secondary" style="width:100%; text-align:center; display:block; text-decoration:none;">6) Start Trading</a>
      </div>
    </div>

    <div class="card">
      <h3 class="mb-2">Running Ingest Jobs</h3>
      <div class="tableWrap">
        <table class="table table-compact" id="ingestJobsTable">
          <thead>
            <tr>
              <th>ID</th><th>Status</th><th>Kind</th><th>Current</th><th>Progress</th><th></th>
            </tr>
          </thead>
          <tbody id="ingestJobsBody">
            {% for s in ingest_statuses %}
              <tr>
                <td class="mono text-xs">{{ s.job_id[:8] }}</td>
                <td><span class="pill pill-{{ s.job_status }}">{{ s.job_status }}</span></td>
                <td class="mono">{{ s.kind }}</td>
                <td class="mono">
                  {% if s.kind == "download_contract_range" %}{{ s.current_symbol or "" }}
                  {% elif s.kind == "download" %}{{ s.symbol or "" }}
                  {% else %}{{ s.current_symbol or "" }}{% endif %}
                </td>
                <td>
                  {% if s.summary and s.summary.pct is not none %}
                    <div class="progressBar"><div style="width: {{ (s.summary.pct * 100) | round(1) }}%;"></div></div>
                    <div class="mono text-xs" style="margin-top:4px;">{{ (s.summary.pct * 100) | round(1) }}%</div>
                  {% else %}<span class="mono">-</span>{% endif %}
                </td>
                <td><a href="/jobs/{{ s.job_id }}{{ token_qs }}">View</a></td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="muted">No ingest jobs running</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Ingest -->
  <div class="tab-content" id="tab-ingest">
    <div class="split-pane-2-1">
      <div>
        <div class="card">
          <h3 class="mb-2">Download Historical Data</h3>
          <form class="form" method="post" action="/ops/ingest/download{{ token_qs }}">
            <div class="grid3">
              <div><label>Symbol</label><input name="symbol" placeholder="SHFE.cu2602"/></div>
              <div><label>Start date</label><input name="start_date" type="date"/></div>
              <div><label>End date</label><input name="end_date" type="date"/></div>
            </div>
            <div class="grid2">
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
              <div><label>Chunk days</label><input name="chunk_days" type="number" min="1" value="5"/></div>
            </div>
            <button type="submit">Start Download</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Download Contract Range</h3>
          <form class="form" method="post" action="/ops/ingest/download_contract_range{{ token_qs }}">
            <div class="grid3">
              <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Chunk days</label><input name="chunk_days" type="number" min="1" value="5"/></div>
            </div>
            <div class="grid2">
              <div><label>Start contract (YYMM)</label><input name="start_contract" value="1601"/></div>
              <div><label>End contract</label><input name="end_contract" value="auto"/></div>
            </div>
            <div class="grid3">
              <div><label>Start date</label><input name="start_date" type="date" value="2015-01-01"/></div>
              <div><label>End date</label><input name="end_date" type="date"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Range Backfill</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Live Recorder</h3>
          <form class="form" method="post" action="/ops/ingest/record{{ token_qs }}">
            <div class="grid2">
              <div><label>Symbols (comma-separated)</label><input name="symbols" placeholder="SHFE.cu2602,SHFE.au2602"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Recorder</button>
          </form>
        </div>
      </div>

      <div class="card">
        <h3 class="mb-2">Ingest Tips</h3>
        <ul class="muted text-sm" style="padding-left:18px; margin:0;">
          <li style="margin-bottom:8px;"><strong>Symbol format:</strong> <code class="mono">EXCHANGE.instrumentYYMM</code> (e.g., SHFE.cu2602)</li>
          <li style="margin-bottom:8px;"><strong>Contract range:</strong> Use for bulk backfill of a variety (all cu contracts)</li>
          <li style="margin-bottom:8px;"><strong>Lake:</strong> v2-only (trading-day partitioning)</li>
          <li style="margin-bottom:8px;"><strong>Chunk days:</strong> Smaller chunks = more resilient to interrupts</li>
          <li><strong>Live recorder:</strong> Subscribes to ticks and appends to lake in real-time</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Tab: Schedule & Build -->
  <div class="tab-content" id="tab-build">
    <div class="split-pane">
      <div>
        <div class="card">
          <h3 class="mb-2">Build Main Schedule</h3>
          <p class="muted text-sm mb-2">Compute roll schedule from QuestDB end-of-day OI data.</p>
          <form class="form" method="post" action="/ops/build/main_schedule{{ token_qs }}">
            <div class="grid3">
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Start date</label><input name="start_date" value="{{ default_schedule_start }}"/></div>
              <div><label>End date</label><input name="end_date" value="{{ default_schedule_end }}"/></div>
            </div>
            <div class="grid2">
              <div><label>Threshold</label><input name="threshold" value="1.1"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Build Schedule</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Build main_l5</h3>
          <p class="muted text-sm mb-2">Materialize continuous main contract with L5 depth from underlying specific contracts.</p>
          <form class="form" method="post" action="/ops/build/main_l5{{ token_qs }}">
            <div class="grid3">
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Derived symbol</label><input name="derived_symbol" value="KQ.m@SHFE.cu"/></div>
              <div><label>Schedule path (optional)</label><input name="schedule_path" placeholder="auto"/></div>
            </div>
            <div class="grid2">
              <div><label>Overwrite</label>
                <select name="overwrite"><option value="false" selected>false</option><option value="true">true</option></select>
              </div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Build main_l5</button>
          </form>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">Build Features & Labels</h3>
          <p class="muted text-sm mb-2">Compute causal features and multi-horizon labels from tick data.</p>
          <form class="form" method="post" action="/ops/build/build{{ token_qs }}">
            <div class="grid2">
              <div><label>Symbol</label><input name="symbol" placeholder="KQ.m@SHFE.cu"/></div>
              <div><label>Ticks lake</label>
                <select name="ticks_lake"><option value="raw">raw</option><option value="main_l5" selected>main_l5</option></select>
              </div>
            </div>
            <div class="grid2">
              <div><label>Horizons (comma)</label><input name="horizons" value="10,50,200"/></div>
              <div><label>Threshold k</label><input name="threshold_k" value="1"/></div>
            </div>
            <div class="grid2">
              <div><label>Overwrite</label>
                <select name="overwrite"><option value="false" selected>false</option><option value="true">true</option></select>
              </div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Build</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Build Sequence</h3>
          <ol class="muted text-sm" style="padding-left:18px; margin:0;">
            <li style="margin-bottom:6px;">Sync raw ticks to QuestDB</li>
            <li style="margin-bottom:6px;">Compute main schedule (OI-based roll)</li>
            <li style="margin-bottom:6px;">Build main_l5 (continuous + L5 depth)</li>
            <li style="margin-bottom:6px;">Build features & labels</li>
            <li>Train models (see Models page)</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Integrity -->
  <div class="tab-content" id="tab-integrity">
    <div class="split-pane-2-1">
      <div class="card">
        <h3 class="mb-2">Run Audit</h3>
        <p class="muted text-sm mb-2">Verify checksums, schema conformity, and data integrity across datasets.</p>
        <form class="form" method="post" action="/ops/integrity/audit{{ token_qs }}">
          <div class="grid2">
            <div>
              <label>Scopes</label>
              <select name="scopes" multiple size="6">
                <option value="all" selected>all</option>
                <option value="ticks">ticks</option>
                <option value="main_l5">main_l5</option>
                <option value="features">features</option>
                <option value="labels">labels</option>
                <option value="completeness">completeness</option>
              </select>
            </div>
            <div>
              <label>Data dir</label><input name="data_dir" value="data"/>
              <label>Runs dir</label><input name="runs_dir" value="runs"/>
              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label class="text-sm">(completeness) Exchange</label>
                  <input name="exchange" value="SHFE"/>
                </div>
                <div>
                  <label class="text-sm">(completeness) Variety</label>
                  <input name="variety" value="cu"/>
                </div>
              </div>
              <label style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" name="refresh_catalog" value="true"/>
                <span class="text-sm">(completeness) Refresh catalog (network)</span>
              </label>
            </div>
          </div>
          <button type="submit">Run Audit</button>
        </form>
      </div>

      <div class="card">
        <h3 class="mb-2">Recent Audit Reports</h3>
        {% if reports and reports|length > 0 %}
          <ul style="list-style:none; padding:0; margin:0;">
            {% for r in reports[:10] %}
              <li style="margin-bottom:6px;"><a href="/ops/integrity/report/{{ r }}{{ token_qs }}" class="mono text-sm">{{ r }}</a></li>
            {% endfor %}
          </ul>
          {% if reports|length > 10 %}
            <div class="muted text-sm" style="margin-top:8px;">+ {{ reports|length - 10 }} more</div>
          {% endif %}
        {% else %}
          <div class="muted">No audit reports found</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tab: Locks -->
  <div class="tab-content" id="tab-locks">
    <div class="card">
      <h3 class="mb-2">Active Locks</h3>
      <p class="muted text-sm mb-2">Resource locks held across all sessions. Stale locks are reaped automatically on acquisition.</p>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr><th>Key</th><th>Job</th><th>PID</th><th>Created</th><th>Updated</th></tr>
          </thead>
          <tbody>
          {% for l in locks %}
            <tr>
              <td class="mono">{{ l.key }}</td>
              <td class="mono"><a href="/jobs/{{ l.job_id }}{{ token_qs }}">{{ l.job_id[:8] }}</a></td>
              <td class="mono">{{ l.pid }}</td>
              <td class="mono text-xs">{{ l.created_at }}</td>
              <td class="mono text-xs">{{ l.updated_at }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="muted">No active locks</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="mb-2">Lock Keys Reference</h3>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead><tr><th>Pattern</th><th>Command</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td class="mono">ticks:symbol=X</td><td>download, record</td><td>Per-symbol tick ingest</td></tr>
            <tr><td class="mono">ticks_range:exchange=X,var=Y</td><td>download-contract-range</td><td>Variety-wide backfill</td></tr>
            <tr><td class="mono">build:symbol=X,ticks_lake=Y</td><td>build</td><td>Feature/label build</td></tr>
            <tr><td class="mono">train:symbol=X,model=M,h=H</td><td>train</td><td>Model training</td></tr>
            <tr><td class="mono">main_schedule:var=X</td><td>main-schedule</td><td>Schedule computation</td></tr>
            <tr><td class="mono">main_depth:symbol=X</td><td>main-depth, main-l5</td><td>Derived dataset build</td></tr>
            <tr><td class="mono">trade:mode=X</td><td>trade</td><td>Trading execution</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  window.ghTrader.initTabs({ updateHash: true });

  // Ingest jobs auto-refresh
  const tokenQs = "{{ token_qs }}";
  
  async function refreshIngestJobs() {
    try {
      const resp = await window.ghTrader.fetchApi("/api/ingest/status?limit=50");
      if (!resp.ok) return;
      const data = await resp.json();
      const jobs = data.jobs || [];
      
      const tbody = document.getElementById("ingestJobsBody");
      if (!tbody) return;
      
      if (jobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No ingest jobs running</td></tr>';
        return;
      }
      
      tbody.innerHTML = jobs.map(s => {
        const current = s.kind === "download_contract_range" ? (s.current_symbol || "") :
                        s.kind === "download" ? (s.symbol || "") : (s.current_symbol || "");
        const pct = s.summary && s.summary.pct !== null ? s.summary.pct : null;
        const pctText = pct !== null ? (pct * 100).toFixed(1) + "%" : "-";
        const pctBar = pct !== null ? 
          '<div class="progressBar"><div style="width:' + (pct * 100).toFixed(1) + '%"></div></div>' +
          '<div class="mono text-xs" style="margin-top:4px;">' + pctText + '</div>' : '-';
        
        return [
          '<tr>',
          '<td class="mono text-xs">' + (s.job_id || "").substring(0, 8) + '</td>',
          '<td><span class="pill pill-' + (s.job_status || "queued") + '">' + (s.job_status || "") + '</span></td>',
          '<td class="mono">' + (s.kind || "") + '</td>',
          '<td class="mono">' + current + '</td>',
          '<td>' + pctBar + '</td>',
          '<td><a href="/jobs/' + (s.job_id || "") + tokenQs + '">View</a></td>',
          '</tr>'
        ].join("");
      }).join("");
    } catch (e) {
      // Ignore errors
    }
  }
  
  // Initial refresh and auto-refresh every 10s
  refreshIngestJobs();
  setInterval(refreshIngestJobs, 10000);
})();
</script>
{% endblock %}
