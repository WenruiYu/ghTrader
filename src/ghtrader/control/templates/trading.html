{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Trading Console</h2>
    <div class="section-header-actions">
      <button class="btn btn-sm btn-secondary" id="refreshTrading">Refresh</button>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="card card-compact flex items-center gap-4 flex-wrap" id="tradingStatusBar">
    <div class="status-indicator" id="tradingModeIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Mode: Idle</span>
    </div>
    <div class="status-indicator" id="tradingLiveEnabledIndicator">
      <span class="status-dot status-dot-unknown"></span>
      <span>Live enabled: --</span>
    </div>
    <div class="status-indicator" id="tradingAccountIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Account profile:</span>
      <select id="accountProfileSelect">
        <option value="default" selected>default</option>
      </select>
      <span class="muted text-sm" id="accountProfileConfigured">--</span>
    </div>
    <div class="muted text-sm" id="tradingLastUpdate">Last update: --</div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="status">Live Status</button>
    <button class="tab-nav-item" data-tab="start">Start / Control</button>
    <button class="tab-nav-item" data-tab="history">
      Run History
      <span class="badge" id="runCountBadge">--</span>
    </button>
    <button class="tab-nav-item" data-tab="accounts">Accounts</button>
  </div>

  <!-- Tab: Live Status -->
  <div class="tab-content active" id="tab-status">
    <div class="kpi-grid mb-3">
      <div class="kpi-card">
        <div class="kpiLabel">Trading Mode</div>
        <div class="kpiValue" id="kpiMode">Idle</div>
        <div class="kpiSubtext" id="kpiModeDetail">No active process</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Balance</div>
        <div class="kpiValue mono" id="kpiBalance">--</div>
        <div class="kpiSubtext" id="kpiEquity">Equity: --</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Position</div>
        <div class="kpiValue" id="kpiPosition">0</div>
        <div class="kpiSubtext" id="kpiPositionSymbol">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Unrealized P&L</div>
        <div class="kpiValue mono" id="kpiPnL">--</div>
        <div class="kpiSubtext" id="kpiPnLPct">--</div>
      </div>
    </div>

    <div class="split-pane">
      <div>
        <div class="card">
          <h3 class="mb-2">Active Control Plane</h3>
          <div id="activeRunInfo">
            <div class="empty-state" style="padding:30px;">
              <div class="empty-state-title">No Active Process</div>
              <div class="empty-state-text">Use the “Start / Control” tab to set Gateway/Strategy desired state.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Positions</h3>
          <div class="tableWrap">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Direction</th>
                  <th>Volume</th>
                  <th>Avg Price</th>
                  <th>Current</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody id="positionsTbody">
                <tr><td colspan="6" class="muted">No positions</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">Recent Signals / Targets</h3>
          <div class="tableWrap" style="max-height:220px; overflow:auto;">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Signal</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="signalsTbody">
                <tr><td colspan="4" class="muted">No signals</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Risk Metrics</h3>
          <div class="grid2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Position</div>
                <div class="metric-value" id="riskMaxPos">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Order Size</div>
                <div class="metric-value" id="riskMaxOrder">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Ops/Sec</div>
                <div class="metric-value" id="riskMaxOps">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Daily Loss Limit</div>
                <div class="metric-value" id="riskDailyLoss">--</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Recent Orders (alive)</h3>
          <div class="tableWrap" style="max-height:180px; overflow:auto;">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Volume</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="5" class="muted">No orders</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Start / Control -->
  <div class="tab-content" id="tab-start">
    <div class="split-pane-2-1">
      <div>
        <div class="card">
          <h3 class="mb-2">Gateway-first control plane</h3>
          <div class="muted text-sm">
            Preferred path: set desired state for <strong>AccountGateway</strong> and <strong>StrategyRunner</strong>.
            The dashboard supervisors will start/stop processes automatically.
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">AccountGateway (OMS/EMS)</h3>
          <div class="muted text-sm mb-2">
            Gateway state is persisted under <span class="mono">runs/gateway/account=&lt;profile&gt;/</span>.
            This control plane edits <span class="mono">desired.json</span> and appends <span class="mono">commands.jsonl</span>.
          </div>

          <div class="grid3 mb-2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Selected profile</div>
                <div class="metric-value mono" id="gatewayProfile">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Gateway health</div>
                <div class="metric-value mono" id="gatewayHealth">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Last update</div>
                <div class="metric-value mono text-sm" id="gatewayUpdatedAt">--</div>
              </div>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end;">
            <button type="button" class="btn btn-sm btn-secondary" id="gatewayRefreshBtn">Refresh</button>
          </div>

          <form class="form" id="gatewayDesiredForm">
            <h4 class="mb-2">Desired state</h4>
            <div class="grid3">
              <div>
                <label>Mode</label>
                <select id="gatewayMode">
                  <option value="idle">idle</option>
                  <option value="paper">paper</option>
                  <option value="sim">sim</option>
                  <option value="live_monitor">live_monitor</option>
                  <option value="live_trade">live_trade</option>
                </select>
              </div>
              <div>
                <label>Executor</label>
                <select id="gatewayExecutor">
                  <option value="targetpos" selected>targetpos</option>
                  <option value="direct">direct</option>
                </select>
              </div>
              <div>
                <label>Sim account</label>
                <select id="gatewaySimAccount">
                  <option value="tqsim" selected>tqsim</option>
                  <option value="tqkq">tqkq</option>
                </select>
              </div>
            </div>
            <div class="grid2">
              <div>
                <label>Symbols (comma-separated)</label>
                <input id="gatewaySymbols" placeholder="SHFE.cu2602,SHFE.au2602"/>
              </div>
              <div>
                <label>Confirm live (required for live_trade)</label>
                <input id="gatewayConfirmLive" placeholder="I_UNDERSTAND" />
              </div>
            </div>
            <div class="grid3">
              <div><label>Max abs position</label><input id="gatewayMaxAbsPos" type="number" min="0" value="1"/></div>
              <div><label>Max order size</label><input id="gatewayMaxOrderSize" type="number" min="1" value="1"/></div>
              <div><label>Max ops/sec</label><input id="gatewayMaxOpsSec" type="number" min="1" value="10"/></div>
            </div>
            <div class="grid3">
              <div><label>Max daily loss (optional)</label><input id="gatewayMaxDailyLoss" placeholder="(optional)"/></div>
              <div>
                <label>Enforce trading time</label>
                <select id="gatewayEnforceTradingTime">
                  <option value="true" selected>true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div style="display:flex; align-items:flex-end; gap:8px;">
                <button type="submit" class="btn btn-primary">Apply desired</button>
              </div>
            </div>
          </form>

          <div class="card" style="margin-top:12px; background: var(--warn-bg); border-color: var(--warn-border);">
            <h4 class="mb-2">Manual interventions (logged)</h4>
            <div class="muted text-sm mb-2">
              These append commands to <span class="mono">commands.jsonl</span>. Use only when necessary.
            </div>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn btn-secondary btn-sm" id="gatewayCmdCancelAll">Cancel all orders</button>
              <button type="button" class="btn btn-secondary btn-sm" id="gatewayCmdFlatten">Flatten positions</button>
              <button type="button" class="btn btn-danger btn-sm" id="gatewayCmdDisarm">Disarm live (switch to live_monitor)</button>
            </div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h4 class="mb-2">Raw status (transparent)</h4>
            <pre class="mono text-xs" id="gatewayRaw" style="white-space:pre-wrap;">--</pre>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">StrategyRunner (AI)</h3>
          <div class="muted text-sm mb-2">
            Strategy state is persisted under <span class="mono">runs/strategy/account=&lt;profile&gt;/</span>.
            This control plane edits <span class="mono">desired.json</span>.
          </div>

          <div class="grid3 mb-2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Selected profile</div>
                <div class="metric-value mono" id="strategyProfile">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Strategy health</div>
                <div class="metric-value mono" id="strategyHealth">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Last update</div>
                <div class="metric-value mono text-sm" id="strategyUpdatedAt">--</div>
              </div>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end;">
            <button type="button" class="btn btn-sm btn-secondary" id="strategyRefreshBtn">Refresh</button>
          </div>

          <form class="form" id="strategyDesiredForm">
            <h4 class="mb-2">Desired state</h4>
            <div class="grid2">
              <div>
                <label>Mode</label>
                <select id="strategyMode">
                  <option value="idle" selected>idle</option>
                  <option value="run">run</option>
                </select>
              </div>
              <div>
                <label>Symbols (comma-separated)</label>
                <input id="strategySymbols" placeholder="SHFE.cu2602,SHFE.au2602"/>
              </div>
            </div>
            <div class="grid3">
              <div><label>Model</label><input id="strategyModelName" value="xgboost"/></div>
              <div><label>Horizon</label><input id="strategyHorizon" value="50"/></div>
              <div><label>Position size</label><input id="strategyPositionSize" value="1"/></div>
            </div>
            <div class="grid2">
              <div><label>Threshold up</label><input id="strategyThresholdUp" value="0.6"/></div>
              <div><label>Threshold down</label><input id="strategyThresholdDown" value="0.6"/></div>
            </div>
            <div class="grid2">
              <div><label>Artifacts dir</label><input id="strategyArtifactsDir" value="artifacts"/></div>
              <div><label>Poll interval (sec)</label><input id="strategyPollIntervalSec" value="0.5"/></div>
            </div>
            <button type="submit" class="btn btn-primary">Apply desired</button>
          </form>

          <div class="card" style="margin-top:12px;">
            <h4 class="mb-2">Raw status (transparent)</h4>
            <pre class="mono text-xs" id="strategyRaw" style="white-space:pre-wrap;">--</pre>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Active Jobs (gateway/strategy)</h3>
          <div id="tradingJobsList">
            <div class="muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Run History -->
  <div class="tab-content" id="tab-history">
    <div class="card">
      <h3 class="mb-2">Strategy runs (<span class="mono">runs/strategy/&lt;run_id&gt;/</span>)</h3>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Account</th>
              <th>Model</th>
              <th>Horizon</th>
              <th>Created</th>
              <th>Last event</th>
            </tr>
          </thead>
          <tbody id="strategyRunHistoryTbody">
            <tr><td colspan="6" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Accounts -->
  <div class="tab-content" id="tab-accounts">
    <div class="card">
      <h3 class="mb-2">Broker Accounts (profiles)</h3>
      <div class="muted text-sm mb-2">Credentials are stored in <span class="mono">runs/control/accounts.env</span> (gitignored). Add/edit accounts here; the table only displays non-secret info.</div>

      <form class="form" id="accountUpsertForm" style="margin-bottom:12px;">
        <h4 class="mb-2">Add / Edit Account</h4>
        <div class="grid3">
          <div>
            <label>Profile</label>
            <input id="accountFormProfile" placeholder="tg_1" autocomplete="off" />
          </div>
          <div>
            <label>Broker ID</label>
            <input id="accountFormBroker" list="brokerIdList" placeholder="T铜冠金源" autocomplete="off" />
            <datalist id="brokerIdList"></datalist>
          </div>
          <div>
            <label>Account ID</label>
            <input id="accountFormAccountId" autocomplete="off" />
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Password</label>
            <input id="accountFormPassword" type="password" autocomplete="new-password" />
          </div>
          <div style="display:flex; gap:8px; align-items:flex-end;">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" id="accountFormClear">Clear</button>
          </div>
        </div>
        <div class="muted text-sm">Tip: profile names are normalized to <span class="mono">[a-z0-9_]</span>. Passwords are never displayed back.</div>
      </form>

      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Profile</th>
              <th>Broker</th>
              <th>Account</th>
              <th>Configured</th>
              <th>Gateway</th>
              <th>Strategy</th>
              <th>Last verify</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="accountsTbody">
            <tr><td colspan="8" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script src="/static/trading.js"></script>
{% endblock %}

