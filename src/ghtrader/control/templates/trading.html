{% extends "base.html" %}
{% block content %}
  <input type="hidden" id="currentVariety" value="{{ variety }}" />
  <div class="section-header">
    <h2>Trading Console · {{ variety|upper }}</h2>
    <div class="section-header-actions">
      <button class="btn btn-sm btn-secondary" id="refreshTrading">Refresh</button>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="card card-compact flex items-center gap-4 flex-wrap" id="tradingStatusBar">
    <div class="status-indicator" id="tradingModeIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Mode: Idle</span>
    </div>
    <div class="status-indicator" id="tradingLiveEnabledIndicator">
      <span class="status-dot status-dot-unknown"></span>
      <span>Live enabled: --</span>
    </div>
    <div class="status-indicator" id="tradingWarmPathIndicator">
      <span class="status-dot status-dot-unknown"></span>
      <span>Warm path: --</span>
    </div>
    <div class="status-indicator" id="tradingRiskKillIndicator">
      <span class="status-dot status-dot-unknown"></span>
      <span>Risk kill: --</span>
    </div>
    <div class="status-indicator" id="tradingAccountIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Account profile:</span>
      <select id="accountProfileSelect">
        <option value="default" selected>default</option>
      </select>
      <span class="muted text-sm" id="accountProfileConfigured">--</span>
    </div>
    <div class="muted text-sm" id="tradingLastUpdate">Last update: --</div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="monitor">Auto Monitor</button>
    <button class="tab-nav-item" data-tab="test">Manual Test</button>
    <button class="tab-nav-item" data-tab="config">Account Config</button>
  </div>

  <!-- Tab: Auto Monitor -->
  <div class="tab-content active" id="tab-monitor">
    <!-- KPI Grid -->
    <div class="kpi-grid mb-3">
      <div class="kpi-card">
        <div class="kpiLabel">Trading Mode</div>
        <div class="kpiValue" id="kpiMode">Idle</div>
        <div class="kpiSubtext" id="kpiModeDetail">No active process</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Balance</div>
        <div class="kpiValue mono" id="kpiBalance">--</div>
        <div class="kpiSubtext" id="kpiEquity">Equity: --</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Position</div>
        <div class="kpiValue" id="kpiPosition">0</div>
        <div class="kpiSubtext" id="kpiPositionSymbol">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Unrealized P&L</div>
        <div class="kpiValue mono" id="kpiPnL">--</div>
        <div class="kpiSubtext" id="kpiPnLPct">--</div>
      </div>
    </div>

    <!-- Gateway/Strategy Health -->
    <div class="grid2 mb-3">
      <div class="card card-compact">
        <h4 class="mb-1">Gateway Health</h4>
        <div class="grid3">
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Status</div>
              <div class="metric-value" id="monitorGatewayStatus">--</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Mode</div>
              <div class="metric-value mono" id="monitorGatewayMode">--</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Symbols</div>
              <div class="metric-value mono text-sm" id="monitorGatewaySymbols">--</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card card-compact">
        <h4 class="mb-1">Strategy Health</h4>
        <div class="grid3">
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Status</div>
              <div class="metric-value" id="monitorStrategyStatus">--</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Model</div>
              <div class="metric-value mono" id="monitorStrategyModel">--</div>
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-content">
              <div class="metric-label">Last target</div>
              <div class="metric-value mono text-sm" id="monitorStrategyTarget">--</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="split-pane">
      <div>
        <!-- Positions -->
        <div class="card">
          <h3 class="mb-2">Positions</h3>
          <div class="tableWrap">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Direction</th>
                  <th>Volume</th>
                  <th>Avg Price</th>
                  <th>Current</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody id="positionsTbody">
                <tr><td colspan="6" class="muted">No positions</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Recent Orders -->
        <div class="card">
          <h3 class="mb-2">Recent Orders (alive)</h3>
          <div class="tableWrap table-scroll-sm">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Volume</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="5" class="muted">No orders</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <!-- Recent Signals -->
        <div class="card">
          <h3 class="mb-2">Recent Signals / Targets</h3>
          <div class="tableWrap table-scroll-md">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Signal</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="signalsTbody">
                <tr><td colspan="4" class="muted">No signals</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Risk Metrics -->
        <div class="card">
          <h3 class="mb-2">Risk Metrics</h3>
          <div class="grid2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Position</div>
                <div class="metric-value" id="riskMaxPos">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Order Size</div>
                <div class="metric-value" id="riskMaxOrder">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Ops/Sec</div>
                <div class="metric-value" id="riskMaxOps">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Daily Loss Limit</div>
                <div class="metric-value" id="riskDailyLoss">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Strategy Run History (moved from separate tab) -->
    <div class="card">
      <h3 class="mb-2">
        Strategy Run History
        <span class="badge" id="runCountBadge">--</span>
      </h3>
      <div class="tableWrap table-scroll-lg">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Account</th>
              <th>Model</th>
              <th>Horizon</th>
              <th>Created</th>
              <th>Last event</th>
            </tr>
          </thead>
          <tbody id="strategyRunHistoryTbody">
            <tr><td colspan="6" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Raw API Response (collapsible) -->
    <details class="card mt-3">
      <summary class="summary-plain">
        Raw API Response
        <span class="muted text-sm summary-hint">(click to expand)</span>
      </summary>
      <pre class="mono text-xs raw-json" id="monitorRawResponse">--</pre>
    </details>
  </div>

  <!-- Tab: Manual Test -->
  <div class="tab-content" id="tab-test">
    <!-- Quick Start Panel -->
    <div class="card panel-accent">
      <h3 class="mb-2">Quick Start</h3>
      <div class="muted text-sm mb-2">
        Start/stop trading processes with minimal configuration. For advanced settings, expand the sections below.
      </div>

      <!-- Process Status Strip -->
      <div class="grid4 mb-3">
        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Gateway Status</div>
            <div class="metric-value" id="qsGatewayStatus">--</div>
            <div class="metric-sub text-xs muted" id="qsGatewayMode">Mode: --</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Strategy Status</div>
            <div class="metric-value" id="qsStrategyStatus">--</div>
            <div class="metric-sub text-xs muted" id="qsStrategyMode">Mode: --</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Last Update</div>
            <div class="metric-value text-sm mono" id="qsLastUpdate">--</div>
          </div>
        </div>
        <div class="metric-card">
          <div class="metric-content">
            <div class="metric-label">Live Enabled</div>
            <div class="metric-value" id="qsLiveEnabled">--</div>
          </div>
        </div>
      </div>

      <!-- Stale Warning -->
      <div id="qsStaleWarning" class="muted text-sm mb-2 banner-inline-warn" hidden>
        <strong>Warning:</strong> Gateway state is stale (>30s). The process may have stopped. Consider restarting.
      </div>

      <!-- Quick Config -->
      <div class="grid3 mb-3">
        <div>
          <label>Mode</label>
          <select id="qsMode">
            <option value="sim" selected>sim (simulated)</option>
            <option value="live_monitor">live_monitor (read-only)</option>
            <option value="live_trade">live_trade (real orders)</option>
          </select>
        </div>
        <div>
          <label>Symbols (comma-separated)</label>
          <input id="qsSymbols" placeholder="SHFE.{{ variety }}2602"/>
        </div>
        <div id="qsConfirmLiveWrap" hidden>
          <label>Confirm live (required)</label>
          <input id="qsConfirmLive" placeholder="I_UNDERSTAND"/>
        </div>
      </div>

      <!-- Start/Stop Buttons -->
      <div class="btn-group">
        <button type="button" class="btn btn-success" id="qsStartGateway">Start Gateway</button>
        <button type="button" class="btn btn-secondary" id="qsStopGateway">Stop Gateway</button>
        <span class="btn-divider"></span>
        <button type="button" class="btn btn-info" id="qsStartStrategy">Start Strategy</button>
        <button type="button" class="btn btn-secondary" id="qsStopStrategy">Stop Strategy</button>
        <span class="muted text-sm status-right" id="qsActionStatus">Ready</span>
      </div>

      <!-- Prerequisites Hint -->
      <div id="qsPrereqHint" class="muted text-xs mt-3" hidden>
        <span class="text-warn">Note:</span> <span id="qsPrereqText"></span>
      </div>
    </div>

    <!-- Quick Order Panel -->
    <div class="card panel-accent">
      <h3 class="mb-2">Quick Order (Manual Test)</h3>
      <div class="muted text-sm mb-2">
        Execute one-lot orders manually for testing. Requires gateway in <strong>sim</strong> or <strong>live_trade</strong> mode with symbols configured.
      </div>
      <div class="grid4 mb-2">
        <div>
          <label>Symbol</label>
          <select id="manualOrderSymbol">
            <option value="">-- select --</option>
          </select>
        </div>
        <div>
          <label>Size (lots)</label>
          <input id="manualOrderSize" type="number" min="1" max="10" value="1"/>
        </div>
        <div>
          <label>Current Position</label>
          <div class="metric-value mono metric-value-lg" id="manualCurrentPos">0</div>
        </div>
        <div>
          <label>Gateway Mode</label>
          <div class="metric-value mono metric-value-md" id="manualGatewayMode">--</div>
        </div>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-success" id="manualOpenLong">Open Long (+1)</button>
        <button type="button" class="btn btn-danger" id="manualOpenShort">Open Short (-1)</button>
        <button type="button" class="btn btn-secondary" id="manualCloseAll">Close Position (0)</button>
        <span class="muted text-sm status-right" id="manualOrderStatus">Ready</span>
      </div>
    </div>

    <!-- Advanced Settings (collapsible) -->
    <details class="card mb-4">
      <summary class="summary-plain">
        Advanced Settings
        <span class="muted text-sm summary-hint">(Gateway + Strategy configuration)</span>
      </summary>

      <div class="mt-4">
        <!-- AccountGateway -->
        <div class="card mb-3">
          <h4 class="mb-2">AccountGateway (OMS/EMS)</h4>
          <div class="muted text-sm mb-2">
            Gateway state is persisted under <span class="mono">runs/gateway/account=&lt;profile&gt;/</span>.
          </div>

          <div class="grid3 mb-2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Selected profile</div>
                <div class="metric-value mono" id="gatewayProfile">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Gateway health</div>
                <div class="metric-value mono" id="gatewayHealth">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Last update</div>
                <div class="metric-value mono text-sm" id="gatewayUpdatedAt">--</div>
              </div>
            </div>
          </div>

          <div class="form-actions-right">
            <button type="button" class="btn btn-sm btn-secondary" id="gatewayRefreshBtn">Refresh</button>
          </div>

          <form class="form" id="gatewayDesiredForm">
            <h5 class="mb-2">Desired state</h5>
            <div class="grid3">
              <div>
                <label>Mode</label>
                <select id="gatewayMode">
                  <option value="idle">idle</option>
                  <option value="paper">paper</option>
                  <option value="sim">sim</option>
                  <option value="live_monitor">live_monitor</option>
                  <option value="live_trade">live_trade</option>
                </select>
              </div>
              <div>
                <label>Executor</label>
                <select id="gatewayExecutor">
                  <option value="targetpos" selected>targetpos</option>
                  <option value="direct">direct</option>
                </select>
              </div>
              <div>
                <label>Sim account</label>
                <select id="gatewaySimAccount">
                  <option value="tqsim" selected>tqsim</option>
                  <option value="tqkq">tqkq</option>
                </select>
              </div>
            </div>
            <div class="grid2">
              <div>
                <label>Symbols (comma-separated)</label>
                <input id="gatewaySymbols" placeholder="SHFE.{{ variety }}2602"/>
              </div>
              <div>
                <label>Confirm live (required for live_trade)</label>
                <input id="gatewayConfirmLive" placeholder="I_UNDERSTAND" />
              </div>
            </div>
            <div class="grid3">
              <div><label>Max abs position</label><input id="gatewayMaxAbsPos" type="number" min="0" value="1"/></div>
              <div><label>Max order size</label><input id="gatewayMaxOrderSize" type="number" min="1" value="1"/></div>
              <div><label>Max ops/sec</label><input id="gatewayMaxOpsSec" type="number" min="1" value="10"/></div>
            </div>
            <div class="grid3">
              <div><label>Max daily loss (optional)</label><input id="gatewayMaxDailyLoss" placeholder="(optional)"/></div>
              <div>
                <label>Enforce trading time</label>
                <select id="gatewayEnforceTradingTime">
                  <option value="true" selected>true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Apply desired</button>
              </div>
            </div>
          </form>
        </div>

        <!-- Manual Interventions -->
        <div class="card panel-warning mb-3">
          <h4 class="mb-2">Manual interventions (logged)</h4>
          <div class="muted text-sm mb-2">
            These append commands to <span class="mono">commands.jsonl</span>. Use only when necessary.
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-secondary btn-sm" id="gatewayCmdCancelAll">Cancel all orders</button>
            <button type="button" class="btn btn-secondary btn-sm" id="gatewayCmdFlatten">Flatten positions</button>
            <button type="button" class="btn btn-danger btn-sm" id="gatewayCmdDisarm">Disarm live (switch to live_monitor)</button>
            <button type="button" class="btn btn-warning btn-sm" id="gatewayCmdResetRiskKill">Reset risk-kill</button>
          </div>
        </div>

        <div class="card mb-3">
          <h5 class="mb-2">Gateway Raw Status</h5>
          <pre class="mono text-xs raw-json-sm" id="gatewayRaw">--</pre>
        </div>

        <!-- StrategyRunner -->
        <div class="card mb-3">
          <h4 class="mb-2">StrategyRunner (AI)</h4>
          <div class="muted text-sm mb-2">
            Strategy state is persisted under <span class="mono">runs/strategy/account=&lt;profile&gt;/</span>.
          </div>

          <div class="grid3 mb-2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Selected profile</div>
                <div class="metric-value mono" id="strategyProfile">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Strategy health</div>
                <div class="metric-value mono" id="strategyHealth">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Last update</div>
                <div class="metric-value mono text-sm" id="strategyUpdatedAt">--</div>
              </div>
            </div>
          </div>

          <div class="form-actions-right">
            <button type="button" class="btn btn-sm btn-secondary" id="strategyRefreshBtn">Refresh</button>
          </div>

          <form class="form" id="strategyDesiredForm">
            <h5 class="mb-2">Desired state</h5>
            <div class="grid2">
              <div>
                <label>Mode</label>
                <select id="strategyMode">
                  <option value="idle" selected>idle</option>
                  <option value="run">run</option>
                </select>
              </div>
              <div>
                <label>Symbols (comma-separated)</label>
                <input id="strategySymbols" placeholder="SHFE.{{ variety }}2602"/>
              </div>
            </div>
            <div class="grid3">
              <div><label>Model</label><input id="strategyModelName" value="xgboost"/></div>
              <div><label>Horizon</label><input id="strategyHorizon" value="50"/></div>
              <div><label>Position size</label><input id="strategyPositionSize" value="1"/></div>
            </div>
            <div class="grid2">
              <div><label>Threshold up</label><input id="strategyThresholdUp" value="0.6"/></div>
              <div><label>Threshold down</label><input id="strategyThresholdDown" value="0.6"/></div>
            </div>
            <div class="grid2">
              <div><label>Artifacts dir</label><input id="strategyArtifactsDir" value="artifacts"/></div>
              <div><label>Poll interval (sec)</label><input id="strategyPollIntervalSec" value="0.5"/></div>
            </div>
            <button type="submit" class="btn btn-primary">Apply desired</button>
          </form>

          <div class="mt-3">
            <h5 class="mb-2">Strategy Raw Status</h5>
            <pre class="mono text-xs raw-json-sm" id="strategyRaw">--</pre>
          </div>
        </div>

        <!-- Active Jobs -->
        <div class="card">
          <h4 class="mb-2">Active Jobs (gateway/strategy)</h4>
          <div id="tradingJobsList">
            <div class="muted">Loading...</div>
          </div>
        </div>
      </div>
    </details>
  </div>

  <!-- Tab: Account Config -->
  <div class="tab-content" id="tab-config">
    <div class="card">
      <h3 class="mb-2">Broker Accounts (profiles)</h3>
      <div class="muted text-sm mb-2">
        Credentials are stored in <span class="mono">runs/control/accounts.env</span> (gitignored). 
        Add/edit accounts here; the table only displays non-secret info.
      </div>

      <form class="form mb-3" id="accountUpsertForm">
        <h4 class="mb-2">Add / Edit Account</h4>
        <div class="grid3">
          <div>
            <label>Profile</label>
            <input id="accountFormProfile" placeholder="tg_1" autocomplete="off" />
          </div>
          <div>
            <label>Broker ID</label>
            <input id="accountFormBroker" list="brokerIdList" placeholder="T铜冠金源" autocomplete="off" />
            <datalist id="brokerIdList"></datalist>
          </div>
          <div>
            <label>Account ID</label>
            <input id="accountFormAccountId" autocomplete="off" />
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Password</label>
            <input id="accountFormPassword" type="password" autocomplete="new-password" />
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" id="accountFormClear">Clear</button>
          </div>
        </div>
        <div class="muted text-sm">Tip: profile names are normalized to <span class="mono">[a-z0-9_]</span>. Passwords are never displayed back.</div>
      </form>

      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Profile</th>
              <th>Broker</th>
              <th>Account</th>
              <th>Configured</th>
              <th>Gateway</th>
              <th>Strategy</th>
              <th>Last verify</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="accountsTbody">
            <tr><td colspan="8" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script src="/static/trading.js"></script>
{% endblock %}
