{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Trading Console</h2>
    <div class="section-header-actions">
      <button class="btn btn-sm btn-secondary" id="refreshTrading">Refresh</button>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="card card-compact flex items-center gap-4 flex-wrap" id="tradingStatusBar">
    <div class="status-indicator" id="tradingModeIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Mode: Idle</span>
    </div>
    <div class="status-indicator" id="tradingLiveEnabledIndicator">
      <span class="status-dot status-dot-unknown"></span>
      <span>Live enabled: --</span>
    </div>
    <div class="status-indicator" id="tradingAccountIndicator">
      <span class="status-dot status-dot-idle"></span>
      <span>Account profile:</span>
      <select id="accountProfileSelect">
        <option value="default" selected>default</option>
      </select>
      <span class="muted text-sm" id="accountProfileConfigured">--</span>
    </div>
    <div class="muted text-sm" id="tradingLastUpdate">Last update: --</div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="status">Live Status</button>
    <button class="tab-nav-item" data-tab="start">Start Trading</button>
    <button class="tab-nav-item" data-tab="history">
      Run History
      <span class="badge" id="runCountBadge">--</span>
    </button>
    <button class="tab-nav-item" data-tab="accounts">Accounts</button>
  </div>

  <!-- Tab: Live Status -->
  <div class="tab-content active" id="tab-status">
    <div class="kpi-grid mb-3">
      <div class="kpi-card">
        <div class="kpiLabel">Trading Mode</div>
        <div class="kpiValue" id="kpiMode">Idle</div>
        <div class="kpiSubtext" id="kpiModeDetail">No active run</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Balance</div>
        <div class="kpiValue mono" id="kpiBalance">--</div>
        <div class="kpiSubtext" id="kpiEquity">Equity: --</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Position</div>
        <div class="kpiValue" id="kpiPosition">0</div>
        <div class="kpiSubtext" id="kpiPositionSymbol">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Unrealized P&L</div>
        <div class="kpiValue mono" id="kpiPnL">--</div>
        <div class="kpiSubtext" id="kpiPnLPct">--</div>
      </div>
    </div>

    <div class="split-pane">
      <div>
        <div class="card">
          <h3 class="mb-2">Active Run</h3>
          <div id="activeRunInfo">
            <div class="empty-state" style="padding:30px;">
              <div class="empty-state-title">No Active Trading Run</div>
              <div class="empty-state-text">Start a trading run from the "Start Trading" tab or use the CLI.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Positions</h3>
          <div class="tableWrap">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Direction</th>
                  <th>Volume</th>
                  <th>Avg Price</th>
                  <th>Current</th>
                  <th>P&L</th>
                </tr>
              </thead>
              <tbody id="positionsTbody">
                <tr><td colspan="6" class="muted">No positions</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">Recent Signals</h3>
          <div class="tableWrap" style="max-height:200px; overflow:auto;">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Signal</th>
                  <th>Confidence</th>
                </tr>
              </thead>
              <tbody id="signalsTbody">
                <tr><td colspan="4" class="muted">No signals</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Risk Metrics</h3>
          <div class="grid2">
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Position</div>
                <div class="metric-value" id="riskMaxPos">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Order Size</div>
                <div class="metric-value" id="riskMaxOrder">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Max Ops/Sec</div>
                <div class="metric-value" id="riskMaxOps">--</div>
              </div>
            </div>
            <div class="metric-card">
              <div class="metric-content">
                <div class="metric-label">Daily Loss Limit</div>
                <div class="metric-value" id="riskDailyLoss">--</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Recent Orders</h3>
          <div class="tableWrap" style="max-height:150px; overflow:auto;">
            <table class="table table-compact">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Volume</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="ordersTbody">
                <tr><td colspan="5" class="muted">No orders</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Start Trading -->
  <div class="tab-content" id="tab-start">
    <div class="split-pane-2-1">
      <div class="card">
        <h3 class="mb-2">Start Trading Run</h3>
        
        <div class="alert-banner alert-warn mb-3">
          <div class="alert-banner-icon">!</div>
          <div class="alert-banner-content">
            <div class="alert-banner-title">Trading Risk Warning</div>
            <div>Trading involves significant risk. Start with paper mode before using sim or live. Always use monitor-only mode first when testing real accounts.</div>
          </div>
        </div>
        
        <form class="form" id="tradeStartForm" method="post" action="/ops/trading/trade{{ token_qs }}">
          <h4>Mode & Execution</h4>
          <div class="grid3">
            <div>
              <label>Mode</label>
              <select name="mode" id="tradeModeSelect">
                <option value="paper" selected>paper (no orders)</option>
                <option value="sim">sim (simulated)</option>
                <option value="live">live (real broker)</option>
              </select>
            </div>
            <div>
              <label>Sim account</label>
              <select name="sim_account">
                <option value="tqsim" selected>tqsim (local)</option>
                <option value="tqkq">tqkq (remote)</option>
              </select>
            </div>
            <div>
              <label>Executor</label>
              <select name="executor">
                <option value="targetpos" selected>targetpos (TargetPosTask)</option>
                <option value="direct">direct (insert_order)</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label>Account profile (live)</label>
            <select name="account_profile" id="tradeAccountProfileSelect">
              <option value="default" selected>default</option>
            </select>
            <div class="muted text-sm" style="margin-top:6px;">Broker credentials are stored in <span class="mono">runs/control/accounts.env</span> (gitignored) and loaded after <span class="mono">.env</span>. This is used only for <span class="mono">mode=live</span>.</div>
          </div>

          <div class="card" style="margin:12px 0; background: var(--warn-bg); border-color: var(--warn-border);">
            <label style="margin:0; display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="monitorOnlyCheck" name="monitor_only" checked/>
              <span class="font-bold">Monitor-only mode (no orders)</span>
            </label>
            <div class="muted text-sm" style="margin-top:6px;">Recommended for first real-account testing. Connects and logs but never sends orders.</div>
          </div>

          <h4>Model & Symbols</h4>
          <div class="grid3">
            <div><label>Model</label><input name="model" value="xgboost"/></div>
            <div><label>Horizon</label><input name="horizon" value="50"/></div>
            <div><label>Position size</label><input name="position_size" value="1"/></div>
          </div>
          <div class="grid2">
            <div><label>Threshold up</label><input name="threshold_up" value="0.6"/></div>
            <div><label>Threshold down</label><input name="threshold_down" value="0.6"/></div>
          </div>
          <div><label>Symbols (comma-separated)</label><input name="symbols" placeholder="KQ.m@SHFE.cu"/></div>

          <h4>Risk Controls</h4>
          <div class="grid3">
            <div><label>Max position</label><input name="max_position" value="1"/></div>
            <div><label>Max order size</label><input name="max_order_size" value="1"/></div>
            <div><label>Max ops/sec</label><input name="max_ops_per_sec" value="10"/></div>
          </div>
          <div class="grid3">
            <div><label>Max daily loss</label><input name="max_daily_loss" placeholder="(optional)"/></div>
            <div>
              <label>Enforce trading time</label>
              <select name="enforce_trading_time"><option value="true" selected>true</option><option value="false">false</option></select>
            </div>
            <div><label>Snapshot interval (sec)</label><input name="snapshot_interval_sec" value="10"/></div>
          </div>

          <h4>Execution Settings</h4>
          <div class="grid2">
            <div>
              <label>TP price mode</label>
              <select name="tp_price"><option value="ACTIVE" selected>ACTIVE</option><option value="PASSIVE">PASSIVE</option></select>
            </div>
            <div><label>TP offset priority</label><input name="tp_offset_priority" value="今昨,开"/></div>
          </div>
          <div class="grid2">
            <div>
              <label>Direct price mode</label>
              <select name="direct_price_mode"><option value="ACTIVE" selected>ACTIVE</option><option value="PASSIVE">PASSIVE</option></select>
            </div>
            <div>
              <label>Direct advanced</label>
              <select name="direct_advanced"><option value="" selected>(none)</option><option value="FAK">FAK</option><option value="FOK">FOK</option></select>
            </div>
          </div>

          <h4>Paths</h4>
          <div class="grid3">
            <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            <div><label>Artifacts dir</label><input name="artifacts_dir" value="artifacts"/></div>
            <div><label>Runs dir</label><input name="runs_dir" value="runs"/></div>
          </div>

          <div id="confirmLiveSection" style="display:none; margin-top:12px;">
            <div class="alert-banner alert-error">
              <div class="alert-banner-content">
                <div class="alert-banner-title">Live Trading Confirmation Required</div>
                <div>Type "I_UNDERSTAND" below to enable live order execution.</div>
              </div>
            </div>
            <div class="alert-banner alert-warn" id="liveEnabledDisabledBanner" style="display:none;">
              <div class="alert-banner-content">
                <div class="alert-banner-title">Live order execution is disabled</div>
                <div>Set <span class="mono">GHTRADER_LIVE_ENABLED=true</span> to allow sending orders. Monitor-only is still allowed.</div>
              </div>
            </div>
            <label>Confirm live</label>
            <input name="confirm_live" placeholder="I_UNDERSTAND"/>
          </div>

          <button type="submit" id="tradeStartSubmit" style="margin-top:16px;">Start Trading</button>
        </form>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">Quick Start Presets</h3>
          <div class="grid2">
            <button class="btn btn-secondary btn-sm" id="presetPaper">Paper (cu)</button>
            <button class="btn btn-secondary btn-sm" id="presetSimCu">Sim (cu)</button>
          </div>
          <div class="muted text-sm" style="margin-top:8px;">Click to fill form with preset values.</div>
        </div>

        <div class="card">
          <h3 class="mb-2">Trading Mode Guide</h3>
          <div class="mb-2">
            <span class="pill pill-succeeded">paper</span>
            <div class="muted text-sm">No orders sent. Computes signals and logs only. Safe for testing model behavior.</div>
          </div>
          <div class="mb-2">
            <span class="pill pill-running">sim</span>
            <div class="muted text-sm">Orders sent to simulated account (TqSim or TqKq). No real money at risk.</div>
          </div>
          <div class="mb-2">
            <span class="pill pill-failed">live</span>
            <div class="muted text-sm">Real broker account. Requires GHTRADER_LIVE_ENABLED=true and confirmation. Use monitor-only first.</div>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Active Trading Jobs</h3>
          <div id="tradingJobsList">
            <div class="muted">Loading...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Run History -->
  <div class="tab-content" id="tab-history">
    <div class="card">
      <h3 class="mb-2">Trading Run History</h3>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Account</th>
              <th>Last Timestamp</th>
              <th>Balance</th>
              <th>Mode</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="runHistoryTbody">
            {% if runs and runs|length > 0 %}
              {% for r in runs %}
              <tr>
                <td class="mono">{{ r.run_id }}</td>
                <td class="mono">{{ r.account_profile|default("default") }}</td>
                <td class="mono text-xs">{{ r.last_ts }}</td>
                <td class="mono">{{ r.balance }}</td>
                <td>
                  {% if r.mode %}
                    {{ r.mode }}{% if r.monitor_only %} <span class="pill">monitor</span>{% endif %}
                  {% else %}
                    --
                  {% endif %}
                </td>
                <td><a href="/ops/trading/run/{{ r.run_id }}{{ token_qs }}">View</a></td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="6" class="muted">No trading runs found</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Accounts -->
  <div class="tab-content" id="tab-accounts">
    <div class="card">
      <h3 class="mb-2">Broker Accounts (profiles)</h3>
      <div class="muted text-sm mb-2">Credentials are stored in <span class="mono">runs/control/accounts.env</span> (gitignored). Add/edit accounts here; the table only displays non-secret info.</div>

      <form class="form" id="accountUpsertForm" style="margin-bottom:12px;">
        <h4 class="mb-2">Add / Edit Account</h4>
        <div class="grid3">
          <div>
            <label>Profile</label>
            <input id="accountFormProfile" placeholder="tg_1" autocomplete="off" />
          </div>
          <div>
            <label>Broker ID</label>
            <input id="accountFormBroker" list="brokerIdList" placeholder="T铜冠金源" autocomplete="off" />
            <datalist id="brokerIdList"></datalist>
          </div>
          <div>
            <label>Account ID</label>
            <input id="accountFormAccountId" autocomplete="off" />
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Password</label>
            <input id="accountFormPassword" type="password" autocomplete="new-password" />
          </div>
          <div style="display:flex; gap:8px; align-items:flex-end;">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" id="accountFormClear">Clear</button>
          </div>
        </div>
        <div class="muted text-sm">Tip: profile names are normalized to <span class="mono">[a-z0-9_]</span>. Passwords are never displayed back.</div>
      </form>

      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr>
              <th>Profile</th>
              <th>Broker</th>
              <th>Account</th>
              <th>Configured</th>
              <th>Active</th>
              <th>Last snapshot</th>
              <th>Latest run</th>
              <th>Last verify</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="accountsTbody">
            <tr><td colspan="9" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  const tabs = window.ghTrader.initTabs({ updateHash: true });
  const tokenQs = "{{ token_qs }}";

  // Mode/monitor-only logic
  const modeSelect = document.getElementById("tradeModeSelect");
  const monitorCheck = document.getElementById("monitorOnlyCheck");
  const confirmSection = document.getElementById("confirmLiveSection");
  const liveEnabledBanner = document.getElementById("liveEnabledDisabledBanner");
  const submitBtn = document.getElementById("tradeStartSubmit");
  let liveEnabled = null;

  // Account profiles
  let accountsByProfile = {};
  let selectedAccountProfile = (localStorage.getItem("ghtrader_account_profile") || "default");
  const accountProfileSelect = document.getElementById("accountProfileSelect");
  const tradeAccountProfileSelect = document.getElementById("tradeAccountProfileSelect");

  const accountUpsertForm = document.getElementById("accountUpsertForm");
  const accountFormProfile = document.getElementById("accountFormProfile");
  const accountFormBroker = document.getElementById("accountFormBroker");
  const accountFormAccountId = document.getElementById("accountFormAccountId");
  const accountFormPassword = document.getElementById("accountFormPassword");
  const accountFormClear = document.getElementById("accountFormClear");
  const brokerIdList = document.getElementById("brokerIdList");

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function updateModeUI() {
    const mode = modeSelect.value;
    const monitor = monitorCheck.checked;
    
    // Show confirm section only for live + not monitor-only
    confirmSection.style.display = (mode === "live" && !monitor) ? "block" : "none";
    if (liveEnabledBanner) {
      liveEnabledBanner.style.display = (mode === "live" && !monitor && liveEnabled === false) ? "flex" : "none";
    }
    if (submitBtn) {
      submitBtn.disabled = (mode === "live" && !monitor && liveEnabled === false);
    }
    
    // Force monitor-only for live mode initial selection
    if (mode === "live" && !monitor) {
      // User explicitly unchecked, that's okay
    }
  }

  function setSelectedAccountProfile(p) {
    selectedAccountProfile = String(p || "default").trim() || "default";
    try { localStorage.setItem("ghtrader_account_profile", selectedAccountProfile); } catch (e) {}
    if (accountProfileSelect) accountProfileSelect.value = selectedAccountProfile;
    if (tradeAccountProfileSelect) tradeAccountProfileSelect.value = selectedAccountProfile;
  }

  function updateAccountProfileStatus() {
    const row = accountsByProfile[selectedAccountProfile];
    const cfg = row ? (row.configured === true) : null;
    const el = document.getElementById("accountProfileConfigured");
    if (el) {
      if (cfg === null) el.textContent = "--";
      else el.textContent = cfg ? "configured" : "missing creds";
    }
    const acctEl = document.getElementById("tradingAccountIndicator");
    if (acctEl) {
      const dot = acctEl.querySelector(".status-dot");
      if (dot) {
        dot.className = "status-dot " + (cfg === false ? "status-dot-error" : (cfg === true ? "status-dot-ok" : "status-dot-unknown"));
      }
    }
  }

  if (accountProfileSelect) {
    accountProfileSelect.addEventListener("change", () => {
      setSelectedAccountProfile(accountProfileSelect.value);
      updateAccountProfileStatus();
      loadTradingStatus();
    });
  }
  if (tradeAccountProfileSelect) {
    tradeAccountProfileSelect.addEventListener("change", () => {
      setSelectedAccountProfile(tradeAccountProfileSelect.value);
      updateAccountProfileStatus();
    });
  }

  modeSelect.addEventListener("change", updateModeUI);
  monitorCheck.addEventListener("change", updateModeUI);
  updateModeUI();

  // Presets
  document.getElementById("presetPaper").addEventListener("click", () => {
    modeSelect.value = "paper";
    monitorCheck.checked = true;
    document.querySelector('input[name="symbols"]').value = "KQ.m@SHFE.cu";
    document.querySelector('input[name="model"]').value = "xgboost";
    updateModeUI();
    window.ghTrader.toast("Paper preset loaded", "info");
  });

  document.getElementById("presetSimCu").addEventListener("click", () => {
    modeSelect.value = "sim";
    monitorCheck.checked = false;
    document.querySelector('input[name="symbols"]').value = "KQ.m@SHFE.cu";
    document.querySelector('input[name="model"]').value = "xgboost";
    updateModeUI();
    window.ghTrader.toast("Sim preset loaded", "info");
  });

  // Load trading status
  async function loadTradingStatus() {
    try {
      const u = "/api/trading/status?account_profile=" + encodeURIComponent(selectedAccountProfile);
      const resp = await window.ghTrader.fetchApi(u);
      if (!resp.ok) return;
      const data = await resp.json();
      if (data && data.ok === false) return;

      if (data && data.account_profile) {
        setSelectedAccountProfile(data.account_profile);
      }
      updateAccountProfileStatus();

      liveEnabled = (data.live_enabled === true);
      updateModeUI();

      // Live enabled indicator
      const liveEl = document.getElementById("tradingLiveEnabledIndicator");
      if (liveEl) {
        const dot = liveEl.querySelector(".status-dot");
        const txt = liveEl.querySelector("span:last-child");
        if (txt) txt.textContent = "Live enabled: " + (liveEnabled ? "true" : "false");
        if (dot) dot.className = "status-dot " + (liveEnabled ? "status-dot-ok" : "status-dot-warn");
      }
      
      // Update status bar
      const modeIndicator = document.getElementById("tradingModeIndicator");
      const mode = data.mode || "idle";
      modeIndicator.querySelector("span:last-child").textContent = "Mode: " + mode;
      modeIndicator.querySelector(".status-dot").className = "status-dot " + (
        mode === "live" ? "status-dot-error" :
        mode === "sim" ? "status-dot-warn" :
        mode === "paper" ? "status-dot-ok" : "status-dot-idle"
      );
      
      document.getElementById("kpiMode").textContent = mode;
      document.getElementById("kpiModeDetail").textContent = data.run_id ? "Run: " + data.run_id.substring(0, 8) : "No active run";
      
      if (data.account) {
        document.getElementById("kpiBalance").textContent = formatNumber(data.account.balance);
        document.getElementById("kpiEquity").textContent = "Equity: " + formatNumber(data.account.equity);
      }
      
      if (data.position) {
        document.getElementById("kpiPosition").textContent = data.position.volume || 0;
        document.getElementById("kpiPositionSymbol").textContent = data.position.symbol || "--";
      }
      
      if (data.pnl !== undefined) {
        document.getElementById("kpiPnL").textContent = formatNumber(data.pnl);
        try {
          const bal = data.account && data.account.balance !== undefined ? Number(data.account.balance) : null;
          const pnl = Number(data.pnl);
          const pct = (bal && Number.isFinite(bal) && bal !== 0 && Number.isFinite(pnl)) ? (pnl / bal) * 100 : null;
          document.getElementById("kpiPnLPct").textContent = (pct === null) ? "--" : (pct.toFixed(2) + "%");
        } catch (e) {
          document.getElementById("kpiPnLPct").textContent = "--";
        }
      }
      
      // Update last update time
      document.getElementById("tradingLastUpdate").textContent = "Last update: " + new Date().toLocaleTimeString();
      
      // Update active run info
      if (data.run_id) {
        document.getElementById("activeRunInfo").innerHTML = [
          '<div class="metric-card mb-2">',
          '<div class="metric-content">',
          '<div class="metric-label">Run ID</div>',
          '<div class="metric-value mono">' + data.run_id + '</div>',
          '</div>',
          '</div>',
          '<div class="grid2">',
          '<div class="text-sm"><span class="muted">Mode:</span> ' + (data.mode || "--") + '</div>',
          '<div class="text-sm"><span class="muted">Account:</span> ' + (data.account_profile || selectedAccountProfile || "--") + '</div>',
          '<div class="text-sm"><span class="muted">Executor:</span> ' + (data.executor || "--") + '</div>',
          '<div class="text-sm"><span class="muted">Model:</span> ' + (data.model || "--") + '</div>',
          '<div class="text-sm"><span class="muted">Symbols:</span> ' + ((data.symbols || []).join(", ") || "--") + '</div>',
          '</div>',
          '<a href="/ops/trading/run/' + data.run_id + '{{ token_qs }}" class="btn btn-sm btn-secondary" style="margin-top:12px;">View Details</a>',
        ].join("");
      } else {
        document.getElementById("activeRunInfo").innerHTML = [
          '<div class="empty-state" style="padding:30px;">',
          '<div class="empty-state-title">No Active Trading Run</div>',
          '<div class="empty-state-text">Start a trading run from the "Start Trading" tab or use the CLI.</div>',
          '</div>',
        ].join("");
      }

      // Positions table (best-effort; pricing fields may be unavailable)
      const posTbody = document.getElementById("positionsTbody");
      if (posTbody) {
        const pos = data.positions || null;
        const keys = pos && typeof pos === "object" ? Object.keys(pos) : [];
        const rows = [];
        if (keys.length > 0) {
          keys.forEach((sym) => {
            const p = pos[sym] || {};
            if (p.error) return;
            const vlong = Number(p.volume_long || 0);
            const vshort = Number(p.volume_short || 0);
            const net = vlong - vshort;
            const dir = net > 0 ? "long" : (net < 0 ? "short" : "flat");
            const pnl = Number(p.float_profit_long || 0) + Number(p.float_profit_short || 0);
            rows.push([
              '<tr>',
              '<td class="mono text-xs">' + sym + '</td>',
              '<td>' + dir + '</td>',
              '<td class="mono">' + net + '</td>',
              '<td class="muted">--</td>',
              '<td class="muted">--</td>',
              '<td class="mono">' + formatNumber(pnl) + '</td>',
              '</tr>',
            ].join(""));
          });
        }
        posTbody.innerHTML = rows.length ? rows.join("") : '<tr><td colspan="6" class="muted">No positions</td></tr>';
      }
      
      // Risk metrics
      if (data.risk) {
        document.getElementById("riskMaxPos").textContent = data.risk.max_position || "--";
        document.getElementById("riskMaxOrder").textContent = data.risk.max_order_size || "--";
        document.getElementById("riskMaxOps").textContent = data.risk.max_ops_per_sec || "--";
        document.getElementById("riskDailyLoss").textContent = data.risk.max_daily_loss || "--";
      }

      // Recent signals + orders from recent_events (best-effort)
      const events = Array.isArray(data.recent_events) ? data.recent_events : [];

      // Signals table
      const sigTbody = document.getElementById("signalsTbody");
      if (sigTbody) {
        const sigRows = [];
        const sigEvents = events.filter(e => e && (e.type === "target_change" || e.type === "signals_disabled")).slice(-50).reverse();
        for (const e of sigEvents) {
          const ts = e.ts || "";
          const sym = e.symbol || "--";
          let sig = "--";
          let conf = "--";
          if (e.type === "signals_disabled") {
            sig = "disabled";
            conf = String(e.reason || "");
          } else {
            const t = Number(e.new);
            sig = (t > 0) ? ("LONG " + t) : (t < 0 ? ("SHORT " + Math.abs(t)) : "FLAT");
            if (Array.isArray(e.probs) && e.probs.length === 3) {
              try { conf = Math.max(Number(e.probs[0]), Number(e.probs[1]), Number(e.probs[2])).toFixed(2); } catch (_) {}
            }
          }
          sigRows.push([
            "<tr>",
            '<td class="mono text-xs">', fmtTs(ts), "</td>",
            '<td class="mono text-xs">', String(sym), "</td>",
            "<td>", String(sig), "</td>",
            '<td class="mono">', String(conf), "</td>",
            "</tr>",
          ].join(""));
        }
        sigTbody.innerHTML = sigRows.length ? sigRows.join("") : '<tr><td colspan="4" class="muted">No signals</td></tr>';
      }

      // Orders table
      const ordTbody = document.getElementById("ordersTbody");
      if (ordTbody) {
        const ordRows = [];
        const ordEvents = events.filter(e => e && ["order_new", "order_update", "order_done", "trade_fill"].includes(e.type)).slice(-50).reverse();
        for (const e of ordEvents) {
          const ts = e.ts || "";
          const sym = e.symbol || (e.new && e.new.symbol) || (e.old && e.old.symbol) || "--";
          const side = e.direction || (e.new && e.new.direction) || (e.old && e.old.direction) || "--";
          let vol = "--";
          if (e.type === "trade_fill") vol = String(e.volume ?? "--");
          else if (e.type === "order_new") vol = String(e.volume_orign ?? e.volume_left ?? "--");
          else if (e.type === "order_done") vol = String(e.volume_orign ?? "--");
          else if (e.type === "order_update") vol = String((e.new && e.new.volume_left) ?? "--");
          const status = e.type;
          ordRows.push([
            "<tr>",
            '<td class="mono text-xs">', fmtTs(ts), "</td>",
            '<td class="mono text-xs">', String(sym), "</td>",
            "<td>", String(side), "</td>",
            '<td class="mono">', String(vol), "</td>",
            '<td class="mono text-xs">', String(status), "</td>",
            "</tr>",
          ].join(""));
        }
        // Fallback: if no events, show current alive orders if present.
        if (!ordRows.length && Array.isArray(data.orders_alive)) {
          for (const o of data.orders_alive.slice(0, 20)) {
            ordRows.push([
              "<tr>",
              '<td class="mono text-xs">', "--", "</td>",
              '<td class="mono text-xs">', String(o.symbol || "--"), "</td>",
              "<td>", String(o.direction || "--"), "</td>",
              '<td class="mono">', String(o.volume_left ?? o.volume_orign ?? "--"), "</td>",
              '<td class="mono text-xs">ALIVE</td>',
              "</tr>",
            ].join(""));
          }
        }
        ordTbody.innerHTML = ordRows.length ? ordRows.join("") : '<tr><td colspan="5" class="muted">No orders</td></tr>';
      }
      
    } catch (e) {
      // API may not exist yet
    }
  }

  async function loadRunHistory() {
    try {
      const resp = await window.ghTrader.fetchApi("/api/trading/runs?limit=50");
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data || data.ok === false) return;
      const runs = Array.isArray(data.runs) ? data.runs : [];
      const tbody = document.getElementById("runHistoryTbody");
      const badge = document.getElementById("runCountBadge");
      if (badge) badge.textContent = runs.length ? runs.length : "--";
      if (!tbody) return;
      if (!runs.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No trading runs found</td></tr>';
        return;
      }
      tbody.innerHTML = runs.map((r) => {
        const rid = String(r.run_id || "");
        const ap = String(r.account_profile || "default");
        const mode = String(r.mode || "--");
        const mon = (r.monitor_only === true) ? " (monitor)" : "";
        return [
          "<tr>",
          '<td class="mono">', rid, "</td>",
          '<td class="mono">', ap, "</td>",
          '<td class="mono text-xs">', fmtTs(r.last_ts || ""), "</td>",
          '<td class="mono">', formatNumber(r.balance), "</td>",
          "<td>", mode + mon, "</td>",
          '<td><a href="/ops/trading/run/', encodeURIComponent(rid), tokenQs, '">View</a></td>',
          "</tr>",
        ].join("");
      }).join("");
    } catch (e) {
      // ignore
    }
  }

  async function loadBrokers() {
    if (!brokerIdList) return;
    try {
      const resp = await window.ghTrader.fetchApi("/api/brokers");
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data || data.ok === false) return;
      const brokers = Array.isArray(data.brokers) ? data.brokers : [];
      brokerIdList.innerHTML = brokers.map((b) => '<option value="' + esc(b) + '"></option>').join("");
    } catch (e) {
      // ignore
    }
  }

  async function loadAccounts() {
    try {
      const resp = await window.ghTrader.fetchApi("/api/accounts");
      if (!resp.ok) return;
      const data = await resp.json();
      if (!data || data.ok === false) return;

      const rows = Array.isArray(data.profiles) ? data.profiles : [];
      accountsByProfile = {};
      const profiles = [];
      for (const r of rows) {
        if (!r || !r.profile) continue;
        const p = String(r.profile);
        profiles.push(p);
        accountsByProfile[p] = r;
      }

      if (profiles.length && profiles.indexOf(selectedAccountProfile) === -1) {
        setSelectedAccountProfile(profiles[0]);
      } else {
        setSelectedAccountProfile(selectedAccountProfile);
      }

      function profileLabel(p) {
        const r = accountsByProfile[p] || {};
        const parts = [String(p)];
        if (r.broker_id) parts.push(String(r.broker_id));
        if (r.account_id_masked) parts.push(String(r.account_id_masked));
        return parts.join(" — ");
      }

      if (accountProfileSelect) {
        accountProfileSelect.innerHTML = profiles.map((p) => '<option value=\"' + esc(p) + '\">' + esc(profileLabel(p)) + "</option>").join("");
        accountProfileSelect.value = selectedAccountProfile;
      }
      if (tradeAccountProfileSelect) {
        tradeAccountProfileSelect.innerHTML = profiles.map((p) => '<option value=\"' + esc(p) + '\">' + esc(profileLabel(p)) + "</option>").join("");
        tradeAccountProfileSelect.value = selectedAccountProfile;
      }
      updateAccountProfileStatus();

      const tbody = document.getElementById("accountsTbody");
      if (!tbody) return;
      if (!profiles.length) {
        tbody.innerHTML = '<tr><td colspan=\"9\" class=\"muted\">No profiles found</td></tr>';
        return;
      }

      tbody.innerHTML = profiles.map((p) => {
        const r = accountsByProfile[p] || {};
        const cfg = (r.configured === true);
        const brokerId = r.broker_id ? String(r.broker_id) : "--";
        const accMasked = r.account_id_masked ? String(r.account_id_masked) : "--";
        const activeRun = r.active_run || null;
        const latestRun = r.latest_run || null;
        const lastTs = (activeRun && activeRun.last_ts) ? activeRun.last_ts : (latestRun ? latestRun.last_ts : "");
        const latestRunId = latestRun && latestRun.run_id ? String(latestRun.run_id) : "";
        const verifyAt = r.verify && r.verify.verified_at ? String(r.verify.verified_at) : "";
        const verifyOk = (r.verify && r.verify.ok === true);
        const verifyErr = (r.verify && r.verify.error) ? String(r.verify.error) : "";
        const verifyPill = verifyAt ? (verifyOk ? '<span class="pill pill-succeeded" title="verified">ok</span>' : (verifyErr ? ('<span class="pill pill-failed" title="' + esc(verifyErr) + '">error</span>') : '<span class="pill">--</span>')) : '<span class="pill">--</span>';

        const latestLink = latestRunId ? ('<a href=\"/ops/trading/run/' + encodeURIComponent(latestRunId) + tokenQs + '\">' + latestRunId + '</a>') : "--";
        const activePill = activeRun && activeRun.run_id ? '<span class=\"pill pill-running\">active</span>' : '<span class=\"pill\">--</span>';

        return [
          "<tr>",
          '<td class=\"mono\">', esc(p), "</td>",
          '<td class=\"mono\">', esc(brokerId), "</td>",
          '<td class=\"mono\">', esc(accMasked), "</td>",
          "<td>", (cfg ? '<span class=\"pill pill-succeeded\">yes</span>' : '<span class=\"pill pill-failed\">no</span>'), "</td>",
          "<td>", activePill, "</td>",
          '<td class=\"mono text-xs\">', fmtTs(lastTs), "</td>",
          "<td>", latestLink, "</td>",
          '<td class=\"mono text-xs\">', (verifyAt ? fmtTs(verifyAt) : "--"), " ", verifyPill, "</td>",
          '<td style=\"white-space:nowrap;\">',
          '<button type=\"button\" class=\"btn btn-sm btn-secondary\" data-action=\"select-account\" data-profile=\"', esc(p), '\">Select</button> ',
          '<button type=\"button\" class=\"btn btn-sm btn-secondary\" data-action=\"verify-account\" data-profile=\"', esc(p), '\">Verify</button> ',
          '<button type=\"button\" class=\"btn btn-sm btn-danger\" data-action=\"remove-account\" data-profile=\"', esc(p), '\">Remove</button>',
          "</td>",
          "</tr>",
        ].join("");
      }).join("");
    } catch (e) {
      // ignore
    }
  }

  // Accounts table actions
  const accountsTbody = document.getElementById("accountsTbody");
  if (accountsTbody) {
    accountsTbody.addEventListener("click", async (ev) => {
      const t = ev.target;
      if (!t || !t.dataset) return;
      const action = String(t.dataset.action || "");
      const prof = String(t.dataset.profile || "");
      if (!action || !prof) return;

      if (action === "select-account") {
        setSelectedAccountProfile(prof);
        updateAccountProfileStatus();
        tabs.activate("status");
        loadTradingStatus();
        return;
      }

      if (action === "verify-account") {
        try {
          const out = await window.ghTrader.postJson("/api/accounts/enqueue-verify", { account_profile: prof });
          const jobId = (out.enqueued && out.enqueued[0]) ? out.enqueued[0] : "";
          window.ghTrader.toast(jobId ? ("Enqueued verify job: " + jobId) : "Enqueued verify job", "success");
          loadTradingJobs();
        } catch (e) {
          window.ghTrader.toast("Failed to enqueue verify: " + (e.message || e), "error");
        }
        return;
      }

      if (action === "remove-account") {
        if (!confirm("Remove account profile '" + prof + "'? This deletes it from runs/control/accounts.env.")) return;
        try {
          await window.ghTrader.postJson("/api/accounts/delete", { profile: prof });
          window.ghTrader.toast("Removed: " + prof, "success");
          if (selectedAccountProfile === prof) setSelectedAccountProfile("default");
          loadAccounts();
        } catch (e) {
          window.ghTrader.toast("Failed to remove: " + (e.message || e), "error");
        }
        return;
      }
    });
  }

  function clearAccountForm() {
    if (accountFormProfile) accountFormProfile.value = "";
    if (accountFormBroker) accountFormBroker.value = "";
    if (accountFormAccountId) accountFormAccountId.value = "";
    if (accountFormPassword) accountFormPassword.value = "";
  }

  if (accountFormClear) {
    accountFormClear.addEventListener("click", () => {
      clearAccountForm();
    });
  }

  if (accountUpsertForm) {
    accountUpsertForm.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const profile = accountFormProfile ? String(accountFormProfile.value || "").trim() : "";
      const brokerId = accountFormBroker ? String(accountFormBroker.value || "").trim() : "";
      const accountId = accountFormAccountId ? String(accountFormAccountId.value || "").trim() : "";
      const password = accountFormPassword ? String(accountFormPassword.value || "").trim() : "";

      if (!profile) {
        window.ghTrader.toast("Profile is required", "error");
        return;
      }
      if (!brokerId || !accountId || !password) {
        window.ghTrader.toast("Broker ID, account ID, and password are required", "error");
        return;
      }

      try {
        await window.ghTrader.postJson("/api/accounts/upsert", {
          profile: profile,
          broker_id: brokerId,
          account_id: accountId,
          password: password
        });
        window.ghTrader.toast("Saved: " + profile, "success");
        if (accountFormPassword) accountFormPassword.value = "";
        loadAccounts();
      } catch (e) {
        window.ghTrader.toast("Failed to save: " + (e.message || e), "error");
      }
    });
  }

  async function loadTradingJobs() {
    try {
      const resp = await window.ghTrader.fetchApi("/api/jobs?limit=50");
      if (!resp.ok) return;
      const data = await resp.json();
      const jobs = (data.jobs || []).filter(j => 
        j.status === "running" && 
        (j.title || "").toLowerCase().includes("trade")
      );
      
      const container = document.getElementById("tradingJobsList");
      if (jobs.length === 0) {
        container.innerHTML = '<div class="muted">No trading jobs running</div>';
        return;
      }
      
      container.innerHTML = jobs.map(j => [
        '<div class="metric-card" style="margin-bottom:8px;">',
        '<div class="metric-content">',
        '<div class="metric-label truncate" style="max-width:150px;">' + j.title + '</div>',
        '<div class="metric-value text-sm"><span class="pill pill-running">running</span></div>',
        '</div>',
        '<div style="display:flex; gap:6px;">',
          '<a href="/jobs/' + j.id + '{{ token_qs }}" class="btn-sm btn-secondary">View</a>',
          '<button type="button" class="btn-sm btn-secondary" data-action="cancel-job" data-job-id="' + j.id + '">Stop</button>',
        '</div>',
        '</div>'
      ].join("")).join("");
    } catch (e) {
      // Ignore
    }
  }

  // Stop trading jobs
  document.getElementById("tradingJobsList").addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!t || !t.dataset || t.dataset.action !== "cancel-job") return;
    const jobId = t.dataset.jobId;
    if (!jobId) return;
    try {
      await window.ghTrader.postJson("/api/jobs/" + jobId + "/cancel", {});
      window.ghTrader.toast("Stop signal sent", "success");
      loadTradingJobs();
    } catch (e) {
      window.ghTrader.toast("Failed to stop: " + (e.message || e), "error");
    }
  });

  function formatNumber(n) {
    if (n === null || n === undefined) return "--";
    return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function fmtTs(ts) {
    if (!ts) return "--";
    try { return new Date(ts).toLocaleString(); } catch (e) { return String(ts); }
  }

  document.getElementById("refreshTrading").addEventListener("click", () => {
    loadBrokers();
    loadAccounts();
    loadTradingStatus();
    loadTradingJobs();
    loadRunHistory();
    window.ghTrader.toast("Trading status refreshed", "info");
  });

  // Initial load
  loadBrokers();
  loadAccounts();
  loadTradingStatus();
  loadTradingJobs();
  loadRunHistory();
  
  // Auto-refresh
  setInterval(loadTradingStatus, 10000);
  setInterval(loadTradingJobs, 15000);
  setInterval(loadRunHistory, 30000);
  setInterval(loadAccounts, 30000);
})();
</script>
{% endblock %}
