{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Data Hub</h2>
    <div class="section-header-actions">
      <span class="pill">lake_v2</span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="contracts">
      Contracts
      <span class="badge" id="contractsBadge">--</span>
    </button>
    <button class="tab-nav-item" data-tab="sync">DB Sync</button>
  </div>

  <!-- Tab: Contracts -->
  <div class="tab-content active" id="tab-contracts">
    <div class="card">
      <div class="section-header mb-2">
        <h3 class="mb-0">Contract Explorer</h3>
        <div class="muted text-sm">TqSdk catalog + local coverage + QuestDB status</div>
      </div>

      <div class="alert-banner alert-warn mb-3" id="contractsQuestdbBanner" style="display:none;">
        <div class="alert-banner-icon">!</div>
        <div class="alert-banner-content">
          <div class="alert-banner-title">QuestDB unreachable</div>
          <div class="muted text-sm" id="contractsQuestdbBannerText">--</div>
          <div class="muted text-sm">DB-dependent actions are disabled until QuestDB is reachable.</div>
        </div>
      </div>

      <div class="card" style="margin-bottom:12px;">
        <div class="section-header mb-2" style="margin-bottom:8px;">
          <h4 class="mb-0">Overview (coverage)</h4>
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-sm btn-secondary" id="coverageToggleBtn">Show</button>
            <button type="button" class="btn btn-sm btn-secondary" id="coverageRefreshBtn" style="display:none;">Refresh</button>
          </div>
        </div>
        <div id="coveragePanel" style="display:none;">
          <div class="kpi-grid mb-3">
            <div class="kpi-card">
              <div class="kpiLabel">Raw Tick Symbols</div>
              <div class="kpiValue" id="covTicksCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covTicksRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">main_l5 Symbols</div>
              <div class="kpiValue" id="covMainL5Count">--</div>
              <div class="kpiSubtext mono text-xs" id="covMainL5Range">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Features Built</div>
              <div class="kpiValue" id="covFeaturesCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covFeaturesRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Labels Built</div>
              <div class="kpiValue" id="covLabelsCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covLabelsRange">--</div>
            </div>
          </div>

          <div class="split-pane">
            <div class="card">
              <h4 class="mb-2">Raw ticks (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covTicksTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <h4 class="mb-2">main_l5 (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covMainL5Tbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="split-pane">
            <div class="card">
              <h4 class="mb-2">Features (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covFeaturesTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <h4 class="mb-2">Labels (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covLabelsTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid2 mb-3">
        <div>
          <label class="text-sm">Exchange</label>
          <select id="contractsExchange" class="form-control">
            <option value="SHFE" selected>SHFE</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Variety</label>
          <select id="contractsVar" class="form-control">
            <option value="cu" selected>cu (Copper)</option>
            <option value="au">au (Gold)</option>
            <option value="ag">ag (Silver)</option>
          </select>
        </div>
      </div>

      <div class="grid3 mb-3">
        <div>
          <label class="text-sm">Search</label>
          <input id="contractsSearch" placeholder="e.g. cu1601, 2602" />
        </div>
        <div>
          <label class="text-sm">Filter</label>
          <select id="contractsActiveFilter" class="form-control">
            <option value="all" selected>all contracts</option>
            <option value="active">active only</option>
            <option value="expired">expired only</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <label style="margin:0; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="contractsOnlyMissing" />
            <span class="text-sm">missing/stale only</span>
          </label>
        </div>
      </div>

      <div class="action-bar card-no-margin" style="margin-bottom:12px;">
        <span class="action-bar-title" id="contractsStatus">Click Refresh to load contracts.</span>
        <button type="button" id="contractsRefreshBtn" class="btn btn-sm">Refresh</button>
        <button type="button" id="contractsProbeAllBtn" class="btn btn-sm btn-secondary">Probe L5 (all)</button>
        <button type="button" id="contractsFillAllBtn" class="btn btn-sm btn-secondary">Fill missing</button>
        <button type="button" id="contractsUpdateAllBtn" class="btn btn-sm btn-secondary">Update</button>
      </div>
    </div>

    <div class="tableWrap">
      <table class="table table-compact" id="contractsTable">
        <thead>
          <tr>
            <th>Contract</th>
            <th>Source</th>
            <th>Active</th>
            <th>Local</th>
            <th>Days</th>
            <th>Local range</th>
            <th>DB</th>
            <th>DB range</th>
            <th>DB L5</th>
            <th>%</th>
            <th>Local L5</th>
            <th>Probe</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="contractsTbody">
          <tr><td colspan="13" class="muted">Click Refresh to load.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Tab: DB Sync -->
  <div class="tab-content" id="tab-sync">
    <div class="split-pane-2-1">
      <div class="card">
        <h3 class="mb-2">QuestDB Sync</h3>
        <p class="muted text-sm mb-3">Sync Parquet data to QuestDB for fast queries and schedule building.</p>
        
        <h4>Sync entire variety</h4>
        <form class="form" method="post" action="/ops/db/serve_sync_variety{{ token_qs }}">
          <div class="grid3">
            <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
            <div><label>Variety</label><input name="variety" value="cu"/></div>
            <div></div>
          </div>
          <div class="grid2">
            <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            <div><label>Runs dir</label><input name="runs_dir" value="runs"/></div>
          </div>
          <div class="grid3">
            <div><label>Host</label><input name="host" value="{{ questdb.host | default('127.0.0.1') }}"/></div>
            <div><label>ILP port</label><input name="questdb_ilp_port" value="{{ questdb.ilp_port | default(9009) }}"/></div>
            <div><label>PG port</label><input name="questdb_pg_port" value="{{ questdb.pg_port | default(8812) }}"/></div>
          </div>
          <button type="submit">Sync variety to QuestDB</button>
        </form>

        <h4 style="margin-top:20px;">Sync single symbol</h4>
        <form class="form" method="post" action="/ops/db/serve_sync{{ token_qs }}">
          <div class="grid3">
            <div><label>Symbol</label><input name="symbol" placeholder="SHFE.cu2602"/></div>
            <div><label>Ticks lake</label>
              <select name="ticks_lake"><option value="raw" selected>raw</option><option value="main_l5">main_l5</option></select>
            </div>
            <div></div>
          </div>
          <div class="grid3">
            <div><label>Mode</label>
              <select name="mode"><option value="incremental" selected>incremental</option><option value="backfill">backfill</option></select>
            </div>
            <div><label>Start (optional)</label><input name="start" type="date"/></div>
            <div><label>End (optional)</label><input name="end" type="date"/></div>
          </div>
          <div class="grid3">
            <div><label>Host</label><input name="host" value="{{ questdb.host | default('127.0.0.1') }}"/></div>
            <div><label>ILP port</label><input name="questdb_ilp_port" value="{{ questdb.ilp_port | default(9009) }}"/></div>
            <div><label>PG port</label><input name="questdb_pg_port" value="{{ questdb.pg_port | default(8812) }}"/></div>
          </div>
          <div class="grid2">
            <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            <div><label>Runs dir</label><input name="runs_dir" value="runs"/></div>
          </div>
          <button type="submit">Sync symbol to QuestDB</button>
        </form>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">QuestDB Status</h3>
          {% if questdb and questdb.ok %}
            <div class="status-indicator status-indicator-ok mb-2">
              <span class="status-dot status-dot-ok"></span>
              <span>Connected</span>
            </div>
            <div class="muted text-sm">
              Host: <span class="mono">{{ questdb.host }}</span><br>
              PG port: <span class="mono">{{ questdb.pg_port }}</span><br>
              ILP port: <span class="mono">{{ questdb.ilp_port }}</span>
            </div>
          {% else %}
            <div class="status-indicator status-indicator-error mb-2">
              <span class="status-dot status-dot-error"></span>
              <span>Not reachable</span>
            </div>
            <div class="muted text-sm" style="margin-bottom:8px;">
              Start QuestDB: <span class="mono">docker compose -f infra/questdb/docker-compose.yml up -d</span><br>
              Verify: <span class="mono">ghtrader db questdb-health</span>
            </div>
            {% if questdb and questdb.error %}
              <div class="muted text-sm mono">{{ questdb.error }}</div>
            {% endif %}
          {% endif %}
        </div>

      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Contract explorer logic
  const elExchange = document.getElementById("contractsExchange");
  const elVar = document.getElementById("contractsVar");
  const elSearch = document.getElementById("contractsSearch");
  const elActiveFilter = document.getElementById("contractsActiveFilter");
  const elOnlyMissing = document.getElementById("contractsOnlyMissing");
  const elStatus = document.getElementById("contractsStatus");
  const elTbody = document.getElementById("contractsTbody");
  const btnRefresh = document.getElementById("contractsRefreshBtn");
  const btnProbeAll = document.getElementById("contractsProbeAllBtn");
  const btnFillAll = document.getElementById("contractsFillAllBtn");
  const btnUpdateAll = document.getElementById("contractsUpdateAllBtn");
  const covToggleBtn = document.getElementById("coverageToggleBtn");
  const covRefreshBtn = document.getElementById("coverageRefreshBtn");
  const covPanel = document.getElementById("coveragePanel");
  const questdbBanner = document.getElementById("contractsQuestdbBanner");
  const questdbBannerText = document.getElementById("contractsQuestdbBannerText");

  let lastRows = [];
  let lastQuestdbOk = false;
  window._contractsLoaded = false;

  // Tabs (supports /data#sync etc)
  window.ghTrader.initTabs({
    updateHash: true,
    onTab: (tabId) => {
      if (tabId === "contracts" && !window._contractsLoaded) {
        loadContractsCacheFirst();
      }
    },
  });

  function setStatus(msg) {
    elStatus.textContent = msg;
  }

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function row4(r) {
    const sym = esc(r.symbol || "");
    const n = String(r.n_dates || 0);
    const min = esc(r.min_date || "");
    const max = esc(r.max_date || "");
    return "<tr><td class=\"mono\">" + sym + "</td><td>" + n + "</td><td class=\"mono\">" + min + "</td><td class=\"mono\">" + max + "</td></tr>";
  }

  async function loadCoverageKind(kind, tbodyId, countId, rangeId) {
    const tbody = document.getElementById(tbodyId);
    const countEl = document.getElementById(countId);
    const rangeEl = document.getElementById(rangeId);
    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading...</td></tr>';
    try {
      const url = "/api/data/coverage?kind=" + encodeURIComponent(kind) + "&limit=50";
      const resp = await window.ghTrader.fetchApi(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const body = await resp.json();
      if (!body || body.ok === false) throw new Error(body.error || body.detail || "failed");
      const rows = Array.isArray(body.rows) ? body.rows : [];
      if (countEl) countEl.textContent = String(body.count || rows.length || 0);
      // best-effort global range from returned sample
      let gmin = "";
      let gmax = "";
      for (const r of rows) {
        const a = String(r.min_date || "");
        const b = String(r.max_date || "");
        if (a && (!gmin || a < gmin)) gmin = a;
        if (b && (!gmax || b > gmax)) gmax = b;
      }
      if (rangeEl) rangeEl.textContent = (gmin || gmax) ? (gmin + " - " + gmax) : "--";
      if (tbody) tbody.innerHTML = rows.length ? rows.map(row4).join("") : '<tr><td colspan="4" class="muted">No data.</td></tr>';
    } catch (e) {
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="muted">Failed to load.</td></tr>';
      if (countEl) countEl.textContent = "--";
      if (rangeEl) rangeEl.textContent = "--";
    }
  }

  let _coverageLoaded = false;
  async function loadCoverageOverview(force) {
    if (_coverageLoaded && !force) return;
    _coverageLoaded = true;
    if (covRefreshBtn) covRefreshBtn.style.display = "inline-block";
    await Promise.all([
      loadCoverageKind("ticks", "covTicksTbody", "covTicksCount", "covTicksRange"),
      loadCoverageKind("main_l5", "covMainL5Tbody", "covMainL5Count", "covMainL5Range"),
      loadCoverageKind("features", "covFeaturesTbody", "covFeaturesCount", "covFeaturesRange"),
      loadCoverageKind("labels", "covLabelsTbody", "covLabelsCount", "covLabelsRange"),
    ]);
  }

  if (covToggleBtn && covPanel) {
    covToggleBtn.addEventListener("click", () => {
      const open = covPanel.style.display !== "none";
      covPanel.style.display = open ? "none" : "block";
      covToggleBtn.textContent = open ? "Show" : "Hide";
      if (!open) loadCoverageOverview(false);
    });
  }
  if (covRefreshBtn) {
    covRefreshBtn.addEventListener("click", () => loadCoverageOverview(true));
  }

  function fmtAgeSec(sec) {
    if (sec === null || sec === undefined) return "";
    const s = Math.max(0, Number(sec));
    if (!isFinite(s)) return "";
    const m = Math.round(s / 60);
    if (m < 60) return m + "m";
    const h = Math.floor(m / 60);
    const mm = m % 60;
    if (h < 24) return h + "h" + (mm ? (mm + "m") : "");
    const d = Math.floor(h / 24);
    const hh = h % 24;
    return d + "d" + (hh ? (hh + "h") : "");
  }

  function fmtTime(ts) {
    if (!ts) return "";
    try {
      return new Date(ts).toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    } catch (e) {
      return String(ts);
    }
  }

  function fmtPct(p) {
    if (p === null || p === undefined) return "";
    return (Math.max(0, Math.min(1, Number(p))) * 100).toFixed(0) + "%";
  }

  function fmtProbeCell(p) {
    if (!p) return "<span class=\"muted\">-</span>";
    if (p.l5_present === true) return "<span class=\"pill pill-succeeded\">yes</span>";
    if (p.l5_present === false) return "<span class=\"pill pill-failed\">no</span>";
    return "<span class=\"muted\">-</span>";
  }

  function rowHtml(r) {
    const active = (r.expired === false);
    const activeCell = active ? "<span class=\"pill pill-succeeded\">active</span>" : "<span class=\"pill\">expired</span>";
    let statusCell = "<span class=\"pill\">-</span>";
    const st = String(r.status || "");
    if (st === "complete") statusCell = "<span class=\"pill pill-succeeded\">complete</span>";
    else if (st === "stale") statusCell = "<span class=\"pill pill-running\">stale</span>";
    else if (st === "incomplete") statusCell = "<span class=\"pill pill-running\">incomplete</span>";
    else if (st === "not-downloaded") statusCell = "<span class=\"pill\">none</span>";

    const source = String(r.catalog_source || "").substring(0, 6) || "-";
    const localRangeDay = (r.local_min || r.local_max) ? ((r.local_min || "") + " - " + (r.local_max || "")) : "-";
    const localLast = r.local_last_tick_ts ? fmtTime(r.local_last_tick_ts) : "";
    const localLag = fmtAgeSec(r.local_last_tick_age_sec);
    const localRange = [
      '<div class="mono text-xs">' + esc(localRangeDay) + "</div>",
      localLast ? ('<div class="muted text-xs">last tick: ' + esc(localLast) + (localLag ? (" (lag " + esc(localLag) + ")") : "") + "</div>") : '<div class="muted text-xs">--</div>',
    ].join("");
    
    const qc = r.questdb_coverage || null;
    const dbRangeDay = qc && (qc.first_tick_day || qc.last_tick_day) ? ((qc.first_tick_day || "") + " - " + (qc.last_tick_day || "")) : "-";
    const dbLast = qc && qc.last_tick_ts ? fmtTime(qc.last_tick_ts) : "";
    let dbLag = "";
    try {
      if (qc && qc.last_tick_ts) dbLag = fmtAgeSec((Date.now() - Date.parse(qc.last_tick_ts)) / 1000.0);
    } catch (e) {}
    const dbRange = [
      '<div class="mono text-xs">' + esc(dbRangeDay) + "</div>",
      dbLast ? ('<div class="muted text-xs">last tick: ' + esc(dbLast) + (dbLag ? (" (lag " + esc(dbLag) + ")") : "") + "</div>") : '<div class="muted text-xs">--</div>',
    ].join("");

    const dbL5Day = qc && (qc.first_l5_day || qc.last_l5_day) ? ((qc.first_l5_day || "") + " - " + (qc.last_l5_day || "")) : "-";
    const dbL5Last = qc && qc.last_l5_ts ? fmtTime(qc.last_l5_ts) : "";
    let dbL5Lag = "";
    try {
      if (qc && qc.last_l5_ts) dbL5Lag = fmtAgeSec((Date.now() - Date.parse(qc.last_l5_ts)) / 1000.0);
    } catch (e) {}
    const dbL5 = [
      '<div class="mono text-xs">' + esc(dbL5Day) + "</div>",
      dbL5Last ? ('<div class="muted text-xs">last L5: ' + esc(dbL5Last) + (dbL5Lag ? (" (lag " + esc(dbL5Lag) + ")") : "") + "</div>") : '<div class="muted text-xs">--</div>',
    ].join("");

    let dbStatusCell = "<span class=\"muted\">-</span>";
    const ds = String(r.db_status || "");
    if (ds === "ok") dbStatusCell = "<span class=\"pill pill-succeeded\">ok</span>";
    else if (ds === "stale") dbStatusCell = "<span class=\"pill pill-running\">stale</span>";
    else if (ds === "empty") dbStatusCell = "<span class=\"pill\">empty</span>";
    else if (ds === "error") dbStatusCell = "<span class=\"pill pill-failed\">err</span>";

    const l5 = r.local_l5 || {};
    let l5Text = "-";
    if (l5.status === "ready" && l5.l5_days > 0) l5Text = String(l5.l5_days) + "d";
    
    const actions = [
      "<button type=\"button\" class=\"btn-sm btn-secondary\" data-action=\"update\" data-symbol=\"" + r.symbol + "\">Update</button>",
      "<button type=\"button\" class=\"btn-sm btn-secondary\" data-action=\"audit\" data-symbol=\"" + r.symbol + "\">Audit</button>",
      "<button type=\"button\" class=\"btn-sm btn-secondary\" data-action=\"fill\" data-symbol=\"" + r.symbol + "\">Fill</button>",
      "<button type=\"button\" class=\"btn-sm btn-secondary\" data-action=\"sync\" data-symbol=\"" + r.symbol + "\" " + (lastQuestdbOk ? "" : "disabled") + ">Sync</button>",
    ].join(" ");

    const probeCell = [
      fmtProbeCell(r.tqsdk_probe),
      "<div style=\"margin-top:6px;\"><button type=\"button\" class=\"btn-sm btn-secondary\" data-action=\"probe\" data-symbol=\"" + r.symbol + "\">Probe</button></div>",
    ].join("");

    return [
      "<tr data-symbol=\"" + r.symbol + "\">",
        "<td class=\"mono\">" + esc(r.symbol) + "</td>",
        "<td class=\"mono\">" + esc(source) + "</td>",
        "<td>" + activeCell + "</td>",
        "<td>" + statusCell + "</td>",
        "<td>" + String(r.local_days_downloaded || 0) + "</td>",
        "<td class=\"mono text-xs\">" + localRange + "</td>",
        "<td>" + dbStatusCell + "</td>",
        "<td class=\"mono text-xs\">" + dbRange + "</td>",
        "<td class=\"mono text-xs\">" + dbL5 + "</td>",
        "<td>" + fmtPct(r.pct) + "</td>",
        "<td>" + l5Text + "</td>",
        "<td>" + probeCell + "</td>",
        "<td>" + actions + "</td>",
      "</tr>"
    ].join("");
  }

  let _contractsReqSeq = 0;

  async function fetchContracts(opts) {
    opts = opts || {};
    const ex = elExchange.value;
    const v = elVar.value;
    const refresh = opts.refresh ? "1" : "0";
    const url = window.ghTrader.withToken("/api/contracts?exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&refresh=" + refresh);
    const label = String(opts.label || (opts.refresh ? "Refreshing contracts..." : "Loading contracts..."));
    const timeoutMs = Number(opts.timeoutMs || 30000);
    const controller = new AbortController();
    const startedAt = Date.now();
    const tick = setInterval(() => {
      const s = Math.floor((Date.now() - startedAt) / 1000);
      setStatus(label + " (" + s + "s)");
    }, 1000);
    const to = setTimeout(() => controller.abort(), timeoutMs);
    try {
      setStatus(label + " (0s)");
      const resp = await window.ghTrader.fetchApi(url, { signal: controller.signal });
      const body = await resp.json();
      if (!resp.ok || !body.ok) {
        throw new Error(body.error || body.detail || "HTTP " + resp.status);
      }
      return body;
    } catch (e) {
      if (String(e && e.name) === "AbortError") {
        throw new Error("Timed out after " + Math.round(timeoutMs / 1000) + "s");
      }
      throw e;
    } finally {
      clearInterval(tick);
      clearTimeout(to);
    }
  }

  function renderRows() {
    const q = String(elSearch.value || "").trim().toLowerCase();
    const activeMode = String(elActiveFilter.value || "all");
    const missingOnly = !!elOnlyMissing.checked;
    const rows = (lastRows || []).filter((r) => {
      const sym = String((r && r.symbol) || "").toLowerCase();
      if (q && sym.indexOf(q) < 0) return false;
      const isActive = (r && r.expired === false);
      if (activeMode === "active" && !isActive) return false;
      if (activeMode === "expired" && isActive) return false;
      if (missingOnly) {
        const st = String((r && r.status) || "");
        if (["not-downloaded", "incomplete", "stale"].indexOf(st) < 0) return false;
      }
      return true;
    });
    if (!rows.length) {
      elTbody.innerHTML = "<tr><td colspan=\"13\" class=\"muted\">No matching contracts.</td></tr>";
      return;
    }
    elTbody.innerHTML = rows.map(rowHtml).join("");
  }

  async function refreshTable(opts) {
    const reqId = ++_contractsReqSeq;
    try {
      const body = await fetchContracts(opts);
      if (reqId !== _contractsReqSeq) return;
      const rows = body.contracts || [];
      window._contractsLoaded = true;
      document.getElementById("contractsBadge").textContent = rows.length;
      if (!rows.length) {
        elTbody.innerHTML = "<tr><td colspan=\"13\" class=\"muted\">No contracts returned.</td></tr>";
        setStatus("No contracts returned.");
        return;
      }
      lastRows = rows;
      lastQuestdbOk = !!(body.questdb && body.questdb.ok);
      if (questdbBanner) {
        if (body.questdb && body.questdb.ok === false) {
          questdbBanner.style.display = "flex";
          const err = (body.questdb && body.questdb.error) ? String(body.questdb.error) : "";
          if (questdbBannerText) questdbBannerText.textContent = err ? err : "QuestDB connection failed";
        } else {
          questdbBanner.style.display = "none";
        }
      }
      renderRows();
      const meta = [];
      const catSrc = (body.catalog_source || body.catalog_source === "") ? String(body.catalog_source) : "";
      const catAt = body.catalog_cached_at ? String(body.catalog_cached_at) : "";
      const catOk = (body.catalog_ok === true);
      if (catSrc || catAt) meta.push("catalog " + (catSrc || "--") + (catAt ? (" @" + catAt) : "") + (catOk ? "" : " (stale)"));
      if (body.questdb && body.questdb.ok === true) meta.push("QuestDB ok");
      else meta.push("QuestDB offline");
      if (body.local_checked_at || body.generated_at) meta.push("checked " + String(body.local_checked_at || body.generated_at));
      if (body.timings_ms && body.timings_ms.total !== undefined) meta.push("t=" + String(body.timings_ms.total) + "ms");
      setStatus("Loaded " + rows.length + " contracts" + (meta.length ? (" — " + meta.join(" • ")) : ""));
    } catch (e) {
      if (reqId !== _contractsReqSeq) return;
      const msg = String(e.message || e);
      const hasTable = Array.isArray(lastRows) && lastRows.length > 0;
      if (!hasTable) {
        elTbody.innerHTML = "<tr><td colspan=\"13\" class=\"muted\">Failed to load contracts.</td></tr>";
      }
      if (questdbBanner) questdbBanner.style.display = "none";
      setStatus("Error: " + msg + (hasTable ? " — still showing cached results" : ""));
      window.ghTrader.toast("Failed to load contracts: " + msg, "error");
    }
  }

  async function loadContractsCacheFirst() {
    await refreshTable({ refresh: false, timeoutMs: 15000, label: "Loading contracts..." });
    // Background refresh (non-blocking): keep cached table if it fails.
    refreshTable({ refresh: true, timeoutMs: 30000, label: "Refreshing contracts...", background: true });
  }

  btnRefresh.addEventListener("click", () => {
    // Re-render quickly from cache, then refresh in background.
    loadContractsCacheFirst();
  });
  const renderRowsDebounced = window.ghTrader.debounce(renderRows, 120);
  elSearch.addEventListener("input", () => renderRowsDebounced());
  elActiveFilter.addEventListener("change", () => renderRows());
  elOnlyMissing.addEventListener("change", () => renderRows());
  
  btnProbeAll.addEventListener("click", async () => {
    try {
      setStatus("Enqueuing probe jobs...");
      await window.ghTrader.postJson("/api/contracts/enqueue-probe-l5", { exchange: elExchange.value, var: elVar.value, scope: "all" });
      setStatus("Probe jobs enqueued. Check Jobs.");
      window.ghTrader.toast("Probe jobs enqueued", "success");
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });
  
  btnFillAll.addEventListener("click", async () => {
    try {
      setStatus("Enqueuing fill jobs...");
      await window.ghTrader.postJson("/api/contracts/enqueue-fill", { exchange: elExchange.value, var: elVar.value, scope: "missing" });
      setStatus("Fill jobs enqueued. Check Jobs.");
      window.ghTrader.toast("Fill jobs enqueued", "success");
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });

  btnUpdateAll.addEventListener("click", async () => {
    try {
      setStatus("Enqueuing update job...");
      const body = await window.ghTrader.postJson("/api/contracts/enqueue-update", { exchange: elExchange.value, var: elVar.value, recent_expired_days: 10, refresh_catalog: true });
      const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
      setStatus("Update job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
      window.ghTrader.toast("Update job enqueued", "success");
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });

  document.getElementById("contractsTable").addEventListener("click", async (ev) => {
    const t = ev.target;
    if (!t || !t.dataset) return;
    const action = t.dataset.action;
    const sym = t.dataset.symbol;
    if (!action || !sym) return;
    try {
      if (action === "probe") {
        setStatus("Enqueuing probe for " + sym + "...");
        await window.ghTrader.postJson("/api/contracts/enqueue-probe-l5", { exchange: elExchange.value, var: elVar.value, symbols: [sym] });
        setStatus("Probe enqueued for " + sym);
        window.ghTrader.toast("Probe enqueued for " + sym, "success");
      } else if (action === "update") {
        setStatus("Enqueuing update for " + sym + "...");
        const body = await window.ghTrader.postJson("/api/contracts/enqueue-update", { exchange: elExchange.value, var: elVar.value, symbols: [sym], recent_expired_days: 10, refresh_catalog: true });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Update enqueued for " + sym + (jobId ? (" (" + jobId + ")") : ""));
        window.ghTrader.toast("Update enqueued for " + sym, "success");
      } else if (action === "fill") {
        setStatus("Enqueuing fill for " + sym + "...");
        await window.ghTrader.postJson("/api/contracts/enqueue-fill", { exchange: elExchange.value, var: elVar.value, symbols: [sym] });
        setStatus("Fill enqueued for " + sym);
        window.ghTrader.toast("Fill enqueued for " + sym, "success");
      } else if (action === "sync") {
        setStatus("Starting QuestDB sync for " + sym + "...");
        await window.ghTrader.postJson("/api/contracts/enqueue-sync-questdb", { symbols: [sym] });
        setStatus("Sync started for " + sym);
        window.ghTrader.toast("Sync started for " + sym, "success");
      } else if (action === "audit") {
        setStatus("Starting audit for " + sym + "...");
        await window.ghTrader.postJson("/api/contracts/enqueue-audit", { symbols: [sym] });
        setStatus("Audit started for " + sym);
        window.ghTrader.toast("Audit started for " + sym, "success");
      }
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });

  // Contracts is the primary workflow: load immediately (cache-first) on page load.
  setTimeout(loadContractsCacheFirst, 0);
})();
</script>
{% endblock %}
