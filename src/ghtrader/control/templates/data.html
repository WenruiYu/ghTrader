{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Data Hub</h2>
    <div class="section-header-actions">
      <span class="pill">QuestDB</span>
      <span class="pill">Contracts <span class="badge" id="contractsBadge">--</span></span>
    </div>
  </div>

  <!-- Contracts (QuestDB-first) -->
  <div class="tab-content active" id="tab-contracts">
    <div class="card">
      <div class="section-header mb-2">
        <h3 class="mb-0">Contract Explorer</h3>
        <div class="muted text-sm">TqSdk catalog + QuestDB index + completeness</div>
      </div>

      <div class="alert-banner alert-warn mb-3" id="contractsQuestdbBanner" style="display:none;">
        <div class="alert-banner-icon">!</div>
        <div class="alert-banner-content">
          <div class="alert-banner-title">QuestDB unreachable</div>
          <div class="muted text-sm" id="contractsQuestdbBannerText">--</div>
          <div class="muted text-xs">DB-dependent actions are disabled until QuestDB is reachable.</div>
        </div>
      </div>

      <!-- Overview (coverage) - collapsible -->
      <div class="card" style="margin-bottom:12px;">
        <div class="section-header mb-2" style="margin-bottom:8px;">
          <h4 class="mb-0">Overview (coverage)</h4>
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn btn-sm btn-secondary" id="coverageToggleBtn" title="Show/hide coverage summary for ticks, main_l5, features, and labels">Show</button>
            <button type="button" class="btn btn-sm btn-secondary" id="coverageRefreshBtn" style="display:none;" title="Reload coverage data from QuestDB">Refresh</button>
          </div>
        </div>
        <div id="coveragePanel" style="display:none;">
          <div class="kpi-grid mb-3">
            <div class="kpi-card">
              <div class="kpiLabel">Raw Tick Symbols</div>
              <div class="kpiValue" id="covTicksCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covTicksRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">main_l5 Symbols</div>
              <div class="kpiValue" id="covMainL5Count">--</div>
              <div class="kpiSubtext mono text-xs" id="covMainL5Range">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Features Built</div>
              <div class="kpiValue" id="covFeaturesCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covFeaturesRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Labels Built</div>
              <div class="kpiValue" id="covLabelsCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covLabelsRange">--</div>
            </div>
          </div>

          <div class="split-pane">
            <div class="card">
              <h4 class="mb-2">Raw ticks (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covTicksTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <h4 class="mb-2">main_l5 (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covMainL5Tbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="split-pane">
            <div class="card">
              <h4 class="mb-2">Features (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covFeaturesTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
            <div class="card">
              <h4 class="mb-2">Labels (sample)</h4>
              <div class="tableWrap">
                <table class="table table-compact">
                  <thead><tr><th>Symbol</th><th>#days</th><th>min</th><th>max</th></tr></thead>
                  <tbody id="covLabelsTbody"><tr><td colspan="4" class="muted">Not loaded.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scope selectors -->
      <div class="grid2 mb-3">
        <div>
          <label class="text-sm">Exchange</label>
          <select id="contractsExchange" class="form-control">
            <option value="SHFE" selected>SHFE</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Variety</label>
          <select id="contractsVar" class="form-control">
            <option value="cu" selected>cu (Copper)</option>
            <option value="au">au (Gold)</option>
            <option value="ag">ag (Silver)</option>
          </select>
        </div>
      </div>

      <!-- Workflow Stepper Card (PRD-aligned) -->
      <div class="card" style="margin-bottom:12px; background:var(--bg-secondary);">
        <div class="section-header mb-2">
          <h4 class="mb-0">Workflow Steps</h4>
          <div class="muted text-xs">Complete steps in order for reliable data management</div>
        </div>

        <div class="workflow-stepper">
          <!-- Step 0: Refresh -->
          <div class="workflow-step" id="step0">
            <div class="workflow-step-header">
              <span class="workflow-step-num">0</span>
              <span class="workflow-step-title">Refresh Snapshot</span>
              <button type="button" id="contractsRefreshBtn" class="btn btn-sm" title="Rebuild cached contracts snapshot from catalog and QuestDB index">Refresh</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Load/refresh the contracts list from TqSdk catalog and QuestDB index.
            </div>
            <div class="workflow-step-status text-xs" id="step0Status">--</div>
          </div>

          <!-- Step 1: Index Health -->
          <div class="workflow-step" id="step1">
            <div class="workflow-step-header">
              <span class="workflow-step-num">1</span>
              <span class="workflow-step-title">Index Health</span>
              <button type="button" id="indexBootstrapBtn" class="btn btn-sm btn-secondary" title="Bootstrap QuestDB symbol-day index from ticks table">Bootstrap Index</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Ensure the QuestDB index is populated. If symbols show as "unindexed", run Bootstrap.
            </div>
            <div class="workflow-step-status text-xs" id="step1Status">
              <span id="indexHealthStatus">--</span>
            </div>
          </div>

          <!-- Step 2: Verify -->
          <div class="workflow-step" id="step2">
            <div class="workflow-step-header">
              <span class="workflow-step-num">2</span>
              <span class="workflow-step-title">Verify Completeness</span>
              <button type="button" id="toolsVerifyBtn" class="btn btn-sm btn-secondary" title="Compute expected vs present days using QuestDB index and no-data tables">Verify</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Compute expected vs present days. Shows which contracts have missing data.
            </div>
            <div class="workflow-step-status text-xs" id="step2Status">--</div>
          </div>

          <!-- Step 3: Fill Missing -->
          <div class="workflow-step" id="step3">
            <div class="workflow-step-header">
              <span class="workflow-step-num">3</span>
              <span class="workflow-step-title">Fill Missing</span>
              <button type="button" id="toolsFillBtn" class="btn btn-sm btn-secondary" title="Download missing days from TqSdk into QuestDB for all incomplete contracts">Fill Missing</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Download missing days from TqSdk into QuestDB. Requires healthy index (step 1). If nothing is indexed yet, Step 3 becomes Init (Download) to seed a new variety.
            </div>
            <div class="workflow-step-status text-xs" id="step3Status">--</div>
          </div>

          <!-- Step 4: Update All -->
          <div class="workflow-step" id="step4">
            <div class="workflow-step-header">
              <span class="workflow-step-num">4</span>
              <span class="workflow-step-title">Update All</span>
              <button type="button" id="contractsUpdateAllBtn" class="btn btn-sm btn-secondary" title="Forward-fill active contracts and recently expired (last 10 days) from TqSdk">Update All</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Daily forward-fill for active + recently expired contracts (last 10 days).
            </div>
            <div class="workflow-step-status text-xs" id="step4Status">--</div>
          </div>

          <!-- Step 5: Compute L5 Start -->
          <div class="workflow-step" id="step5">
            <div class="workflow-step-header">
              <span class="workflow-step-num">5</span>
              <span class="workflow-step-title">Compute L5 Start</span>
              <button type="button" id="toolsL5StartBtn" class="btn btn-sm btn-secondary" title="Compute first L5 day for each symbol (for main_l5 builds)">Compute L5</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Identify first L5 day per symbol for main_l5 dataset builds.
            </div>
            <div class="workflow-step-status text-xs" id="step5Status">--</div>
          </div>
        </div>

        <!-- Advanced Options (collapsible) -->
        <div style="margin-top:12px;">
          <button type="button" class="btn btn-sm btn-secondary" id="advancedToggleBtn" title="Show/hide date overrides and latest reports">Advanced Options</button>
        </div>
        <div id="advancedPanel" style="display:none; margin-top:12px;">
          <div class="grid3 mb-3">
            <div>
              <label class="text-sm">Start date (optional)</label>
              <input id="toolsStart" type="date" />
            </div>
            <div>
              <label class="text-sm">End date (optional)</label>
              <input id="toolsEnd" type="date" />
            </div>
            <div style="display:flex; align-items:flex-end; gap:16px;">
              <label style="margin:0; display:flex; align-items:center; gap:8px;" title="When checked, fetch latest contract catalog from TqSdk before running job (requires network)">
                <input type="checkbox" id="toolsRefreshCatalog" />
                <span class="text-sm">Refresh catalog from TqSdk</span>
              </label>
            </div>
          </div>

          <div class="split-pane">
            <div class="card">
              <h4 class="mb-2">Latest Verify Report</h4>
              <div class="muted text-sm" id="toolsVerifyMeta">Not loaded.</div>
              <pre class="mono text-xs" id="toolsVerifyJson" style="white-space:pre-wrap; margin-top:8px;">--</pre>
            </div>
            <div class="card">
              <h4 class="mb-2">Latest L5 Report</h4>
              <div class="muted text-sm" id="toolsL5Meta">Not loaded.</div>
              <pre class="mono text-xs" id="toolsL5Json" style="white-space:pre-wrap; margin-top:8px;">--</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and filter -->
      <div class="grid3 mb-3">
        <div>
          <label class="text-sm">Search</label>
          <input id="contractsSearch" placeholder="e.g. cu1601, 2602" />
        </div>
        <div>
          <label class="text-sm">Filter</label>
          <select id="contractsActiveFilter" class="form-control">
            <option value="all" selected>all contracts</option>
            <option value="active">active only</option>
            <option value="expired">expired only</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <label style="margin:0; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="contractsOnlyMissing" />
            <span class="text-sm">missing/stale only</span>
          </label>
        </div>
      </div>

      <!-- Status bar -->
      <div class="action-bar card-no-margin" style="margin-bottom:12px;">
        <span class="action-bar-title" id="contractsStatus">Click Refresh to load contracts.</span>
      </div>
    </div>

    <div class="tableWrap">
      <table class="table table-compact" id="contractsTable">
        <thead>
          <tr>
            <th>Contract</th>
            <th>Active</th>
            <th>Status</th>
            <th>Expected</th>
            <th>Present</th>
            <th>Missing</th>
            <th>No-data</th>
            <th>Last tick</th>
            <th>L5 start</th>
          </tr>
        </thead>
        <tbody id="contractsTbody">
          <tr><td colspan="9" class="muted">Click Refresh to load.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

<style>
.workflow-stepper {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.workflow-step {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
}
.workflow-step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
}
.workflow-step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  font-size: 11px;
  font-weight: 600;
}
.workflow-step-title {
  font-weight: 500;
  flex: 1;
}
.workflow-step-desc {
  margin-left: 32px;
  margin-bottom: 4px;
}
.workflow-step-status {
  margin-left: 32px;
  color: var(--muted);
}
.workflow-step-status .pill {
  font-size: 10px;
  padding: 1px 6px;
}
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Contract explorer logic
  const elExchange = document.getElementById("contractsExchange");
  const elVar = document.getElementById("contractsVar");
  const elSearch = document.getElementById("contractsSearch");
  const elActiveFilter = document.getElementById("contractsActiveFilter");
  const elOnlyMissing = document.getElementById("contractsOnlyMissing");
  const elStatus = document.getElementById("contractsStatus");
  const elTbody = document.getElementById("contractsTbody");
  const btnRefresh = document.getElementById("contractsRefreshBtn");
  const btnUpdateAll = document.getElementById("contractsUpdateAllBtn");
  const btnIndexBootstrap = document.getElementById("indexBootstrapBtn");
  const btnL5Start = document.getElementById("toolsL5StartBtn");
  const covToggleBtn = document.getElementById("coverageToggleBtn");
  const covRefreshBtn = document.getElementById("coverageRefreshBtn");
  const covPanel = document.getElementById("coveragePanel");
  const questdbBanner = document.getElementById("contractsQuestdbBanner");
  const questdbBannerText = document.getElementById("contractsQuestdbBannerText");

  let lastRows = [];
  let lastQuestdbOk = false;
  let lastCompleteness = null;
  window._contractsLoaded = false;
  let _advancedLoaded = false;

  // Advanced panel elements
  const advancedToggleBtn = document.getElementById("advancedToggleBtn");
  const advancedPanel = document.getElementById("advancedPanel");
  const toolsStart = document.getElementById("toolsStart");
  const toolsEnd = document.getElementById("toolsEnd");
  const toolsRefreshCatalog = document.getElementById("toolsRefreshCatalog");
  const toolsVerifyBtn = document.getElementById("toolsVerifyBtn");
  const toolsFillBtn = document.getElementById("toolsFillBtn");
  const toolsVerifyMeta = document.getElementById("toolsVerifyMeta");
  const toolsVerifyJson = document.getElementById("toolsVerifyJson");
  const toolsL5Meta = document.getElementById("toolsL5Meta");
  const toolsL5Json = document.getElementById("toolsL5Json");

  // Step status elements
  const step0Status = document.getElementById("step0Status");
  const step1Status = document.getElementById("step1Status");
  const indexHealthStatus = document.getElementById("indexHealthStatus");
  const step2Status = document.getElementById("step2Status");
  const step3Status = document.getElementById("step3Status");
  const step4Status = document.getElementById("step4Status");
  const step5Status = document.getElementById("step5Status");

  function toggleAdvanced(open) {
    if (!advancedPanel || !advancedToggleBtn) return;
    const isOpen = advancedPanel.style.display !== "none";
    const next = (open === true) ? true : ((open === false) ? false : !isOpen);
    advancedPanel.style.display = next ? "block" : "none";
    advancedToggleBtn.textContent = next ? "Hide Advanced" : "Advanced Options";
    if (next && !_advancedLoaded) {
      _advancedLoaded = true;
      loadToolsReports();
    }
  }
  if (advancedToggleBtn) advancedToggleBtn.addEventListener("click", () => toggleAdvanced());

  function setStatus(msg) {
    elStatus.textContent = msg;
  }

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function updateStepStatuses(body) {
    // Step 0: Refresh status
    const rows = body.contracts || [];
    const catSrc = body.catalog_source || "";
    const catAt = body.catalog_cached_at || "";
    if (step0Status) {
      step0Status.innerHTML = rows.length + " contracts" + (catAt ? (" • catalog: " + catAt) : "");
    }

    // Step 1: Index health
    const completeness = (body && body.completeness && body.completeness.summary) ? body.completeness.summary : null;
    lastCompleteness = completeness;
    if (indexHealthStatus) {
      if (!completeness) {
        indexHealthStatus.innerHTML = '<span class="muted">--</span>';
      } else {
        const indexed = completeness.symbols_indexed || 0;
        const total = completeness.symbols_total || 0;
        const unindexed = completeness.symbols_unindexed || 0;
        const healthy = completeness.index_healthy;
        if (healthy) {
          indexHealthStatus.innerHTML = '<span class="pill pill-succeeded">healthy</span> ' + indexed + '/' + total + ' indexed';
        } else {
          indexHealthStatus.innerHTML = '<span class="pill pill-running">needs bootstrap</span> ' + unindexed + '/' + total + ' unindexed';
        }
      }
    }

    // Step 3: Fill Missing / Init mode
    if (toolsFillBtn) {
      const hasComp = !!completeness;
      const indexed = hasComp ? (Number(completeness.symbols_indexed || 0) || 0) : 0;
      const unindexed = hasComp ? (Number(completeness.symbols_unindexed || 0) || 0) : 0;
      const indexHealthy = hasComp ? !!completeness.index_healthy : false; // missing completeness is unsafe
      const initMode = hasComp && !indexHealthy && indexed === 0 && unindexed > 0;

      toolsFillBtn.dataset.mode = initMode ? "init" : (indexHealthy ? "normal" : "blocked");
      toolsFillBtn.textContent = initMode ? "Init (Download)" : "Fill Missing";
      toolsFillBtn.disabled = !lastQuestdbOk || !hasComp || (!indexHealthy && !initMode);

      if (!lastQuestdbOk) {
        toolsFillBtn.title = "QuestDB offline";
      } else if (!hasComp) {
        toolsFillBtn.title = "Refresh snapshot first (step 0) to compute index health";
      } else if (initMode) {
        toolsFillBtn.title = "Init mode: enqueue per-symbol download jobs to seed a brand-new variety (requires confirm)";
      } else if (!indexHealthy) {
        toolsFillBtn.title = "Run Bootstrap Index first (step 1)";
      } else {
        toolsFillBtn.title = "Download missing days from TqSdk into QuestDB for all incomplete contracts";
      }

      if (step3Status) {
        if (!lastQuestdbOk) step3Status.innerHTML = '<span class="pill pill-failed">QuestDB offline</span>';
        else if (!hasComp) step3Status.innerHTML = '<span class="muted">Refresh snapshot to compute index health</span>';
        else if (initMode) step3Status.innerHTML = '<span class="pill pill-running">init mode</span> ' + unindexed + ' symbols';
        else if (!indexHealthy) step3Status.innerHTML = '<span class="muted">Requires Bootstrap Index</span>';
        else step3Status.innerHTML = '<span class="muted">Click to run</span>';
      }
    }

    // Step 2: Verify status from completeness
    if (step2Status && completeness) {
      const missing = completeness.symbols_missing || 0;
      const complete = completeness.symbols_complete || 0;
      step2Status.innerHTML = complete + ' complete, ' + missing + ' missing/incomplete';
    }

    // Step 4-5: show generic status
    if (step4Status) step4Status.innerHTML = '<span class="muted">Click to run</span>';
    if (step5Status) step5Status.innerHTML = '<span class="muted">Click to run</span>';
  }

  function row4(r) {
    const sym = esc(r.symbol || "");
    const n = String(r.n_dates || 0);
    const min = esc(r.min_date || "");
    const max = esc(r.max_date || "");
    return "<tr><td class=\"mono\">" + sym + "</td><td>" + n + "</td><td class=\"mono\">" + min + "</td><td class=\"mono\">" + max + "</td></tr>";
  }

  async function loadCoverageKind(kind, tbodyId, countId, rangeId) {
    const tbody = document.getElementById(tbodyId);
    const countEl = document.getElementById(countId);
    const rangeEl = document.getElementById(rangeId);
    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading...</td></tr>';
    try {
      const url = "/api/data/coverage?kind=" + encodeURIComponent(kind) + "&limit=50";
      const resp = await window.ghTrader.fetchApi(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const body = await resp.json();
      if (!body || body.ok === false) throw new Error(body.error || body.detail || "failed");
      const rows = Array.isArray(body.rows) ? body.rows : [];
      if (countEl) countEl.textContent = String(body.count || rows.length || 0);
      let gmin = "";
      let gmax = "";
      for (const r of rows) {
        const a = String(r.min_date || "");
        const b = String(r.max_date || "");
        if (a && (!gmin || a < gmin)) gmin = a;
        if (b && (!gmax || b > gmax)) gmax = b;
      }
      if (rangeEl) rangeEl.textContent = (gmin || gmax) ? (gmin + " - " + gmax) : "--";
      if (tbody) tbody.innerHTML = rows.length ? rows.map(row4).join("") : '<tr><td colspan="4" class="muted">No data.</td></tr>';
    } catch (e) {
      if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="muted">Failed to load.</td></tr>';
      if (countEl) countEl.textContent = "--";
      if (rangeEl) rangeEl.textContent = "--";
    }
  }

  let _coverageLoaded = false;
  async function loadCoverageOverview(force) {
    if (_coverageLoaded && !force) return;
    _coverageLoaded = true;
    if (covRefreshBtn) covRefreshBtn.style.display = "inline-block";
    await Promise.all([
      loadCoverageKind("ticks", "covTicksTbody", "covTicksCount", "covTicksRange"),
      loadCoverageKind("main_l5", "covMainL5Tbody", "covMainL5Count", "covMainL5Range"),
      loadCoverageKind("features", "covFeaturesTbody", "covFeaturesCount", "covFeaturesRange"),
      loadCoverageKind("labels", "covLabelsTbody", "covLabelsCount", "covLabelsRange"),
    ]);
  }

  if (covToggleBtn && covPanel) {
    covToggleBtn.addEventListener("click", () => {
      const open = covPanel.style.display !== "none";
      covPanel.style.display = open ? "none" : "block";
      covToggleBtn.textContent = open ? "Show" : "Hide";
      if (!open) loadCoverageOverview(false);
    });
  }
  if (covRefreshBtn) {
    covRefreshBtn.addEventListener("click", () => loadCoverageOverview(true));
  }

  function fmtAgeSec(sec) {
    if (sec === null || sec === undefined) return "";
    const s = Math.max(0, Number(sec));
    if (!isFinite(s)) return "";
    const m = Math.round(s / 60);
    if (m < 60) return m + "m";
    const h = Math.floor(m / 60);
    const mm = m % 60;
    if (h < 24) return h + "h" + (mm ? (mm + "m") : "");
    const d = Math.floor(h / 24);
    const hh = h % 24;
    return d + "d" + (hh ? (hh + "h") : "");
  }

  function fmtTime(ts) {
    if (!ts) return "";
    try {
      return new Date(ts).toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    } catch (e) {
      return String(ts);
    }
  }

  function rowHtml(r) {
    const expired = r.expired;
    const active = (expired === false);

    const activeCell = active
      ? "<span class=\"pill pill-succeeded\">active</span>"
      : (expired === true ? "<span class=\"pill\">expired</span>" : "<span class=\"pill\">?</span>");

    // Status (QuestDB-first: status is authoritative)
    const st = String(r.status || "");
    let statusCell = "<span class=\"pill\">--</span>";
    if (st === "complete") statusCell = "<span class=\"pill pill-succeeded\">complete</span>";
    else if (st === "unindexed") statusCell = "<span class=\"pill pill-running\">unindexed</span>";
    else if (st === "missing" || st === "incomplete" || st === "not-downloaded") statusCell = "<span class=\"pill pill-running\">missing</span>";
    else if (st === "stale") statusCell = "<span class=\"pill pill-running\">stale</span>";
    else if (st === "unknown") statusCell = "<span class=\"pill\">unknown</span>";

    const qc = r.questdb_coverage || null;
    const comp = r.completeness || null;

    // Expected window
    let expectedCell = "<span class=\"muted\">--</span>";
    const ef = (comp && comp.expected_first) ? String(comp.expected_first) : String(r.expected_first || "");
    const el = (comp && comp.expected_last) ? String(comp.expected_last) : String(r.expected_last || "");
    const expDays = (comp && comp.expected_days !== null && comp.expected_days !== undefined)
      ? Number(comp.expected_days)
      : ((r.days_expected !== null && r.days_expected !== undefined) ? Number(r.days_expected) : null);
    if (ef || el) {
      const rng = (ef || "") + " - " + (el || "");
      const n = (expDays !== null && isFinite(expDays) && expDays > 0) ? (String(expDays) + "d") : "";
      expectedCell = [
        '<div class="mono text-xs">' + esc(rng) + "</div>",
        n ? ('<div class="muted text-xs">' + esc(n) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // Present days
    let presentCell = "<span class=\"muted\">--</span>";
    const presentDays = (comp && comp.present_days !== null && comp.present_days !== undefined)
      ? Number(comp.present_days)
      : ((r.days_present !== null && r.days_present !== undefined) ? Number(r.days_present) : null);
    let dbRangeDay = "";
    const qFirst = qc ? String(qc.first_tick_day || "") : "";
    const qLast = qc ? String(qc.last_tick_day || "") : "";
    if (qFirst && qLast) dbRangeDay = qFirst + " - " + qLast;
    else if (qLast) dbRangeDay = "last " + qLast;
    else if (qFirst) dbRangeDay = "first " + qFirst;
    else if (r.db_min || r.db_max) {
      const d0 = String(r.db_min || "");
      const d1 = String(r.db_max || "");
      if (d0 && d1) dbRangeDay = d0 + " - " + d1;
      else if (d1) dbRangeDay = "last " + d1;
      else if (d0) dbRangeDay = "first " + d0;
    }
    let tickDays = "";
    try {
      const td = (qc && qc.tick_days !== null && qc.tick_days !== undefined) ? Number(qc.tick_days) : 0;
      if (isFinite(td) && td > 0) tickDays = String(td);
    } catch (e) {}
    if ((presentDays !== null && isFinite(presentDays)) || dbRangeDay) {
      const dbLine = (dbRangeDay ? dbRangeDay : "--") + (tickDays ? (" • tick " + tickDays + "d") : "");
      presentCell = [
        "<div>" + esc((presentDays !== null && isFinite(presentDays)) ? (String(Math.max(0, presentDays)) + "d") : "--") + "</div>",
        dbLine ? ('<div class="mono text-xs">' + esc(dbLine) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // Missing + no-data
    let missingCell = "<span class=\"muted\">--</span>";
    let noDataCell = "<span class=\"muted\">--</span>";
    if (r.index_missing === true || (comp && comp.index_missing === true)) {
      missingCell = '<div class="muted">--</div><div class="muted text-xs">needs index</div>';
    } else if (comp && comp.missing_days !== undefined && comp.missing_days !== null) {
      const missN = String(comp.missing_days || 0);
      const missR = (comp.missing_first || comp.missing_last) ? ((comp.missing_first || "") + " - " + (comp.missing_last || "")) : "";
      missingCell = [
        "<div>" + esc(missN) + "</div>",
        missR ? ('<div class="mono text-xs">' + esc(missR) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    } else {
      const daysExpected = (expDays !== null && isFinite(expDays)) ? Number(expDays) : null;
      const daysDone = (r.days_done !== undefined && r.days_done !== null) ? Number(r.days_done) : null;
      if (daysExpected !== null && daysDone !== null) {
        const missingDays = Math.max(0, daysExpected - daysDone);
        missingCell = "<div>" + esc(String(missingDays)) + "</div>";
      }
    }
    const noDataDays = (comp && comp.no_data_days !== undefined && comp.no_data_days !== null) ? Number(comp.no_data_days) : 0;
    noDataCell = "<div>" + esc(String(noDataDays)) + "</div>";

    // Last tick
    let lastTickCell = "<span class=\"muted\">--</span>";
    const lastDay = String(r.db_max || "") || (qc ? String(qc.last_tick_day || "") : "");
    const lastTs = String(r.db_last_tick_ts || "") || (qc ? String(qc.last_tick_ts || "") : "");
    const lastTime = lastTs ? fmtTime(lastTs) : "";
    let lag = "";
    try {
      if (active && lastTs) lag = fmtAgeSec((Date.now() - Date.parse(lastTs)) / 1000.0);
    } catch (e) {}
    if (lastDay || lastTime) {
      lastTickCell = [
        '<div class="mono text-xs">' + esc(lastDay || "--") + "</div>",
        lastTime
          ? ('<div class="muted text-xs">last: ' + esc(lastTime) + (active && lag ? (" (lag " + esc(lag) + ")") : "") + "</div>")
          : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // L5 start
    let l5Cell = "<span class=\"muted\">--</span>";
    const l5Start = qc ? String(qc.first_l5_day || "") : "";
    if (l5Start) {
      let l5Days = "";
      try {
        const ld = (qc && qc.l5_days !== null && qc.l5_days !== undefined) ? Number(qc.l5_days) : 0;
        if (isFinite(ld) && ld > 0) l5Days = String(ld) + "d";
      } catch (e) {}
      l5Cell = [
        '<div class="mono text-xs">' + esc(l5Start) + "</div>",
        l5Days ? ('<div class="muted text-xs">' + esc(l5Days) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    return [
      "<tr data-symbol=\"" + r.symbol + "\">",
        "<td class=\"mono\">" + esc(r.symbol) + "</td>",
        "<td>" + activeCell + "</td>",
        "<td>" + statusCell + "</td>",
        "<td class=\"mono text-xs\">" + expectedCell + "</td>",
        "<td class=\"mono text-xs\">" + presentCell + "</td>",
        "<td>" + missingCell + "</td>",
        "<td>" + noDataCell + "</td>",
        "<td class=\"mono text-xs\">" + lastTickCell + "</td>",
        "<td class=\"mono text-xs\">" + l5Cell + "</td>",
      "</tr>"
    ].join("");
  }

  let _contractsReqSeq = 0;

  async function fetchContracts(opts) {
    opts = opts || {};
    const ex = elExchange.value;
    const v = elVar.value;
    const refresh = opts.refresh ? "1" : "0";
    const url = window.ghTrader.withToken(
      "/api/contracts?mode=cache&exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&refresh=" + refresh
    );
    const label = String(opts.label || (opts.refresh ? "Refreshing contracts..." : "Loading contracts..."));
    const timeoutMs = Number(opts.timeoutMs || 30000);
    const controller = new AbortController();
    const startedAt = Date.now();
    const tick = setInterval(() => {
      const s = Math.floor((Date.now() - startedAt) / 1000);
      setStatus(label + " (" + s + "s)");
    }, 1000);
    const to = setTimeout(() => controller.abort(), timeoutMs);
    try {
      setStatus(label + " (0s)");
      const resp = await window.ghTrader.fetchApi(url, { signal: controller.signal });
      const body = await resp.json();
      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }
      if (body && body.ok === false && String(body.error || "") === "contracts_snapshot_building") {
        return body;
      }
      if (!body || body.ok !== true) {
        const err = (body && (body.error || body.detail)) ? String(body.error || body.detail) : ("HTTP " + resp.status);
        if (String(err).toLowerCase().includes("catalog_cache_missing_or_stale") || String(err).toLowerCase().includes("cache_missing")) {
          throw new Error("Catalog cache missing. Click Refresh to fetch catalog (requires network + TQSDK creds).");
        }
        throw new Error(err);
      }
      return body;
    } catch (e) {
      if (String(e && e.name) === "AbortError") {
        throw new Error("Timed out after " + Math.round(timeoutMs / 1000) + "s");
      }
      throw e;
    } finally {
      clearInterval(tick);
      clearTimeout(to);
    }
  }

  let _contractsPollTimer = null;
  function stopContractsPolling() {
    if (_contractsPollTimer) {
      clearTimeout(_contractsPollTimer);
      _contractsPollTimer = null;
    }
  }

  function applyContractsBody(body) {
    const rows = body.contracts || [];
    window._contractsLoaded = true;
    document.getElementById("contractsBadge").textContent = rows.length;
    if (!rows.length) {
      elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">No contracts returned.</td></tr>";
      setStatus("No contracts returned.");
      return;
    }
    lastRows = rows;
    lastQuestdbOk = !!(body.questdb && body.questdb.ok);

    // Disable DB-dependent actions when QuestDB is offline
    if (toolsVerifyBtn) toolsVerifyBtn.disabled = !lastQuestdbOk;
    if (toolsFillBtn) toolsFillBtn.disabled = !lastQuestdbOk;
    if (btnUpdateAll) btnUpdateAll.disabled = !lastQuestdbOk;
    if (btnIndexBootstrap) btnIndexBootstrap.disabled = !lastQuestdbOk;
    if (btnL5Start) btnL5Start.disabled = !lastQuestdbOk;

    if (questdbBanner) {
      if (body.questdb && body.questdb.ok === false) {
        questdbBanner.style.display = "flex";
        const err = (body.questdb && body.questdb.error) ? String(body.questdb.error) : "";
        if (questdbBannerText) questdbBannerText.textContent = err ? err : "QuestDB connection failed";
      } else {
        questdbBanner.style.display = "none";
      }
    }

    renderRows();
    updateStepStatuses(body);

    const meta = [];
    const catSrc = (body.catalog_source || body.catalog_source === "") ? String(body.catalog_source) : "";
    const catAt = body.catalog_cached_at ? String(body.catalog_cached_at) : "";
    const catOk = (body.catalog_ok === true);
    if (catSrc || catAt) meta.push("catalog " + (catSrc || "--") + (catAt ? (" @" + catAt) : "") + (catOk ? "" : " (stale)"));
    if (body.questdb && body.questdb.ok === true) meta.push("QuestDB ok");
    else meta.push("QuestDB offline");
    if (body.snapshot_cached_at || body.local_checked_at || body.generated_at) meta.push("checked " + String(body.snapshot_cached_at || body.local_checked_at || body.generated_at));
    if (body.timings_ms && body.timings_ms.total !== undefined) meta.push("t=" + String(body.timings_ms.total) + "ms");
    setStatus("Loaded " + rows.length + " contracts" + (meta.length ? (" — " + meta.join(" • ")) : ""));
  }

  function pollForSnapshot(opts) {
    opts = opts || {};
    const reqId = opts.reqId;
    const prevSnap = Number(opts.prevSnapshotUnix || 0);
    const label = String(opts.label || "Updating contracts snapshot...");
    const startedAt = Date.now();
    const maxWaitMs = Number(opts.maxWaitMs || 120000);
    const silent = !!opts.silent;

    stopContractsPolling();
    const tick = async () => {
      if (reqId !== _contractsReqSeq) return;
      const waited = Date.now() - startedAt;
      if (waited > maxWaitMs) {
        if (!silent) setStatus("Timed out waiting for snapshot update.");
        return;
      }
      try {
        const body = await fetchContracts({ refresh: false, timeoutMs: 10000, label: label });
        if (reqId !== _contractsReqSeq) return;
        if (body && body.ok === true) {
          const curSnap = Number(body.snapshot_cached_at_unix || 0);
          if (!prevSnap || (curSnap && curSnap > prevSnap)) {
            applyContractsBody(body);
            return;
          }
        }
      } catch (e) {
        // Best-effort polling
      }
      _contractsPollTimer = setTimeout(tick, 2000);
    };
    _contractsPollTimer = setTimeout(tick, 1200);
  }

  function renderRows() {
    const q = String(elSearch.value || "").trim().toLowerCase();
    const activeMode = String(elActiveFilter.value || "all");
    const missingOnly = !!elOnlyMissing.checked;
    const rows = (lastRows || []).filter((r) => {
      const sym = String((r && r.symbol) || "").toLowerCase();
      if (q && sym.indexOf(q) < 0) return false;
      const isActive = (r && r.expired === false);
      if (activeMode === "active" && !isActive) return false;
      if (activeMode === "expired" && isActive) return false;
      if (missingOnly) {
        const st = String((r && r.status) || "");
        if (st === "complete") return false;
      }
      return true;
    });
    if (!rows.length) {
      elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">No matching contracts.</td></tr>";
      return;
    }
    elTbody.innerHTML = rows.map(rowHtml).join("");
  }

  async function refreshTable(opts) {
    const reqId = ++_contractsReqSeq;
    try {
      stopContractsPolling();
      const body = await fetchContracts(opts);
      if (reqId !== _contractsReqSeq) return;
      if (body && body.ok === false && String(body.error || "") === "contracts_snapshot_building") {
        const hasTable = Array.isArray(lastRows) && lastRows.length > 0;
        if (!hasTable) {
          elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">Building contracts snapshot...</td></tr>";
        }
        const jobId = (body.snapshot_job && body.snapshot_job.job_id) ? String(body.snapshot_job.job_id) : "";
        setStatus("Building contracts snapshot..." + (jobId ? (" (" + jobId + ")") : ""));
        pollForSnapshot({ reqId, prevSnapshotUnix: 0, label: "Building contracts snapshot...", silent: true });
        return;
      }

      applyContractsBody(body);

      const prevSnap = Number(body.snapshot_cached_at_unix || 0);
      if (opts && opts.refresh) {
        pollForSnapshot({ reqId, prevSnapshotUnix: prevSnap, label: "Refreshing contracts snapshot...", silent: false });
      } else if (body && body.cache_stale) {
        pollForSnapshot({ reqId, prevSnapshotUnix: prevSnap, label: "Updating contracts snapshot...", silent: true });
      }
    } catch (e) {
      if (reqId !== _contractsReqSeq) return;
      const msg = String(e.message || e);
      const hasTable = Array.isArray(lastRows) && lastRows.length > 0;
      if (!hasTable) {
        elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">Failed to load contracts.</td></tr>";
      }
      if (questdbBanner) questdbBanner.style.display = "none";
      if (!opts || !opts.silent) {
        setStatus("Error: " + msg + (hasTable ? " — still showing cached results" : ""));
      }
      if (opts && opts.refresh) {
        window.ghTrader.toast("Failed to refresh contracts: " + msg, "error");
      } else if (!hasTable) {
        window.ghTrader.toast("Failed to load contracts: " + msg, "error");
      }
    }
  }

  async function loadContractsSnapshot() {
    await refreshTable({ refresh: false, timeoutMs: 10000, label: "Loading contracts..." });
  }

  // Step 0: Refresh
  btnRefresh.addEventListener("click", () => {
    refreshTable({ refresh: true, timeoutMs: 10000, label: "Refreshing contracts..." });
  });

  // Step 1: Index Bootstrap
  if (btnIndexBootstrap) {
    btnIndexBootstrap.addEventListener("click", async () => {
      try {
        setStatus("Enqueuing index bootstrap job...");
        const body = await window.ghTrader.postJson("/api/data/enqueue-index-bootstrap", { exchange: elExchange.value, var: elVar.value, force: true });
        if (body.ok === false) {
          throw new Error(body.error || body.message || "failed");
        }
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Index bootstrap job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Index bootstrap job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // Step 4: Update All
  btnUpdateAll.addEventListener("click", async () => {
    try {
      setStatus("Enqueuing update job...");
      const body = await window.ghTrader.postJson("/api/contracts/enqueue-update", { exchange: elExchange.value, var: elVar.value, recent_expired_days: 10, refresh_catalog: true });
      const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
      setStatus("Update job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
      window.ghTrader.toast("Update job enqueued", "success");
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });

  // Step 5: Compute L5 Start
  if (btnL5Start) {
    btnL5Start.addEventListener("click", async () => {
      try {
        setStatus("Enqueuing L5-start job...");
        const start = toolsStart ? toolsStart.value : "";
        const end = toolsEnd ? toolsEnd.value : "";
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        const body = await window.ghTrader.postJson("/api/data/enqueue-l5-start", { exchange: elExchange.value, var: elVar.value, start: start, end: end, refresh_catalog: refresh });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("L5-start job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("L5-start job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  const renderRowsDebounced = window.ghTrader.debounce(renderRows, 120);
  elSearch.addEventListener("input", () => renderRowsDebounced());

  function onScopeChanged() {
    _advancedLoaded = false;
    stopContractsPolling();
    window._contractsLoaded = false;
    lastRows = [];
    renderRows();
    refreshTable({ refresh: false, timeoutMs: 10000, label: "Loading contracts..." });
    if (advancedPanel && advancedPanel.style.display !== "none") loadToolsReports();
  }
  elExchange.addEventListener("change", () => onScopeChanged());
  elVar.addEventListener("change", () => onScopeChanged());
  elActiveFilter.addEventListener("change", () => renderRows());
  elOnlyMissing.addEventListener("change", () => renderRows());

  // -------------------------------------------------------------------------
  // Advanced panel (date overrides + latest reports)
  // -------------------------------------------------------------------------

  function _readDateInput(el) {
    try {
      const v = el && el.value ? String(el.value) : "";
      return v && v.length >= 10 ? v.slice(0, 10) : "";
    } catch (e) {
      return "";
    }
  }

  async function loadToolsReports() {
    const ex = elExchange.value;
    const v = elVar.value;

    // Verify report
    if (toolsVerifyMeta) toolsVerifyMeta.textContent = "Loading...";
    if (toolsVerifyJson) toolsVerifyJson.textContent = "--";
    try {
      const url = window.ghTrader.withToken(
        "/api/data/verify?exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&limit=1"
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
      const rep = (body.reports && body.reports[0]) ? body.reports[0] : null;
      if (!rep) {
        if (toolsVerifyMeta) toolsVerifyMeta.textContent = "No reports yet.";
        if (toolsVerifyJson) toolsVerifyJson.textContent = "--";
      } else {
        const summary = rep.summary || {};
        const gen = rep.generated_at || rep._path || "--";
        const msg = "generated " + String(gen) +
          " • missing_days " + String(summary.missing_days || 0) +
          " • symbols_with_missing " + String(summary.symbols_with_missing || 0);
        if (toolsVerifyMeta) toolsVerifyMeta.textContent = msg;
        if (toolsVerifyJson) {
          toolsVerifyJson.textContent = JSON.stringify({
            generated_at: rep.generated_at,
            exchange: rep.exchange,
            var: rep.var,
            lake_version: rep.lake_version,
            index_table: rep.index_table,
            no_data_table: rep.no_data_table,
            summary: rep.summary,
            path: rep._path,
          }, null, 2);
        }
      }
    } catch (e) {
      if (toolsVerifyMeta) toolsVerifyMeta.textContent = "Failed to load (" + String(e.message || e) + ")";
      if (toolsVerifyJson) toolsVerifyJson.textContent = "--";
    }

    // L5-start report
    if (toolsL5Meta) toolsL5Meta.textContent = "Loading...";
    if (toolsL5Json) toolsL5Json.textContent = "--";
    try {
      const url = window.ghTrader.withToken(
        "/api/data/l5-start?exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&limit=1"
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
      const rep = (body.reports && body.reports[0]) ? body.reports[0] : null;
      if (!rep) {
        if (toolsL5Meta) toolsL5Meta.textContent = "No reports yet.";
        if (toolsL5Json) toolsL5Json.textContent = "--";
      } else {
        const msg = "generated " + String(rep.generated_at || rep._path || "--") +
          " • variety_first_l5_day " + String(rep.variety_first_l5_day || "--") +
          " • symbols_with_l5 " + String(rep.symbols_with_l5 || 0);
        if (toolsL5Meta) toolsL5Meta.textContent = msg;
        if (toolsL5Json) {
          toolsL5Json.textContent = JSON.stringify({
            generated_at: rep.generated_at,
            exchange: rep.exchange,
            var: rep.var,
            lake_version: rep.lake_version,
            index_table: rep.index_table,
            variety_first_l5_day: rep.variety_first_l5_day,
            symbols: rep.symbols,
            symbols_with_l5: rep.symbols_with_l5,
            path: rep._path,
          }, null, 2);
        }
      }
    } catch (e) {
      if (toolsL5Meta) toolsL5Meta.textContent = "Failed to load (" + String(e.message || e) + ")";
      if (toolsL5Json) toolsL5Json.textContent = "--";
    }
  }

  // Step 2: Verify
  if (toolsVerifyBtn) {
    toolsVerifyBtn.addEventListener("click", async () => {
      try {
        const ex = elExchange.value;
        const v = elVar.value;
        const start = _readDateInput(toolsStart);
        const end = _readDateInput(toolsEnd);
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        setStatus("Enqueuing verify job...");
        const body = await window.ghTrader.postJson("/api/data/enqueue-verify", { exchange: ex, var: v, start: start, end: end, refresh_catalog: refresh });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Verify job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Verify job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // Step 3: Fill Missing
  if (toolsFillBtn) {
    toolsFillBtn.addEventListener("click", async () => {
      try {
        if (!lastQuestdbOk) {
          window.ghTrader.toast("QuestDB is offline. Fix QuestDB first.", "error");
          return;
        }
        if (!lastCompleteness) {
          window.ghTrader.toast("Completeness not available yet. Refresh snapshot (step 0) first.", "error");
          return;
        }

        const indexed = Number(lastCompleteness.symbols_indexed || 0) || 0;
        const unindexed = Number(lastCompleteness.symbols_unindexed || 0) || 0;
        const indexHealthy = !!lastCompleteness.index_healthy;
        const initMode = (!indexHealthy && indexed === 0 && unindexed > 0);
        if (!indexHealthy && !initMode) {
          window.ghTrader.toast("Index is unhealthy. Run Bootstrap Index first (step 1).", "error");
          return;
        }

        const ex = elExchange.value;
        const v = elVar.value;
        const start = _readDateInput(toolsStart);
        const end = _readDateInput(toolsEnd);
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);

        if (initMode) {
          const clampStart = start || "(inferred per contract)";
          const clampEnd = end || "(inferred per contract)";
          const msg =
            "Init mode will enqueue per-symbol download jobs to seed a brand-new variety.\n\n" +
            "Target: " + ex + "." + v + "\n" +
            "Jobs: up to " + unindexed + " symbols (dedupes queued/running)\n" +
            "Start clamp: " + clampStart + "\n" +
            "End clamp: " + clampEnd + "\n" +
            (refresh ? "Catalog: refresh from TqSdk\n" : "Catalog: use cached\n") +
            "\nProceed?";
          if (!window.confirm(msg)) return;

          setStatus("Enqueuing init download jobs...");
          const body = await window.ghTrader.postJson("/api/data/enqueue-fill-missing", { exchange: ex, var: v, start: start, end: end, refresh_catalog: refresh, init_mode: true });
          const enq = Array.isArray(body.enqueued) ? body.enqueued : [];
          const sk = Array.isArray(body.skipped) ? body.skipped : [];
          const nEnq = enq.length;
          const nSk = sk.length;
          setStatus("Init download enqueued: " + nEnq + (nSk ? (", skipped " + nSk) : "") + ". Check Jobs.");
          window.ghTrader.toast("Init download jobs enqueued (" + nEnq + ")", "success");
        } else {
          setStatus("Enqueuing fill-missing job...");
          const body = await window.ghTrader.postJson("/api/data/enqueue-fill-missing", { exchange: ex, var: v, start: start, end: end, refresh_catalog: refresh, init_mode: false });
          const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
          setStatus("Fill-missing job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
          window.ghTrader.toast("Fill-missing job enqueued", "success");
        }
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // Contracts is the primary workflow: load immediately on page load.
  setTimeout(loadContractsSnapshot, 0);
})();
</script>
{% endblock %}
