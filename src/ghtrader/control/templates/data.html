{% extends "base.html" %}

{% block content %}
{% set validation_schedule_hash = main_l5_validation.get("schedule_hash") %}
<div class="page page--ops page--data">
  <div class="page-head">
    <div>
      <div class="page-subtitle">Data Pipeline</div>
      <h2 class="page-title">Data Hub · {{ variety|upper }}</h2>
      <div class="muted text-sm">Main schedule → main_l5 only</div>
    </div>
    <div class="page-meta">
      {% if questdb.ok %}
        <span class="status-indicator status-indicator-ok">
          <span class="status-dot status-dot-ok"></span>QuestDB OK
        </span>
      {% else %}
        <span class="status-indicator status-indicator-error" title="{{ questdb.error or '' }}">
          <span class="status-dot status-dot-error"></span>QuestDB error
        </span>
      {% endif %}
      {% set hg_state = guardrails.health_gate_state if guardrails else "warn" %}
      <span class="status-indicator {% if hg_state == 'ok' %}status-indicator-ok{% else %}status-indicator-warn{% endif %}">
        <span class="status-dot {% if hg_state == 'ok' %}status-dot-ok{% else %}status-dot-warn{% endif %}"></span>
        Health gate {{ guardrails.health_gate_label if guardrails else "partial" }}
      </span>
      <span class="pill pill-running">running {{ running_count }}</span>
      <span class="pill pill-queued">queued {{ queued_count }}</span>
      <a class="btn btn-secondary btn-sm" href="{{ variety_path_prefix }}/jobs{{ token_qs }}">Jobs</a>
    </div>
  </div>

  {% if guardrails and (not guardrails.enforce_health_schedule or not guardrails.enforce_health_main_l5) %}
    <div class="alert-banner alert-warn">
      <div class="alert-banner-content">
        <div class="alert-banner-title">Health gate is partial</div>
        <div>Command success may not guarantee fully healthy persisted state for all steps. Consider enabling both schedule and main_l5 health checks.</div>
      </div>
    </div>
  {% endif %}
  {% if guardrails and (not guardrails.lock_force_cancel_on_timeout) %}
    <div class="alert-banner alert-warn">
      <div class="alert-banner-content">
        <div class="alert-banner-title">Auto-recovery for stale locks is off</div>
        <div>Queued jobs may keep waiting if prior owners are stuck. Enable lock preemption on timeout for self-healing behavior.</div>
      </div>
    </div>
  {% endif %}

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpiLabel">Running jobs</div>
      <div class="kpiValue">{{ running_count }}</div>
      <div class="kpiSubtext">Active data tasks</div>
    </div>
    <div class="kpi-card">
      <div class="kpiLabel">Queued jobs</div>
      <div class="kpiValue">{{ queued_count }}</div>
      <div class="kpiSubtext">Waiting for locks</div>
    </div>
    <div class="kpi-card">
      <div class="kpiLabel">Active locks</div>
      <div class="kpiValue">{{ locks | length }}</div>
      <div class="kpiSubtext">Concurrency guards</div>
    </div>
    <div class="kpi-card">
      <div class="kpiLabel">TqSdk parallelism</div>
      <div class="kpiValue">{{ tqsdk_scheduler.max_parallel }}</div>
      <div class="kpiSubtext">Source: {{ tqsdk_scheduler.source }}</div>
    </div>
  </div>

  <div class="card card--accent">
    <div class="card-title">
      <span>Pipeline flow</span>
      <small>Schedule → L5 → main_l5</small>
    </div>
    {% set schedule_state = (pipeline_health.get("schedule") or {}).get("state", "warn") %}
    {% set schedule_text = (pipeline_health.get("schedule") or {}).get("text", "KQ.m@ mapping") %}
    {% set main_l5_state = (pipeline_health.get("main_l5") or {}).get("state", "warn") %}
    {% set main_l5_text = (pipeline_health.get("main_l5") or {}).get("text", "per trading day") %}
    {% set validation_state = (pipeline_health.get("validation") or {}).get("state", "warn") %}
    {% set validation_text = (pipeline_health.get("validation") or {}).get("text", "not run") %}
    <div class="pipeline-flow">
      <div class="pipeline-step {% if schedule_state == 'ok' %}pipeline-step-ok{% elif schedule_state == 'error' %}pipeline-step-error{% else %}pipeline-step-warn{% endif %}">
        <div class="pipeline-step-icon">①</div>
        <div class="pipeline-step-label">Schedule</div>
        <div class="pipeline-step-status">{{ schedule_text }}</div>
      </div>
      <div class="pipeline-arrow"></div>
      <div class="pipeline-step {% if main_l5_state == 'ok' %}pipeline-step-ok{% elif main_l5_state == 'error' %}pipeline-step-error{% else %}pipeline-step-warn{% endif %}">
        <div class="pipeline-step-icon">②</div>
        <div class="pipeline-step-label">main_l5</div>
        <div class="pipeline-step-status">{{ main_l5_text }}</div>
      </div>
      <div class="pipeline-arrow"></div>
      <div class="pipeline-step {% if validation_state == 'ok' %}pipeline-step-ok{% elif validation_state == 'error' %}pipeline-step-error{% else %}pipeline-step-warn{% endif %}">
        <div class="pipeline-step-icon">③</div>
        <div class="pipeline-step-label">Validate</div>
        <div class="pipeline-step-status">{{ validation_text }}</div>
      </div>
      <div class="pipeline-arrow"></div>
      <div class="pipeline-step">
        <div class="pipeline-step-icon">④</div>
        <div class="pipeline-step-label">Use</div>
        <div class="pipeline-step-status">features/labels</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>Pipeline guardrails</span>
      <small>Current runtime defaults</small>
    </div>
    <div class="kv-list">
      <div class="kv-k">Health gate</div>
      <div class="kv-v">{{ "strict" if guardrails.health_gate_state == "ok" else "partial" }}</div>
      <div class="kv-k">main-schedule health</div>
      <div class="kv-v">{{ "on" if guardrails.enforce_health_schedule else "off" }}</div>
      <div class="kv-k">main_l5 health</div>
      <div class="kv-v">{{ "on" if guardrails.enforce_health_main_l5 else "off" }}</div>
      <div class="kv-k">Lock auto-recovery</div>
      <div class="kv-v">{{ "on" if guardrails.lock_force_cancel_on_timeout else "off" }}</div>
      <div class="kv-k">Lock wait timeout</div>
      <div class="kv-v">{{ "%.1f"|format(guardrails.lock_wait_timeout_s) }}s</div>
      <div class="kv-k">Lock poll interval</div>
      <div class="kv-v">{{ "%.1f"|format(guardrails.lock_poll_interval_s) }}s</div>
      <div class="kv-k">Preempt grace</div>
      <div class="kv-v">{{ "%.1f"|format(guardrails.lock_preempt_grace_s) }}s</div>
      <div class="kv-k">main_l5 worker mode</div>
      <div class="kv-v">{{ guardrails.main_l5_worker_mode }}</div>
      <div class="kv-k">main_l5 total workers</div>
      <div class="kv-v">{{ guardrails.main_l5_total_workers if guardrails.main_l5_total_workers > 0 else "auto" }}</div>
      <div class="kv-k">main_l5 segment workers</div>
      <div class="kv-v">{{ guardrails.main_l5_segment_workers if guardrails.main_l5_segment_workers > 0 else "auto" }}</div>
    </div>
  </div>

  <div class="split-pane">
    <div class="card" id="build">
      <div class="card-title">
        <span>Build Schedule</span>
        <small>KQ.m@ → underlying</small>
      </div>
      <p class="muted text-sm mb-2">Uses <span class="mono">{{ l5_start_env_key or l5_start_env_expected_key or "GHTRADER_L5_START_DATE" }}</span> → latest trading day.</p>
      <form class="form" method="post" action="/data/build/main_schedule{{ token_qs }}">
        <input type="hidden" name="start_date" value="{{ l5_start_date or '' }}"/>
        <input type="hidden" name="end_date" value="{{ latest_trading_day or '' }}"/>
        <div class="grid3">
          <div><label>Variety</label><input name="variety" value="{{ variety }}"/></div>
          <div><label>L5 start (env)</label><input value="{{ l5_start_date or '' }}" readonly/></div>
          <div><label>End (latest trading day)</label><input value="{{ latest_trading_day or '' }}" readonly/></div>
        </div>
        {% if l5_start_error %}
          <div class="hint">{{ l5_start_error }}</div>
        {% endif %}
        {% if l5_start_note %}
          <div class="hint">{{ l5_start_note }}</div>
        {% endif %}
        {% if latest_trading_error %}
          <div class="hint">{{ latest_trading_error }}</div>
        {% endif %}
        <div class="hint">Health gate: {{ "on" if guardrails.enforce_health_schedule else "off" }}</div>
        <div class="grid2">
          <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        </div>
        <button type="submit">Build Schedule</button>
      </form>
    </div>

    <div class="card">
      <div class="card-title">
        <span>Build main_l5</span>
        <small>Schedule-driven backfill</small>
      </div>
      <p class="muted text-sm mb-2">Download per-day L5 from the schedule and write main_l5 in QuestDB.</p>
      <form class="form" method="post" action="/data/build/main_l5{{ token_qs }}">
        <div class="grid2">
          <div><label>Variety</label><input name="variety" value="{{ variety }}"/></div>
          <div><label>Derived symbol</label><input name="derived_symbol" value="KQ.m@SHFE.{{ variety }}"/></div>
        </div>
        <div class="grid2">
          <div><label>Data dir</label><input name="data_dir" value="data"/></div>
          <div>
            <label><input type="checkbox" name="update_mode" value="1"/> Update only missing days</label>
            <div class="hint">Skips days already present when schedule hash matches.</div>
          </div>
        </div>
        <div class="hint">
          Health gate: {{ "on" if guardrails.enforce_health_main_l5 else "off" }} ·
          Worker budget: {{ guardrails.main_l5_worker_mode }}
        </div>
        <button type="submit">Build main_l5</button>
      </form>
      <div class="card-title card-title-spaced">
        <span>Coverage watermark</span>
        <small>QuestDB</small>
      </div>
      <div class="kv-list">
        <div class="kv-k">main_l5 symbol</div><div class="kv-v">{{ coverage_symbol }}</div>
        <div class="kv-k">main_l5 last day</div><div class="kv-v">{{ main_l5_coverage.last_day or "--" }}</div>
        <div class="kv-k">main_l5 last ts</div><div class="kv-v">{{ main_l5_coverage.last_ts or "--" }}</div>
        <div class="kv-k">main_l5 days</div><div class="kv-v">{{ main_l5_coverage.n_days or "--" }}</div>
        <div class="kv-k">schedule last day</div><div class="kv-v">{{ main_schedule_coverage.last_day or "--" }}</div>
        <div class="kv-k">schedule days</div><div class="kv-v">{{ main_schedule_coverage.n_days or "--" }}</div>
        <div class="kv-k">schedule hash</div>
        <div class="kv-v">
          {% if main_schedule_coverage.schedule_hashes %}
            {{ main_schedule_coverage.schedule_hashes | join(", ") }}
          {% else %}
            --
          {% endif %}
        </div>
      </div>
      {% if coverage_error %}
        <div class="hint">{{ coverage_error }}</div>
      {% endif %}
    </div>
  </div>

  <div class="card" id="validate">
    <div class="card-title">
      <span>Validate main_l5</span>
      <small>Session coverage + per-second checks</small>
    </div>
    <p class="muted text-sm mb-2">Writes a report under <span class="mono">runs/control/reports/main_l5_validate/</span>.</p>
    <form class="form" id="mainL5ValidateForm">
      <div class="grid3">
        <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
        <div><label>Variety</label><input name="variety" value="{{ variety }}"/></div>
        <div><label>Derived symbol</label><input name="derived_symbol" value="KQ.m@SHFE.{{ variety }}"/></div>
      </div>
      <div class="grid3">
        <div><label>Start (optional)</label><input name="start" placeholder="YYYY-MM-DD"/></div>
        <div><label>End (optional)</label><input name="end" placeholder="YYYY-MM-DD"/></div>
        <div>
          <label><input type="checkbox" name="tqsdk_check" value="1" checked/> Check TqSdk source</label>
          <div class="hint">Limited to a small number of gaps.</div>
        </div>
      </div>
      <div class="grid3">
        <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        <div><label>Runs dir</label><input name="runs_dir" value="runs"/></div>
        <div>
          <label><input type="checkbox" name="incremental" value="1"/> Incremental (new days only)</label>
          <div class="hint">Uses last validated day for current schedule hash; no-op if up-to-date.</div>
        </div>
      </div>
      <details>
        <summary>Advanced options (optional)</summary>
        <div class="grid3">
          <div><label>Gap threshold s</label><input name="gap_threshold_s" placeholder="e.g. 5"/></div>
          <div><label>Strict ratio</label><input name="strict_ratio" placeholder="e.g. 0.8"/></div>
          <div><label>Max segments/day</label><input name="max_segments_per_day" placeholder="e.g. 200"/></div>
        </div>
        <div class="grid3">
          <div><label>TqSdk check max days</label><input name="tqsdk_check_max_days" placeholder="e.g. 2"/></div>
          <div><label>TqSdk check max segments</label><input name="tqsdk_check_max_segments" placeholder="e.g. 8"/></div>
          <div class="hint">Per-session and half-second dual-threshold policies use runtime env config.</div>
        </div>
      </details>
      <button type="submit">Validate main_l5</button>
    </form>
    {% if validation_profile_suggestion %}
      <div class="hint mt-2">
        <span class="mono">{{ validation_profile_suggestion.label }}</span> ·
        {{ validation_profile_suggestion.note }}
        <button
          type="button"
          class="btn btn-secondary btn-sm"
          id="applyValidationProfileBtn"
          data-gap-threshold-s="{{ validation_profile_suggestion.gap_threshold_s }}"
          data-strict-ratio="{{ validation_profile_suggestion.strict_ratio }}"
          data-max-segments-per-day="{{ validation_profile_suggestion.max_segments_per_day }}"
        >
          Apply suggested params
        </button>
      </div>
    {% endif %}
    {% set validation_status = (main_l5_validation.get("status") or "warn") %}
    {% if validation_status == "error" %}
      <div class="alert-banner alert-error">
        <div class="alert-banner-content">
          <div class="alert-banner-title">Validation is blocking</div>
          <div>Latest run is in <span class="mono">error</span> state. Check gaps and report before using the dataset.</div>
        </div>
      </div>
    {% elif validation_status == "warn" %}
      <div class="alert-banner alert-warn">
        <div class="alert-banner-content">
          <div class="alert-banner-title">Validation needs attention</div>
          <div>Latest run is in <span class="mono">warn</span> state. Review half-second and gap thresholds before training.</div>
        </div>
      </div>
    {% endif %}
    <div class="card-title card-title-spaced">
      <span>Data readiness</span>
      <small>Engineering · Source · Policy</small>
    </div>
    {% set eng_state = main_l5_validation.get("engineering_state") or "warn" %}
    {% set src_state = main_l5_validation.get("source_state") or "warn" %}
    {% set pol_state = main_l5_validation.get("policy_state") or "warn" %}
    {% set ov_state = main_l5_validation.get("overall_state") or main_l5_validation.get("state") or "warn" %}
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpiLabel">Overall</div>
        <div class="kpiValue">{{ ov_state }}</div>
        <div class="kpiSubtext">reason {{ main_l5_validation.get("reason_code") or "--" }}</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Engineering</div>
        <div class="kpiValue">{{ eng_state }}</div>
        <div class="kpiSubtext">write/lock/session integrity</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Source</div>
        <div class="kpiValue">{{ src_state }}</div>
        <div class="kpiSubtext">provider availability</div>
      </div>
      <div class="kpi-card">
        <div class="kpiLabel">Policy</div>
        <div class="kpiValue">{{ pol_state }}</div>
        <div class="kpiSubtext">threshold risk profile</div>
      </div>
    </div>
    {% if main_l5_validation.get("action_hint") %}
      <div class="hint mt-2">Next action: {{ main_l5_validation.get("action_hint") }}</div>
    {% endif %}
    {% if (main_l5_validation.get("source_missing_days_count") or 0) > 0 %}
      <div class="hint mt-2">
        Source-missing days: {{ main_l5_validation.get("source_missing_days_count") }} ·
        tolerance {{ main_l5_validation.get("source_missing_days_tolerance") or 0 }} ·
        sample {{ (main_l5_validation.get("missing_days_sample") or [])[:5] | join(", ") }}
      </div>
    {% endif %}
    <div class="card-title card-title-spaced">
      <span>Validation summary</span>
      <small>Latest report</small>
    </div>
    <div class="kv-list">
      <div class="kv-k">Status</div>
      <div class="kv-v">
        {% set vs = main_l5_validation.get("status") or "warn" %}
        <span class="status-indicator {% if vs == 'ok' %}status-indicator-ok{% elif vs == 'error' %}status-indicator-error{% else %}status-indicator-warn{% endif %}">
          <span class="status-dot {% if vs == 'ok' %}status-dot-ok{% elif vs == 'error' %}status-dot-error{% else %}status-dot-warn{% endif %}"></span>
          {{ (main_l5_validation.get("status_label") or vs) }}
        </span>
      </div>
      <div class="kv-k">Run state</div><div class="kv-v">{{ main_l5_validation.get("state") or "--" }}</div>
      <div class="kv-k">Reason code</div><div class="kv-v">{{ main_l5_validation.get("reason_code") or "--" }}</div>
      <div class="kv-k">Action hint</div><div class="kv-v">{{ main_l5_validation.get("action_hint") or "--" }}</div>
      <div class="kv-k">Last validate</div><div class="kv-v">{{ main_l5_validation.last_run or "--" }}</div>
      <div class="kv-k">Last day</div><div class="kv-v">{{ main_l5_validation.last_day or "--" }}</div>
      <div class="kv-k">Checked days</div><div class="kv-v">{{ main_l5_validation.checked_days or "--" }}</div>
      <div class="kv-k">Cadence mode</div><div class="kv-v">{{ main_l5_validation.cadence_mode or "--" }}</div>
      <div class="kv-k">Two+ ticks ratio</div><div class="kv-v">{{ ("%.3f" | format(main_l5_validation.get("two_plus_ratio"))) if main_l5_validation.get("two_plus_ratio") is not none else "--" }}</div>
      <div class="kv-k">Missing days</div>
      <div class="kv-v">
        {% if main_l5_validation.checked_days %}
          {{ main_l5_validation.missing_days or 0 }} / {{ main_l5_validation.checked_days }}
        {% else %}
          --
        {% endif %}
      </div>
      <div class="kv-k">Missing segments</div>
      <div class="kv-v">
        {% if main_l5_validation.total_segments %}
          {{ main_l5_validation.missing_segments_total or 0 }} / {{ main_l5_validation.total_segments }}
        {% else %}
          {{ main_l5_validation.missing_segments_total or "--" }}
        {% endif %}
      </div>
      <div class="kv-k">Missing seconds ratio</div>
      <div class="kv-v">
        {% if main_l5_validation.get("missing_seconds_ratio") is not none %}
          {{ "%.4f" | format(main_l5_validation.get("missing_seconds_ratio")) }}
        {% else %}
          --
        {% endif %}
      </div>
      <div class="kv-k">Seconds with 1 tick</div><div class="kv-v">{{ main_l5_validation.seconds_with_one_tick_total or "--" }}</div>
      <div class="kv-k">Outside-session secs</div><div class="kv-v">{{ main_l5_validation.ticks_outside_sessions_seconds_total or "--" }}</div>
      <div class="kv-k">Missing half-seconds</div>
      <div class="kv-v">
        {% if main_l5_validation.expected_seconds_strict_fixed_total %}
          {{ main_l5_validation.missing_half_seconds_total or 0 }} / {{ main_l5_validation.expected_seconds_strict_fixed_total }}
        {% elif main_l5_validation.expected_seconds_strict_total %}
          {{ main_l5_validation.missing_half_seconds_total or 0 }} / {{ main_l5_validation.expected_seconds_strict_total }}
        {% else %}
          {{ main_l5_validation.missing_half_seconds_total or "--" }}
        {% endif %}
      </div>
      <div class="kv-k">Half-second policy</div>
      <div class="kv-v">
        {% set hs = main_l5_validation.get("missing_half_seconds_state") or "ok" %}
        <span class="status-indicator {% if hs == 'ok' %}status-indicator-ok{% elif hs == 'error' %}status-indicator-error{% else %}status-indicator-warn{% endif %}">
          <span class="status-dot {% if hs == 'ok' %}status-dot-ok{% elif hs == 'error' %}status-dot-error{% else %}status-dot-warn{% endif %}"></span>
          {{ hs }}
        </span>
        {% if main_l5_validation.get("missing_half_seconds_ratio") is not none %}
          · ratio {{ "%.4f"|format(main_l5_validation.get("missing_half_seconds_ratio")) }}
        {% endif %}
        {% if main_l5_validation.get("missing_half_seconds_info_ratio") is not none %}
          · info {{ "%.4f"|format(main_l5_validation.get("missing_half_seconds_info_ratio")) }}
        {% endif %}
        {% if main_l5_validation.get("missing_half_seconds_block_ratio") is not none %}
          · block {{ "%.4f"|format(main_l5_validation.get("missing_half_seconds_block_ratio")) }}
        {% endif %}
      </div>
      <div class="kv-k">Gap buckets</div>
      <div class="kv-v">
        {% set buckets = main_l5_validation.get("gap_buckets_total") or {} %}
        {% if buckets %}
          2-5s {{ buckets.get("2_5") or 0 }},
          6-15s {{ buckets.get("6_15") or 0 }},
          16-30s {{ buckets.get("16_30") or 0 }},
          >30s {{ buckets.get("gt_30") or 0 }}
        {% else %}
          --
        {% endif %}
      </div>
      <div class="kv-k">Timeliness p95 lag (s)</div><div class="kv-v">{{ main_l5_validation.p95_lag_s or "--" }}</div>
      <div class="kv-k">Timeliness max lag (s)</div><div class="kv-v">{{ main_l5_validation.max_lag_s or "--" }}</div>
      <div class="kv-k">Gaps >30s</div><div class="kv-v">{{ main_l5_validation.gap_count_gt_30s or "--" }}</div>
      <div class="kv-k">Max gap (s)</div><div class="kv-v">{{ main_l5_validation.max_gap_s or "--" }}</div>
      <div class="kv-k">Gap threshold (s)</div><div class="kv-v">{{ main_l5_validation.gap_threshold_s or "--" }}</div>
      <div class="kv-k">Gap threshold by session</div>
      <div class="kv-v">
        {% set gbs = main_l5_validation.get("gap_threshold_s_by_session") or {} %}
        {% if gbs %}
          {% if gbs.get("day") is not none %}day {{ gbs.get("day") }}{% endif %}
          {% if gbs.get("night") is not none %}
            {% if gbs.get("day") is not none %}, {% endif %}night {{ gbs.get("night") }}
          {% endif %}
        {% else %}
          --
        {% endif %}
      </div>
      <div class="kv-k">TqSdk missing segs</div>
      <div class="kv-v">{{ (main_l5_validation.get("tqsdk_check") or {}).get("provider_missing_segments") or "--" }}</div>
      <div class="kv-k">Source missing days</div>
      <div class="kv-v">
        {{ main_l5_validation.get("source_missing_days_count") or 0 }}
        {% if main_l5_validation.get("source_missing_days_tolerance") is not none %}
          (tol {{ main_l5_validation.get("source_missing_days_tolerance") }})
        {% endif %}
      </div>
    </div>
    <div class="card-title card-title-spaced">
      <span>Effective policy</span>
      <small>Value + source</small>
    </div>
    {% set psrc = main_l5_validation.get("policy_sources") or {} %}
    <div class="kv-list">
      <div class="kv-k">Gap threshold source</div><div class="kv-v">{{ psrc.get("gap_threshold_s") or "--" }}</div>
      <div class="kv-k">Strict ratio source</div><div class="kv-v">{{ psrc.get("strict_ratio") or "--" }}</div>
      <div class="kv-k">Gap block source</div><div class="kv-v">{{ psrc.get("gap_block_gt30") or "--" }}</div>
      <div class="kv-k">Half info source</div><div class="kv-v">{{ psrc.get("missing_half_info_ratio") or "--" }}</div>
      <div class="kv-k">Half block source</div><div class="kv-v">{{ psrc.get("missing_half_block_ratio") or "--" }}</div>
      <div class="kv-k">Source blocking source</div><div class="kv-v">{{ psrc.get("source_blocking") or "--" }}</div>
      <div class="kv-k">Source tolerance source</div><div class="kv-v">{{ psrc.get("source_missing_days_tolerance") or "--" }}</div>
    </div>
    <div class="card-title card-title-spaced">
      <span>Top gap days</span>
      <small>By max gap</small>
    </div>
    {% if main_l5_validation.top_gap_days %}
      <ul class="list-compact">
        {% for row in main_l5_validation.top_gap_days %}
          <li>
            <span class="mono">{{ row.trading_day }}</span>
            <span class="muted text-xs">max {{ row.max_gap_s }}s · segs {{ row.missing_segments }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-title">No gap days</div>
        <div class="empty-state-text">No max-gap rows available yet.</div>
      </div>
    {% endif %}
    <div class="card-title card-title-spaced">
      <span>Top lag days</span>
      <small>By session end lag</small>
    </div>
    {% if main_l5_validation.top_lag_days %}
      <ul class="list-compact">
        {% for row in main_l5_validation.top_lag_days %}
          <li>
            <span class="mono">{{ row.trading_day }}</span>
            <span class="muted text-xs">lag {{ row.session_end_lag_s }}s · max gap {{ row.max_gap_s }}</span>
            <a class="mono" href="/api/data/main-l5-validate-gaps?exchange=SHFE&var={{ coverage_var }}&symbol={{ coverage_symbol }}{% if validation_schedule_hash %}&schedule_hash={{ validation_schedule_hash }}{% endif %}&trading_day={{ row.trading_day }}&min_duration_s=30{{ token_qs | replace('?', '&') }}">gaps</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="empty-state">
        <div class="empty-state-title">No lag days</div>
        <div class="empty-state-text">No lag metrics available yet.</div>
      </div>
    {% endif %}
    {% if main_l5_validation.report_name %}
      <a class="btn btn-secondary btn-sm" href="/data/main-l5-validate/report/{{ main_l5_validation.report_name }}{{ token_qs }}">View report</a>
    {% endif %}
    <a class="btn btn-secondary btn-sm" href="/api/data/main-l5-validate-gaps?exchange=SHFE&var={{ coverage_var }}&symbol={{ coverage_symbol }}{% if validation_schedule_hash %}&schedule_hash={{ validation_schedule_hash }}{% endif %}{{ token_qs | replace('?', '&') }}">View gaps</a>
    <a class="btn btn-secondary btn-sm" href="/api/data/main-l5-validate-gaps?exchange=SHFE&var={{ coverage_var }}&symbol={{ coverage_symbol }}{% if validation_schedule_hash %}&schedule_hash={{ validation_schedule_hash }}{% endif %}&min_duration_s=30{{ token_qs | replace('?', '&') }}">View gaps &gt;30s</a>
    {% if validation_error %}
      <div class="hint">{{ validation_error }}</div>
    {% endif %}
  </div>

  <div class="card">
    <div class="card-title">
      <span>Manual L5 start probe</span>
      <small>Write report + copy env line</small>
    </div>
    <p class="muted text-sm mb-2">Runs a probe job and writes a report under <span class="mono">runs/control/reports/l5_start/</span>.</p>
    <form class="form" id="l5StartForm">
      <div class="grid3">
        <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
        <div><label>Variety</label><input name="variety" value="{{ variety }}"/></div>
        <div>
          <label><input type="checkbox" name="refresh_catalog" value="1"/> Refresh catalog</label>
          <div class="hint">Force TqSdk catalog refresh (network)</div>
        </div>
      </div>
      <button type="submit">Probe L5 start</button>
    </form>
  </div>

  <div class="split-pane split-pane-2-1">
    <div class="card">
      <div class="card-title">
        <span>QuestDB</span>
        <small>PGWire + ILP</small>
      </div>
      <div class="kv-list">
        <div class="kv-k">Host</div><div class="kv-v">{{ questdb.host or "--" }}</div>
        <div class="kv-k">PG port</div><div class="kv-v">{{ questdb.pg_port or "--" }}</div>
        <div class="kv-k">ILP port</div><div class="kv-v">{{ questdb.ilp_port or "--" }}</div>
        <div class="kv-k">Dataset</div><div class="kv-v">main_l5 ({{ dataset_version }})</div>
      </div>
      {% if questdb.error %}
        <div class="muted text-sm mt-3">{{ questdb.error }}</div>
      {% endif %}
    </div>

    <div class="card">
      <div class="card-title">
        <span>Active locks</span>
        <small>{{ locks | length }}</small>
      </div>
      {% if locks %}
        <ul class="list-compact">
          {% for lk in locks %}
            <li>
              <span class="mono">{{ lk.key }}</span>
              <span class="muted text-xs">job {{ lk.job_id }} · pid {{ lk.pid }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="empty-state">
          <div class="empty-state-title">No active locks</div>
          <div class="empty-state-text">Nothing is blocking schedule or main_l5 jobs right now.</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const form = document.getElementById("l5StartForm");
    if (!form) return;
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      const exchange = String(form.querySelector('input[name="exchange"]')?.value || "SHFE").trim();
      const variety = String(form.querySelector('input[name="variety"]')?.value || "{{ variety }}").trim();
      const refresh = form.querySelector('input[name="refresh_catalog"]')?.checked || false;
      try {
        const res = await window.ghTrader.withButtonBusy(
          submitBtn,
          () =>
            window.ghTrader.postJson("/api/data/enqueue-l5-start", {
              exchange,
              var: variety,
              refresh_catalog: refresh,
            }),
          { loadingText: "Queueing..." }
        );
        const id = (res.enqueued && res.enqueued.length > 0) ? res.enqueued[0] : "";
        if (id) {
          window.location.href = window.ghTrader.withToken(`/jobs/${id}?var={{ variety }}`);
        } else {
          window.ghTrader.toast("L5-start probe queued", "success");
        }
      } catch (e) {
        window.ghTrader.toast(e && e.message ? e.message : "Failed to enqueue L5-start probe", "error");
      }
    });
  })();
  (function() {
    const form = document.getElementById("mainL5ValidateForm");
    if (!form) return;
    const applyBtn = document.getElementById("applyValidationProfileBtn");
    if (applyBtn) {
      applyBtn.addEventListener("click", () => {
        const gap = String(applyBtn.dataset.gapThresholdS || "").trim();
        const strict = String(applyBtn.dataset.strictRatio || "").trim();
        const maxSeg = String(applyBtn.dataset.maxSegmentsPerDay || "").trim();
        const gapInput = form.querySelector('input[name="gap_threshold_s"]');
        const strictInput = form.querySelector('input[name="strict_ratio"]');
        const maxSegInput = form.querySelector('input[name="max_segments_per_day"]');
        if (gapInput && gap) gapInput.value = gap;
        if (strictInput && strict) strictInput.value = strict;
        if (maxSegInput && maxSeg) maxSegInput.value = maxSeg;
        window.ghTrader.toast("Validation profile applied", "success");
      });
    }
    form.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const submitBtn = form.querySelector('button[type="submit"]');
      const exchange = String(form.querySelector('input[name="exchange"]')?.value || "SHFE").trim();
      const variety = String(form.querySelector('input[name="variety"]')?.value || "{{ variety }}").trim();
      const derivedSymbol = String(form.querySelector('input[name="derived_symbol"]')?.value || "").trim();
      const start = String(form.querySelector('input[name="start"]')?.value || "").trim();
      const end = String(form.querySelector('input[name="end"]')?.value || "").trim();
      const dataDir = String(form.querySelector('input[name="data_dir"]')?.value || "data").trim();
      const runsDir = String(form.querySelector('input[name="runs_dir"]')?.value || "runs").trim();
      const tqsdkCheck = form.querySelector('input[name="tqsdk_check"]')?.checked || false;
      const incremental = form.querySelector('input[name="incremental"]')?.checked || false;
      const gapThreshold = String(form.querySelector('input[name="gap_threshold_s"]')?.value || "").trim();
      const strictRatio = String(form.querySelector('input[name="strict_ratio"]')?.value || "").trim();
      const maxSegmentsPerDay = String(form.querySelector('input[name="max_segments_per_day"]')?.value || "").trim();
      const tqsdkCheckMaxDays = String(form.querySelector('input[name="tqsdk_check_max_days"]')?.value || "").trim();
      const tqsdkCheckMaxSegments = String(form.querySelector('input[name="tqsdk_check_max_segments"]')?.value || "").trim();
      const payload = {
        exchange,
        var: variety,
        derived_symbol: derivedSymbol,
        start: start || undefined,
        end: end || undefined,
        data_dir: dataDir,
        runs_dir: runsDir,
        tqsdk_check: tqsdkCheck,
        incremental: incremental,
      };
      if (gapThreshold) payload.gap_threshold_s = gapThreshold;
      if (strictRatio) payload.strict_ratio = strictRatio;
      if (maxSegmentsPerDay) payload.max_segments_per_day = maxSegmentsPerDay;
      if (tqsdkCheckMaxDays) payload.tqsdk_check_max_days = tqsdkCheckMaxDays;
      if (tqsdkCheckMaxSegments) payload.tqsdk_check_max_segments = tqsdkCheckMaxSegments;
      try {
        const res = await window.ghTrader.withButtonBusy(
          submitBtn,
          () => window.ghTrader.postJson("/api/data/enqueue-main-l5-validate", payload),
          { loadingText: "Queueing..." }
        );
        const id = (res.enqueued && res.enqueued.length > 0) ? res.enqueued[0] : "";
        if (id) {
          window.location.href = window.ghTrader.withToken(`/jobs/${id}?var={{ variety }}`);
        } else {
          window.ghTrader.toast("main_l5 validation queued", "success");
        }
      } catch (e) {
        window.ghTrader.toast(e && e.message ? e.message : "Failed to enqueue main_l5 validation", "error");
      }
    });
  })();
</script>
{% endblock %}
