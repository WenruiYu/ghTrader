{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Data Hub</h2>
    <div class="section-header-actions">
      <a href="/jobs{{ token_qs }}" class="btn btn-sm btn-secondary">View All Jobs</a>
      <span class="pill">Contracts <span class="badge" id="contractsBadge">--</span></span>
    </div>
  </div>

  <!-- Status Bar -->
  <div class="card card-compact">
    <div class="grid3">
      <div class="flex items-center gap-2">
        <div class="kpiLabel">Running</div>
        <div class="kpiValue" style="font-size:24px;" id="dataRunningCount">{{ running_count }}</div>
      </div>
      <div class="flex items-center gap-2">
        <div class="kpiLabel">Queued</div>
        <div class="kpiValue" style="font-size:24px;" id="dataQueuedCount">{{ queued_count }}</div>
      </div>
      <div class="flex items-center gap-2">
        <div class="status-indicator {% if questdb and questdb.ok %}status-indicator-ok{% else %}status-indicator-error{% endif %}">
          <span class="status-dot {% if questdb and questdb.ok %}status-dot-ok{% else %}status-dot-error{% endif %}"></span>
          <span>QuestDB: {% if questdb and questdb.ok %}connected{% else %}offline{% endif %}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-nav">
    <button class="tab-nav-item active" data-tab="contracts">Contracts</button>
    <button class="tab-nav-item" data-tab="ingest">Ingest</button>
    <button class="tab-nav-item" data-tab="build">Build</button>
    <button class="tab-nav-item" data-tab="integrity">Integrity</button>
    <button class="tab-nav-item" data-tab="quality">Quality</button>
    <button class="tab-nav-item" data-tab="locks">
      Locks
      {% if locks and locks|length > 0 %}<span class="badge">{{ locks|length }}</span>{% endif %}
    </button>
  </div>

  <!-- Contracts (QuestDB-first) -->
  <div class="tab-content active" id="tab-contracts">
    <div class="card">
      <div class="section-header mb-2">
        <h3 class="mb-0">Contract Explorer</h3>
        <div class="muted text-sm">TqSdk catalog + QuestDB index + completeness</div>
      </div>

      <div class="alert-banner alert-warn mb-3" id="contractsQuestdbBanner" style="display:none;">
        <div class="alert-banner-icon">!</div>
        <div class="alert-banner-content">
          <div class="alert-banner-title">QuestDB unreachable</div>
          <div class="muted text-sm" id="contractsQuestdbBannerText">--</div>
          <div class="muted text-xs">DB-dependent actions are disabled until QuestDB is reachable.</div>
        </div>
      </div>

      <!-- Overview (coverage) - collapsible -->
      <div class="card" style="margin-bottom:12px;">
        <div class="section-header mb-2" style="margin-bottom:8px;">
          <h4 class="mb-0">Overview (coverage)</h4>
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="btn btn-sm btn-secondary" id="coverageToggleBtn" title="Show/hide coverage summary for ticks, main_l5, features, and labels">Show</button>
            <button type="button" class="btn btn-sm btn-secondary" id="coverageRefreshBtn" style="display:none;" title="Reload coverage data from QuestDB">Refresh</button>
            <span class="muted text-xs" id="coverageUpdatedAt">--</span>
          </div>
        </div>
        <div id="coveragePanel" style="display:none;">
          <div class="kpi-grid mb-3">
            <div class="kpi-card">
              <div class="kpiLabel">Raw Tick Symbols</div>
              <div class="kpiValue" id="covTicksCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covTicksRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">main_l5 Symbols</div>
              <div class="kpiValue" id="covMainL5Count">--</div>
              <div class="kpiSubtext mono text-xs" id="covMainL5Range">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Features Built</div>
              <div class="kpiValue" id="covFeaturesCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covFeaturesRange">--</div>
            </div>
            <div class="kpi-card">
              <div class="kpiLabel">Labels Built</div>
              <div class="kpiValue" id="covLabelsCount">--</div>
              <div class="kpiSubtext mono text-xs" id="covLabelsRange">--</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Scope selectors -->
      <div class="grid2 mb-3">
        <div>
          <label class="text-sm">Exchange</label>
          <select id="contractsExchange" class="form-control">
            <option value="SHFE" selected>SHFE</option>
          </select>
        </div>
        <div>
          <label class="text-sm">Variety</label>
          <select id="contractsVar" class="form-control">
            <option value="cu" selected>cu (Copper)</option>
            <option value="au">au (Gold)</option>
            <option value="ag">ag (Silver)</option>
          </select>
        </div>
      </div>

      <!-- Workflow Stepper Card (PRD-aligned) -->
      <div class="card" style="margin-bottom:12px; background:var(--bg-secondary);">
        <div class="section-header mb-2">
          <h4 class="mb-0">Workflow Steps</h4>
          <div class="muted text-xs">Complete steps in order for reliable data management</div>
        </div>

        <div class="workflow-stepper">
          <!-- Step 0: Refresh -->
          <div class="workflow-step" id="step0">
            <div class="workflow-step-header">
              <span class="workflow-step-num">0</span>
              <span class="workflow-step-title">Refresh Snapshot</span>
              <button type="button" id="contractsRefreshBtn" class="btn btn-sm" title="Rebuild cached contracts snapshot from catalog and QuestDB index">Refresh</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Load/refresh the contracts list from TqSdk catalog and QuestDB index.
            </div>
            <div class="workflow-step-status text-xs" id="step0Status">--</div>
          </div>

          <!-- Step 1: Health -->
          <div class="workflow-step" id="step1">
            <div class="workflow-step-header">
              <span class="workflow-step-num">1</span>
              <span class="workflow-step-title">Health Check</span>
              <button type="button" id="contractsHealthBtn" class="btn btn-sm btn-secondary" title="Run diagnose + auto-repair (index bootstrap + missing-days backfill)">Health</button>
              <button type="button" id="contractsRepairBtn" class="btn btn-sm btn-secondary" title="Run auto-only repair from the latest diagnose report (if available)">Repair</button>
              <button type="button" id="indexBootstrapBtn" class="btn btn-sm btn-secondary" title="Bootstrap QuestDB symbol-day index from ticks table (optional)">Bootstrap Index</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Diagnose data integrity and auto-repair what is safe (index bootstrap + missing-days backfill). Use Bootstrap Index if you want an explicit manual index rebuild.
            </div>
            <div class="workflow-step-status text-xs" id="step1Status">
              <span id="indexHealthStatus">--</span>
            </div>
          </div>

          <!-- Step 2: Update All -->
          <div class="workflow-step" id="step2">
            <div class="workflow-step-header">
              <span class="workflow-step-num">2</span>
              <span class="workflow-step-title">Update All</span>
              <button type="button" id="contractsUpdateAllBtn" class="btn btn-sm btn-secondary" title="Forward-fill active contracts and recently expired (last 10 days) from TqSdk">Update All</button>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Daily forward-fill for active + recently expired contracts (last 10 days).
            </div>
            <div class="workflow-step-status text-xs" id="step2Status">--</div>
          </div>

          <!-- Step 3: Build Schedule -->
          <div class="workflow-step" id="step3">
            <div class="workflow-step-header">
              <span class="workflow-step-num">3</span>
              <span class="workflow-step-title">Build Schedule</span>
              <form method="post" action="/data/build/main_schedule{{ token_qs }}" style="display:inline;">
                <input type="hidden" name="variety" id="workflowScheduleVar" value="cu"/>
                <input type="hidden" name="start_date" value="{{ default_schedule_start }}"/>
                <input type="hidden" name="end_date" value="{{ default_schedule_end }}"/>
                <input type="hidden" name="threshold" value="1.1"/>
                <input type="hidden" name="data_dir" value="data"/>
                <button type="submit" class="btn btn-sm btn-secondary" title="Compute OI-based main contract roll schedule">Build Schedule</button>
              </form>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Compute main contract roll schedule based on open interest.
            </div>
            <div class="workflow-step-status text-xs" id="step3Status">--</div>
          </div>

          <!-- Step 4: Build main_l5 -->
          <div class="workflow-step" id="step4">
            <div class="workflow-step-header">
              <span class="workflow-step-num">4</span>
              <span class="workflow-step-title">Build main_l5</span>
              <form method="post" action="/data/build/main_l5{{ token_qs }}" style="display:inline;">
                <input type="hidden" name="variety" id="workflowMainL5Var" value="cu"/>
                <input type="hidden" name="derived_symbol" id="workflowMainL5Symbol" value="KQ.m@SHFE.cu"/>
                <input type="hidden" name="data_dir" value="data"/>
                <input type="hidden" name="overwrite" value="false"/>
                <button type="submit" class="btn btn-sm btn-secondary" title="Materialize continuous L5 ticks from underlying contracts">Build main_l5</button>
              </form>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Materialize continuous main contract with L5 depth from underlying specific contracts.
            </div>
            <div class="workflow-step-status text-xs" id="step4Status">--</div>
          </div>

          <!-- Step 5: Build Features/Labels -->
          <div class="workflow-step" id="step5">
            <div class="workflow-step-header">
              <span class="workflow-step-num">5</span>
              <span class="workflow-step-title">Build Features/Labels</span>
              <form method="post" action="/data/build/build{{ token_qs }}" style="display:inline;">
                <input type="hidden" name="symbol" id="workflowBuildSymbol" value="KQ.m@SHFE.cu"/>
                <input type="hidden" name="horizons" value="10,50,200"/>
                <input type="hidden" name="threshold_k" value="1"/>
                <input type="hidden" name="ticks_kind" value="main_l5"/>
                <input type="hidden" name="overwrite" value="false"/>
                <input type="hidden" name="data_dir" value="data"/>
                <button type="submit" class="btn btn-sm btn-secondary" title="Compute causal features and multi-horizon labels">Build</button>
              </form>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Compute causal features and multi-horizon labels from tick data.
            </div>
            <div class="workflow-step-status text-xs" id="step5Status">--</div>
          </div>

          <!-- Step 6: Train Model -->
          <div class="workflow-step" id="step6">
            <div class="workflow-step-header">
              <span class="workflow-step-num">6</span>
              <span class="workflow-step-title">Train Model</span>
              <a href="/models{{ token_qs }}" class="btn btn-sm btn-secondary" title="Go to Models page to train models">Train</a>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Train models on features/labels (see Models page).
            </div>
            <div class="workflow-step-status text-xs" id="step6Status">--</div>
          </div>

          <!-- Step 7: Backtest/Trade -->
          <div class="workflow-step" id="step7">
            <div class="workflow-step-header">
              <span class="workflow-step-num">7</span>
              <span class="workflow-step-title">Backtest/Trade</span>
              <a href="/trading{{ token_qs }}" class="btn btn-sm btn-secondary" title="Go to Trading page for backtesting or live trading">Trade</a>
            </div>
            <div class="workflow-step-desc text-xs muted">
              Run backtests or start live trading (see Trading page).
            </div>
            <div class="workflow-step-status text-xs" id="step7Status">--</div>
          </div>
        </div>

        <!-- Advanced Options (collapsible) -->
        <div style="margin-top:12px;">
          <button type="button" class="btn btn-sm btn-secondary" id="advancedToggleBtn" title="Show/hide date overrides and latest reports">Advanced Options</button>
        </div>
        <div id="advancedPanel" style="display:none; margin-top:12px;">
          <!-- Compute L5 Start (metadata helper, not a main pipeline step) -->
          <div class="card mb-3" style="background:var(--bg-tertiary);">
            <div class="section-header mb-2">
              <h4 class="mb-0">Compute L5 Start (Metadata)</h4>
            </div>
            <div class="text-sm muted mb-2">
              Compute the first L5-available trading day for each symbol. This metadata is used by main_l5 builds to know where to start.
            </div>
            <button type="button" id="toolsL5StartBtn" class="btn btn-sm btn-secondary" title="Compute first L5 day for each symbol (for main_l5 builds)">Compute L5 Start</button>
          </div>

          <div class="grid3 mb-3">
            <div>
              <label class="text-sm">Start date (optional)</label>
              <input id="toolsStart" type="date" />
            </div>
            <div>
              <label class="text-sm">End date (optional)</label>
              <input id="toolsEnd" type="date" />
            </div>
            <div style="display:flex; align-items:flex-end; gap:16px;">
              <label style="margin:0; display:flex; align-items:center; gap:8px;" title="When checked, fetch latest contract catalog from TqSdk before running job (requires network)">
                <input type="checkbox" id="toolsRefreshCatalog" />
                <span class="text-sm">Refresh catalog from TqSdk</span>
              </label>
            </div>
          </div>

          <div class="grid3 mb-3">
            <div>
              <label style="margin:0; display:flex; align-items:center; gap:8px;" title="When checked, revalidate all partitions (ignore incremental cache)">
                <input type="checkbox" id="toolsForceFullScan" />
                <span class="text-sm">Force full scan</span>
              </label>
            </div>
            <div class="muted text-sm" style="display:flex; align-items:center;">
              <span>Use when you need a clean revalidation.</span>
            </div>
            <div></div>
          </div>

          <div class="grid3 mb-3">
            <div>
              <label class="text-sm">Thoroughness</label>
              <select id="toolsThoroughness" class="form-control">
                <option value="quick">quick</option>
                <option value="standard">standard</option>
                <option value="comprehensive" selected>comprehensive</option>
              </select>
            </div>
            <div>
              <label class="text-sm">Check workers (0=auto)</label>
              <input id="toolsCheckWorkers" type="number" min="0" max="256" value="0" />
            </div>
            <div>
              <label class="text-sm">Download workers (0=auto)</label>
              <input id="toolsDownloadWorkers" type="number" min="0" max="16" value="0" />
            </div>
          </div>

          <div class="grid3 mb-3">
            <div>
              <label class="text-sm">Chunk days</label>
              <input id="toolsChunkDays" type="number" min="1" max="60" value="5" />
            </div>
            <div class="muted text-sm" style="display:flex; align-items:flex-end;">
              <span>Higher workers = faster, more load.</span>
            </div>
            <div class="muted text-sm" style="display:flex; align-items:flex-end;">
              <span>Smaller chunk days = more resilient.</span>
            </div>
          </div>

          <div class="grid3">
            <div class="card">
              <h4 class="mb-2">Latest Diagnose Report</h4>
              <div class="muted text-sm" id="toolsDiagnoseMeta">Not loaded.</div>
              <pre class="mono text-xs" id="toolsDiagnoseJson" style="white-space:pre-wrap; margin-top:8px;">--</pre>
            </div>
            <div class="card">
              <h4 class="mb-2">Latest Repair Report</h4>
              <div class="muted text-sm" id="toolsRepairMeta">Not loaded.</div>
              <pre class="mono text-xs" id="toolsRepairJson" style="white-space:pre-wrap; margin-top:8px;">--</pre>
            </div>
            <div class="card">
              <h4 class="mb-2">Latest L5-start Report</h4>
              <div class="muted text-sm" id="toolsL5Meta">Not loaded.</div>
              <pre class="mono text-xs" id="toolsL5Json" style="white-space:pre-wrap; margin-top:8px;">--</pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Search and filter -->
      <div class="grid3 mb-3">
        <div>
          <label class="text-sm">Search</label>
          <input id="contractsSearch" placeholder="e.g. cu1601, 2602" />
        </div>
        <div>
          <label class="text-sm">Filter</label>
          <select id="contractsActiveFilter" class="form-control">
            <option value="all" selected>all contracts</option>
            <option value="active">active only</option>
            <option value="expired">expired only</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <label style="margin:0; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="contractsOnlyMissing" />
            <span class="text-sm">missing/stale only</span>
          </label>
        </div>
      </div>

      <!-- Status bar -->
      <div class="action-bar card-no-margin" style="margin-bottom:12px;">
        <span class="action-bar-title" id="contractsStatus">Click Refresh to load contracts.</span>
      </div>
    </div>

    <div class="tableWrap">
      <table class="table table-compact" id="contractsTable">
        <thead>
          <tr>
            <th>Contract</th>
            <th>Active</th>
            <th>Status</th>
            <th>Expected</th>
            <th>Present</th>
            <th>Missing</th>
            <th>No-data</th>
            <th>Last tick</th>
            <th>L5 start</th>
          </tr>
        </thead>
        <tbody id="contractsTbody">
          <tr><td colspan="9" class="muted">Click Refresh to load.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Quality (QuestDB-first; field nulls + gaps + outliers) -->
  <div class="tab-content" id="tab-quality">
    <div class="card">
      <div class="section-header mb-2">
        <h3 class="mb-0">Quality</h3>
        <div class="muted text-sm">Field null rates • Intraday gaps • Outliers</div>
      </div>

      <div class="kpi-grid mb-3">
        <div class="kpi-card">
          <div class="kpiLabel">Completeness</div>
          <div class="kpiValue" id="qKpiCompleteness">--</div>
          <div class="kpiSubtext mono text-xs" id="qKpiCompletenessSub">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpiLabel">Field Quality</div>
          <div class="kpiValue" id="qKpiFieldQuality">--</div>
          <div class="kpiSubtext mono text-xs" id="qKpiFieldQualitySub">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpiLabel">Anomalies (latest)</div>
          <div class="kpiValue" id="qKpiAnomalies">--</div>
          <div class="kpiSubtext mono text-xs" id="qKpiAnomaliesSub">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpiLabel">Freshness (active)</div>
          <div class="kpiValue" id="qKpiFreshness">--</div>
          <div class="kpiSubtext mono text-xs" id="qKpiFreshnessSub">--</div>
        </div>
      </div>

      <div class="action-bar card-no-margin" style="margin-bottom:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button type="button" class="btn btn-sm" id="qualityRefreshBtn" title="Refresh quality summary (cached 60s)">Refresh</button>
        <button type="button" class="btn btn-sm btn-secondary" id="qualityDiagnoseBtn" title="Enqueue a diagnose job for this scope">Run Diagnose</button>
        <span class="muted text-xs" id="qualityStatus">--</span>
        <span class="muted text-xs" id="qualityUpdatedAt">--</span>
      </div>

      <div class="grid3 mb-3">
        <div>
          <label class="text-sm">Search</label>
          <input id="qualitySearch" placeholder="e.g. cu2602" />
        </div>
        <div>
          <label class="text-sm">Limit</label>
          <select id="qualityLimit" class="form-control">
            <option value="100">100</option>
            <option value="300" selected>300</option>
            <option value="500">500</option>
          </select>
        </div>
        <div style="display:flex; align-items:flex-end; gap:8px;">
          <label style="margin:0; display:flex; align-items:center; gap:8px;">
            <input type="checkbox" id="qualityOnlyIssues" />
            <span class="text-sm">issues only</span>
          </label>
        </div>
      </div>

      <div class="split-pane">
        <div class="card" style="padding:0;">
          <div class="tableWrap">
            <table class="table table-compact" id="qualityTable">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Status</th>
                  <th>Missing</th>
                  <th>Quality</th>
                  <th>Anomalies</th>
                  <th>Last tick</th>
                </tr>
              </thead>
              <tbody id="qualityTbody">
                <tr><td colspan="6" class="muted">Click Refresh.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <h4 class="mb-2">Detail</h4>
          <div class="muted text-sm" id="qualityDetailMeta">Click a symbol to view detail.</div>
          <pre class="mono text-xs" id="qualityDetailJson" style="white-space:pre-wrap; margin-top:8px;">--</pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Ingest (from Ops) -->
  <div class="tab-content" id="tab-ingest">
    <div class="split-pane-2-1">
      <div>
        <div class="card">
          <h3 class="mb-2">Download Historical Data</h3>
          <form class="form" method="post" action="/data/ingest/download{{ token_qs }}">
            <div class="grid3">
              <div><label>Symbol</label><input name="symbol" placeholder="SHFE.cu2602"/></div>
              <div><label>Start date</label><input name="start_date" type="date"/></div>
              <div><label>End date</label><input name="end_date" type="date"/></div>
            </div>
            <div class="grid2">
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
              <div><label>Chunk days</label><input name="chunk_days" type="number" min="1" value="5"/></div>
            </div>
            <button type="submit">Start Download</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Download Contract Range</h3>
          <form class="form" method="post" action="/data/ingest/download_contract_range{{ token_qs }}">
            <div class="grid3">
              <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Chunk days</label><input name="chunk_days" type="number" min="1" value="5"/></div>
            </div>
            <div class="grid2">
              <div><label>Start contract (YYMM)</label><input name="start_contract" value="1601"/></div>
              <div><label>End contract</label><input name="end_contract" value="auto"/></div>
            </div>
            <div class="grid3">
              <div><label>Start date</label><input name="start_date" type="date" value="2015-01-01"/></div>
              <div><label>End date</label><input name="end_date" type="date"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Range Backfill</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Live Recorder</h3>
          <form class="form" method="post" action="/data/ingest/record{{ token_qs }}">
            <div class="grid2">
              <div><label>Symbols (comma-separated)</label><input name="symbols" placeholder="SHFE.cu2602,SHFE.au2602"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Recorder</button>
          </form>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">TqSdk Scheduler</h3>
          <p class="muted text-sm mb-2">
            Control how many <strong>TqSdk-heavy</strong> jobs the dashboard scheduler starts in parallel (download/record/update/data repair/data health).
            Changes apply immediately to queued jobs.
          </p>
          <form class="form" method="post" action="/data/settings/tqsdk_scheduler{{ token_qs }}">
            <div class="grid2">
              <div>
                <label>Max parallel jobs</label>
                <input name="max_parallel" type="number" min="1" max="64" value="{{ tqsdk_scheduler.max_parallel }}"/>
              </div>
              <div>
                <label>Persist</label>
                <select name="persist">
                  <option value="1" selected>yes (survive restart)</option>
                  <option value="0">no (runtime only)</option>
                </select>
              </div>
            </div>
            <button type="submit" class="btn btn-secondary" style="width:100%;">Apply</button>
          </form>
          <div class="muted text-xs" style="margin-top:10px;">
            Current source: <span class="mono">{{ tqsdk_scheduler.source }}</span>.
            Env: <span class="mono">{{ tqsdk_scheduler.env_value or "-" }}</span>.
            Persisted: <span class="mono">{% if tqsdk_scheduler.persisted_value is not none %}{{ tqsdk_scheduler.persisted_value }}{% else %}-{% endif %}</span>.
          </div>
          <div class="muted text-xs" style="margin-top:6px;">
            Settings file: <span class="mono">{{ tqsdk_scheduler.settings_path }}</span>
          </div>
        </div>

        <div class="card">
          <h3 class="mb-2">Ingest Tips</h3>
          <ul class="muted text-sm" style="padding-left:18px; margin:0;">
            <li style="margin-bottom:8px;"><strong>Symbol format:</strong> <code class="mono">EXCHANGE.instrumentYYMM</code> (e.g., SHFE.cu2602)</li>
            <li style="margin-bottom:8px;"><strong>Contract range:</strong> Use for bulk backfill of a variety (all cu contracts)</li>
            <li style="margin-bottom:8px;"><strong>Dataset:</strong> v2-only (trading-day partitioning)</li>
            <li style="margin-bottom:8px;"><strong>Chunk days:</strong> Smaller chunks = more resilient to interrupts</li>
            <li><strong>Live recorder:</strong> Subscribes to ticks and appends to QuestDB in real-time</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Running Ingest Jobs (moved from Pipeline tab) -->
    <div class="card" style="margin-top:12px;">
      <div class="section-header mb-2" style="align-items:center;">
        <h3 class="mb-0">Running Ingest Jobs</h3>
        <div class="flex gap-2">
          <button type="button" class="btn btn-sm btn-danger" id="cancelAllDownloadsBtn">Cancel all downloads</button>
        </div>
      </div>
      <div class="tableWrap">
        <table class="table table-compact" id="ingestJobsTable">
          <thead>
            <tr>
              <th>ID</th><th>Status</th><th>Kind</th><th>Current</th><th>Progress</th><th></th>
            </tr>
          </thead>
          <tbody id="ingestJobsBody">
            {% for s in ingest_statuses %}
              <tr>
                <td class="mono text-xs">{{ s.job_id[:8] }}</td>
                <td><span class="pill pill-{{ s.job_status }}">{{ s.job_status }}</span></td>
                <td class="mono">{{ s.kind }}</td>
                <td class="mono">
                  {% if s.kind == "download_contract_range" %}{{ s.current_symbol or "" }}
                  {% elif s.kind == "download" %}{{ s.symbol or "" }}
                  {% else %}{{ s.current_symbol or "" }}{% endif %}
                </td>
                <td>
                  {% if s.summary and s.summary.pct is not none %}
                    <div class="progressBar"><div style="width: {{ (s.summary.pct * 100) | round(1) }}%;"></div></div>
                    <div class="mono text-xs" style="margin-top:4px;">{{ (s.summary.pct * 100) | round(1) }}%</div>
                  {% else %}<span class="mono">-</span>{% endif %}
                </td>
                <td><a href="/jobs/{{ s.job_id }}{{ token_qs }}">View</a></td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="muted">No ingest jobs running</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tab: Build (from Ops) -->
  <div class="tab-content" id="tab-build">
    <div class="split-pane">
      <div>
        <div class="card">
          <h3 class="mb-2">Build Main Schedule</h3>
          <p class="muted text-sm mb-2">Compute roll schedule from QuestDB end-of-day OI data.</p>
          <form class="form" method="post" action="/data/build/main_schedule{{ token_qs }}">
            <div class="grid3">
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Start date</label><input name="start_date" value="{{ default_schedule_start }}"/></div>
              <div><label>End date</label><input name="end_date" value="{{ default_schedule_end }}"/></div>
            </div>
            <div class="grid2">
              <div><label>Threshold</label><input name="threshold" value="1.1"/></div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Build Schedule</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Build main_l5</h3>
          <p class="muted text-sm mb-2">Materialize continuous main contract with L5 depth from underlying specific contracts.</p>
          <form class="form" method="post" action="/data/build/main_l5{{ token_qs }}">
            <div class="grid2">
              <div><label>Variety</label><input name="variety" value="cu"/></div>
              <div><label>Derived symbol</label><input name="derived_symbol" value="KQ.m@SHFE.cu"/></div>
            </div>
            <div class="grid1">
              <div><label>Overwrite</label>
                <select name="overwrite"><option value="false" selected>false</option><option value="true">true</option></select>
              </div>
            </div>
            <button type="submit">Build main_l5</button>
          </form>
        </div>
      </div>

      <div>
        <div class="card">
          <h3 class="mb-2">Build Features & Labels</h3>
          <p class="muted text-sm mb-2">Compute causal features and multi-horizon labels from tick data.</p>
          <form class="form" method="post" action="/data/build/build{{ token_qs }}">
            <div class="grid2">
              <div><label>Symbol</label><input name="symbol" placeholder="KQ.m@SHFE.cu"/></div>
              <div><label>Ticks kind</label>
                <select name="ticks_kind"><option value="raw">raw</option><option value="main_l5" selected>main_l5</option></select>
              </div>
            </div>
            <div class="grid2">
              <div><label>Horizons (comma)</label><input name="horizons" value="10,50,200"/></div>
              <div><label>Threshold k</label><input name="threshold_k" value="1"/></div>
            </div>
            <div class="grid2">
              <div><label>Overwrite</label>
                <select name="overwrite"><option value="false" selected>false</option><option value="true">true</option></select>
              </div>
              <div><label>Data dir</label><input name="data_dir" value="data"/></div>
            </div>
            <button type="submit">Start Build</button>
          </form>
        </div>

        <div class="card">
          <h3 class="mb-2">Build Sequence</h3>
          <ol class="muted text-sm" style="padding-left:18px; margin:0;">
            <li style="margin-bottom:6px;">Sync raw ticks to QuestDB</li>
            <li style="margin-bottom:6px;">Compute main schedule (OI-based roll)</li>
            <li style="margin-bottom:6px;">Build main_l5 (continuous + L5 depth)</li>
            <li style="margin-bottom:6px;">Build features & labels</li>
            <li>Train models (see Models page)</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab: Integrity (from Ops) -->
  <div class="tab-content" id="tab-integrity">
    <div class="split-pane-2-1">
      <div class="card">
        <h3 class="mb-2">Run Audit</h3>
        <p class="muted text-sm mb-2">Verify checksums, schema conformity, and data integrity across datasets.</p>
        <form class="form" method="post" action="/data/integrity/audit{{ token_qs }}">
          <div class="grid2">
            <div>
              <label>Scopes</label>
              <select name="scopes" multiple size="6">
                <option value="all" selected>all</option>
                <option value="ticks">ticks</option>
                <option value="main_l5">main_l5</option>
                <option value="features">features</option>
                <option value="labels">labels</option>
                <option value="completeness">completeness</option>
              </select>
            </div>
            <div>
              <label>Data dir</label><input name="data_dir" value="data"/>
              <label>Runs dir</label><input name="runs_dir" value="runs"/>
              <div class="grid2" style="margin-top:10px;">
                <div>
                  <label class="text-sm">(completeness) Exchange</label>
                  <input name="exchange" value="SHFE"/>
                </div>
                <div>
                  <label class="text-sm">(completeness) Variety</label>
                  <input name="variety" value="cu"/>
                </div>
              </div>
              <label style="margin-top:8px; display:flex; align-items:center; gap:8px;">
                <input type="checkbox" name="refresh_catalog" value="true"/>
                <span class="text-sm">(completeness) Refresh catalog (network)</span>
              </label>
            </div>
          </div>
          <button type="submit">Run Audit</button>
        </form>
      </div>

      <div class="card">
        <h3 class="mb-2">Recent Audit Reports</h3>
        {% if reports and reports|length > 0 %}
          <ul style="list-style:none; padding:0; margin:0;">
            {% for r in reports[:10] %}
              <li style="margin-bottom:6px;"><a href="/data/integrity/report/{{ r }}{{ token_qs }}" class="mono text-sm">{{ r }}</a></li>
            {% endfor %}
          </ul>
          {% if reports|length > 10 %}
            <div class="muted text-sm" style="margin-top:8px;">+ {{ reports|length - 10 }} more</div>
          {% endif %}
        {% else %}
          <div class="muted">No audit reports found</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Tab: Locks (from Ops) -->
  <div class="tab-content" id="tab-locks">
    <div class="card">
      <h3 class="mb-2">Active Locks</h3>
      <p class="muted text-sm mb-2">Resource locks held across all sessions. Stale locks are reaped automatically on acquisition.</p>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead>
            <tr><th>Key</th><th>Job</th><th>PID</th><th>Created</th><th>Updated</th></tr>
          </thead>
          <tbody>
          {% for l in locks %}
            <tr>
              <td class="mono">{{ l.key }}</td>
              <td class="mono"><a href="/jobs/{{ l.job_id }}{{ token_qs }}">{{ l.job_id[:8] }}</a></td>
              <td class="mono">{{ l.pid }}</td>
              <td class="mono text-xs">{{ l.created_at }}</td>
              <td class="mono text-xs">{{ l.updated_at }}</td>
            </tr>
          {% else %}
            <tr><td colspan="5" class="muted">No active locks</td></tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h3 class="mb-2">Lock Keys Reference</h3>
      <div class="tableWrap">
        <table class="table table-compact">
          <thead><tr><th>Pattern</th><th>Command</th><th>Description</th></tr></thead>
          <tbody>
            <tr><td class="mono">ticks:symbol=X</td><td>download, record</td><td>Per-symbol tick ingest</td></tr>
            <tr><td class="mono">ticks_range:exchange=X,var=Y</td><td>download-contract-range</td><td>Variety-wide backfill</td></tr>
            <tr><td class="mono">build:symbol=X,ticks_kind=Y</td><td>build</td><td>Feature/label build</td></tr>
            <tr><td class="mono">train:symbol=X,model=M,h=H</td><td>train</td><td>Model training</td></tr>
            <tr><td class="mono">main_schedule:var=X</td><td>main-schedule</td><td>Schedule computation</td></tr>
            <tr><td class="mono">main_l5:symbol=X</td><td>main-l5</td><td>Derived dataset build</td></tr>
            <tr><td class="mono">trade:mode=X</td><td>trade</td><td>Trading execution</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

<style>
.workflow-stepper {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.workflow-step {
  background: var(--bg-primary);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 10px 12px;
}
.workflow-step-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
}
.workflow-step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  font-size: 11px;
  font-weight: 600;
}
.workflow-step-title {
  font-weight: 500;
  flex: 1;
}
.workflow-step-desc {
  margin-left: 32px;
  margin-bottom: 4px;
}
.workflow-step-status {
  margin-left: 32px;
  color: var(--muted);
}
.workflow-step-status .pill {
  font-size: 10px;
  padding: 1px 6px;
}
/* Pipeline flow styles (from ops) */
.pipeline-flow {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
  padding: 12px 0;
}
.pipeline-step {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.pipeline-step-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
}
.pipeline-step-label {
  font-size: 11px;
  color: var(--muted);
}
.pipeline-arrow {
  width: 24px;
  height: 2px;
  background: var(--border);
  position: relative;
}
.pipeline-arrow::after {
  content: "";
  position: absolute;
  right: 0;
  top: -3px;
  border: 4px solid transparent;
  border-left-color: var(--border);
}
</style>
{% endblock %}

{% block scripts %}
<script>
(function() {
  // Contract explorer logic
  const elExchange = document.getElementById("contractsExchange");
  const elVar = document.getElementById("contractsVar");
  const elSearch = document.getElementById("contractsSearch");
  const elActiveFilter = document.getElementById("contractsActiveFilter");
  const elOnlyMissing = document.getElementById("contractsOnlyMissing");
  const elStatus = document.getElementById("contractsStatus");
  const elTbody = document.getElementById("contractsTbody");
  const btnRefresh = document.getElementById("contractsRefreshBtn");
  const btnUpdateAll = document.getElementById("contractsUpdateAllBtn");
  const btnHealth = document.getElementById("contractsHealthBtn");
  const btnRepair = document.getElementById("contractsRepairBtn");
  const btnIndexBootstrap = document.getElementById("indexBootstrapBtn");
  const btnL5Start = document.getElementById("toolsL5StartBtn");
  const covToggleBtn = document.getElementById("coverageToggleBtn");
  const covRefreshBtn = document.getElementById("coverageRefreshBtn");
  const covPanel = document.getElementById("coveragePanel");
  const covUpdatedAt = document.getElementById("coverageUpdatedAt");
  const questdbBanner = document.getElementById("contractsQuestdbBanner");
  const questdbBannerText = document.getElementById("contractsQuestdbBannerText");

  let lastRows = [];
  let lastQuestdbOk = false;
  let lastCompleteness = null;
  let _latestDiagnoseReportPath = null;
  window._contractsLoaded = false;
  let _advancedLoaded = false;
  let _qualityLoaded = false;

  const _LS_ADVANCED_OPEN = "ghtrader:data:advanced_open";
  const _LS_COVERAGE_OPEN = "ghtrader:data:coverage_open";

  // Advanced panel elements
  const advancedToggleBtn = document.getElementById("advancedToggleBtn");
  const advancedPanel = document.getElementById("advancedPanel");
  const toolsStart = document.getElementById("toolsStart");
  const toolsEnd = document.getElementById("toolsEnd");
  const toolsRefreshCatalog = document.getElementById("toolsRefreshCatalog");
  const toolsForceFullScan = document.getElementById("toolsForceFullScan");
  const toolsThoroughness = document.getElementById("toolsThoroughness");
  const toolsCheckWorkers = document.getElementById("toolsCheckWorkers");
  const toolsDownloadWorkers = document.getElementById("toolsDownloadWorkers");
  const toolsChunkDays = document.getElementById("toolsChunkDays");
  const toolsDiagnoseMeta = document.getElementById("toolsDiagnoseMeta");
  const toolsDiagnoseJson = document.getElementById("toolsDiagnoseJson");
  const toolsRepairMeta = document.getElementById("toolsRepairMeta");
  const toolsRepairJson = document.getElementById("toolsRepairJson");
  const toolsL5Meta = document.getElementById("toolsL5Meta");
  const toolsL5Json = document.getElementById("toolsL5Json");

  // Step status elements
  const step0Status = document.getElementById("step0Status");
  const step1Status = document.getElementById("step1Status");
  const indexHealthStatus = document.getElementById("indexHealthStatus");
  const step2Status = document.getElementById("step2Status");
  const step3Status = document.getElementById("step3Status");

  // Workflow form hidden fields (for steps 3-5)
  const workflowScheduleVar = document.getElementById("workflowScheduleVar");
  const workflowMainL5Var = document.getElementById("workflowMainL5Var");
  const workflowMainL5Symbol = document.getElementById("workflowMainL5Symbol");
  const workflowBuildSymbol = document.getElementById("workflowBuildSymbol");

  // Sync workflow forms when scope changes
  function syncWorkflowForms() {
    const exchange = elExchange ? elExchange.value : "SHFE";
    const v = elVar ? elVar.value : "cu";
    if (workflowScheduleVar) workflowScheduleVar.value = v;
    if (workflowMainL5Var) workflowMainL5Var.value = v;
    if (workflowMainL5Symbol) workflowMainL5Symbol.value = "KQ.m@" + exchange + "." + v;
    if (workflowBuildSymbol) workflowBuildSymbol.value = "KQ.m@" + exchange + "." + v;
  }

  // Add change listeners for scope selectors
  if (elExchange) elExchange.addEventListener("change", syncWorkflowForms);
  if (elVar) elVar.addEventListener("change", syncWorkflowForms);
  syncWorkflowForms(); // Initial sync

  function toggleAdvanced(open) {
    if (!advancedPanel || !advancedToggleBtn) return;
    const isOpen = advancedPanel.style.display !== "none";
    const next = (open === true) ? true : ((open === false) ? false : !isOpen);
    advancedPanel.style.display = next ? "block" : "none";
    advancedToggleBtn.textContent = next ? "Hide Advanced" : "Advanced Options";
    _writeFlag(_LS_ADVANCED_OPEN, next);
    if (next && !_advancedLoaded) {
      _advancedLoaded = true;
      loadToolsReports();
    }
  }
  if (advancedToggleBtn) advancedToggleBtn.addEventListener("click", () => toggleAdvanced());
  if (_readFlag(_LS_ADVANCED_OPEN)) toggleAdvanced(true);

  function setStatus(msg) {
    elStatus.textContent = msg;
  }

  function esc(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function _readFlag(key) {
    try {
      return localStorage.getItem(key) === "1";
    } catch (e) {
      return false;
    }
  }

  function _writeFlag(key, val) {
    try {
      localStorage.setItem(key, val ? "1" : "0");
    } catch (e) {}
  }

  function _setUpdatedAt(el, ts) {
    if (!el) return;
    if (!ts) {
      el.textContent = "--";
      return;
    }
    try {
      el.textContent = "updated " + new Date(ts).toLocaleString();
    } catch (e) {
      el.textContent = "updated " + String(ts);
    }
  }

  function updateStepStatuses(body) {
    // Step 0: Refresh status
    const rows = body.contracts || [];
    const catSrc = body.catalog_source || "";
    const catAt = body.catalog_cached_at || "";
    if (step0Status) {
      step0Status.innerHTML = rows.length + " contracts" + (catAt ? (" • catalog: " + catAt) : "");
    }

    // Step 1: Index health
    const completeness = (body && body.completeness && body.completeness.summary) ? body.completeness.summary : null;
    lastCompleteness = completeness;
    if (indexHealthStatus) {
      if (!completeness) {
        indexHealthStatus.innerHTML = '<span class="muted">--</span>';
      } else {
        const indexed = completeness.symbols_indexed || 0;
        const total = completeness.symbols_total || 0;
        const unindexed = completeness.symbols_unindexed || 0;
        const healthy = completeness.index_healthy;
        if (healthy) {
          indexHealthStatus.innerHTML = '<span class="pill pill-succeeded">healthy</span> ' + indexed + '/' + total + ' indexed';
        } else {
          indexHealthStatus.innerHTML = '<span class="pill pill-running">needs bootstrap</span> ' + unindexed + '/' + total + ' unindexed';
        }
      }
    }

    // Step 2-3: generic status
    if (step2Status) step2Status.innerHTML = '<span class="muted">Click to run</span>';
    if (step3Status) step3Status.innerHTML = '<span class="muted">Click to run</span>';
  }

  function setCoverageKpi(data, countId, rangeId) {
    const countEl = document.getElementById(countId);
    const rangeEl = document.getElementById(rangeId);
    if (!countEl || !rangeEl) return;
    if (!data || data.ok === false) {
      countEl.textContent = "--";
      rangeEl.textContent = "--";
      return;
    }
    const n = (data.symbols !== undefined && data.symbols !== null) ? data.symbols : (data.count || 0);
    const min = String(data.min_day || "");
    const max = String(data.max_day || "");
    countEl.textContent = String(n ?? "--");
    rangeEl.textContent = (min || max) ? (min + " - " + max) : "--";
  }

  let _coverageLoaded = false;
  async function loadCoverageSummary(force) {
    if (_coverageLoaded && !force) return;
    _coverageLoaded = true;
    if (covRefreshBtn) covRefreshBtn.style.display = "inline-block";
    try {
      const url = "/api/data/coverage/summary" + (force ? "?refresh=1" : "");
      const resp = await window.ghTrader.fetchApi(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const body = await resp.json();
      if (!body || body.ok === false) throw new Error(body.error || body.detail || "failed");
      const summary = body.summary || {};
      setCoverageKpi(summary.ticks, "covTicksCount", "covTicksRange");
      setCoverageKpi(summary.main_l5, "covMainL5Count", "covMainL5Range");
      setCoverageKpi(summary.features, "covFeaturesCount", "covFeaturesRange");
      setCoverageKpi(summary.labels, "covLabelsCount", "covLabelsRange");
      _setUpdatedAt(covUpdatedAt, body.generated_at);
    } catch (e) {
      setCoverageKpi(null, "covTicksCount", "covTicksRange");
      setCoverageKpi(null, "covMainL5Count", "covMainL5Range");
      setCoverageKpi(null, "covFeaturesCount", "covFeaturesRange");
      setCoverageKpi(null, "covLabelsCount", "covLabelsRange");
      _setUpdatedAt(covUpdatedAt, null);
    }
  }

  function setCoverageOpen(open, persist) {
    if (!covToggleBtn || !covPanel) return;
    covPanel.style.display = open ? "block" : "none";
    covToggleBtn.textContent = open ? "Hide" : "Show";
    if (persist) _writeFlag(_LS_COVERAGE_OPEN, open);
    if (open) loadCoverageSummary(false);
  }

  if (covToggleBtn && covPanel) {
    covToggleBtn.addEventListener("click", () => {
      const open = covPanel.style.display !== "none";
      setCoverageOpen(!open, true);
    });
    if (_readFlag(_LS_COVERAGE_OPEN)) setCoverageOpen(true, false);
  }
  if (covRefreshBtn) {
    covRefreshBtn.addEventListener("click", () => loadCoverageSummary(true));
  }

  function fmtAgeSec(sec) {
    if (sec === null || sec === undefined) return "";
    const s = Math.max(0, Number(sec));
    if (!isFinite(s)) return "";
    const m = Math.round(s / 60);
    if (m < 60) return m + "m";
    const h = Math.floor(m / 60);
    const mm = m % 60;
    if (h < 24) return h + "h" + (mm ? (mm + "m") : "");
    const d = Math.floor(h / 24);
    const hh = h % 24;
    return d + "d" + (hh ? (hh + "h") : "");
  }

  function fmtTime(ts) {
    if (!ts) return "";
    try {
      return new Date(ts).toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    } catch (e) {
      return String(ts);
    }
  }

  function rowHtml(r) {
    const expired = r.expired;
    const active = (expired === false);

    const activeCell = active
      ? "<span class=\"pill pill-succeeded\">active</span>"
      : (expired === true ? "<span class=\"pill\">expired</span>" : "<span class=\"pill\">?</span>");

    // Status (QuestDB-first: status is authoritative)
    const st = String(r.status || "");
    let statusCell = "<span class=\"pill\">--</span>";
    if (st === "complete") statusCell = "<span class=\"pill pill-succeeded\">complete</span>";
    else if (st === "unindexed") statusCell = "<span class=\"pill pill-running\">unindexed</span>";
    else if (st === "missing" || st === "incomplete" || st === "not-downloaded") statusCell = "<span class=\"pill pill-running\">missing</span>";
    else if (st === "stale") statusCell = "<span class=\"pill pill-running\">stale</span>";
    else if (st === "unknown") statusCell = "<span class=\"pill\">unknown</span>";

    const qc = r.questdb_coverage || null;
    const comp = r.completeness || null;

    // Expected window
    let expectedCell = "<span class=\"muted\">--</span>";
    const ef = (comp && comp.expected_first) ? String(comp.expected_first) : String(r.expected_first || "");
    const el = (comp && comp.expected_last) ? String(comp.expected_last) : String(r.expected_last || "");
    const expDays = (comp && comp.expected_days !== null && comp.expected_days !== undefined)
      ? Number(comp.expected_days)
      : ((r.days_expected !== null && r.days_expected !== undefined) ? Number(r.days_expected) : null);
    if (ef || el) {
      const rng = (ef || "") + " - " + (el || "");
      const n = (expDays !== null && isFinite(expDays) && expDays > 0) ? (String(expDays) + "d") : "";
      expectedCell = [
        '<div class="mono text-xs">' + esc(rng) + "</div>",
        n ? ('<div class="muted text-xs">' + esc(n) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // Present days
    let presentCell = "<span class=\"muted\">--</span>";
    const presentDays = (comp && comp.present_days !== null && comp.present_days !== undefined)
      ? Number(comp.present_days)
      : ((r.days_present !== null && r.days_present !== undefined) ? Number(r.days_present) : null);
    let dbRangeDay = "";
    const qFirst = qc ? String(qc.first_tick_day || "") : "";
    const qLast = qc ? String(qc.last_tick_day || "") : "";
    if (qFirst && qLast) dbRangeDay = qFirst + " - " + qLast;
    else if (qLast) dbRangeDay = "last " + qLast;
    else if (qFirst) dbRangeDay = "first " + qFirst;
    else if (r.db_min || r.db_max) {
      const d0 = String(r.db_min || "");
      const d1 = String(r.db_max || "");
      if (d0 && d1) dbRangeDay = d0 + " - " + d1;
      else if (d1) dbRangeDay = "last " + d1;
      else if (d0) dbRangeDay = "first " + d0;
    }
    let tickDays = "";
    try {
      const td = (qc && qc.tick_days !== null && qc.tick_days !== undefined) ? Number(qc.tick_days) : 0;
      if (isFinite(td) && td > 0) tickDays = String(td);
    } catch (e) {}
    if ((presentDays !== null && isFinite(presentDays)) || dbRangeDay) {
      const dbLine = (dbRangeDay ? dbRangeDay : "--") + (tickDays ? (" • tick " + tickDays + "d") : "");
      presentCell = [
        "<div>" + esc((presentDays !== null && isFinite(presentDays)) ? (String(Math.max(0, presentDays)) + "d") : "--") + "</div>",
        dbLine ? ('<div class="mono text-xs">' + esc(dbLine) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // Missing + no-data
    let missingCell = "<span class=\"muted\">--</span>";
    let noDataCell = "<span class=\"muted\">--</span>";
    if (r.index_missing === true || (comp && comp.index_missing === true)) {
      missingCell = '<div class="muted">--</div><div class="muted text-xs">needs index</div>';
    } else if (comp && comp.missing_days !== undefined && comp.missing_days !== null) {
      const missN = String(comp.missing_days || 0);
      const missR = (comp.missing_first || comp.missing_last) ? ((comp.missing_first || "") + " - " + (comp.missing_last || "")) : "";
      missingCell = [
        "<div>" + esc(missN) + "</div>",
        missR ? ('<div class="mono text-xs">' + esc(missR) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    } else {
      const daysExpected = (expDays !== null && isFinite(expDays)) ? Number(expDays) : null;
      const daysDone = (r.days_done !== undefined && r.days_done !== null) ? Number(r.days_done) : null;
      if (daysExpected !== null && daysDone !== null) {
        const missingDays = Math.max(0, daysExpected - daysDone);
        missingCell = "<div>" + esc(String(missingDays)) + "</div>";
      }
    }
    const noDataDays = (comp && comp.no_data_days !== undefined && comp.no_data_days !== null) ? Number(comp.no_data_days) : 0;
    noDataCell = "<div>" + esc(String(noDataDays)) + "</div>";

    // Last tick
    let lastTickCell = "<span class=\"muted\">--</span>";
    const lastDay = String(r.db_max || "") || (qc ? String(qc.last_tick_day || "") : "");
    const lastTs = String(r.db_last_tick_ts || "") || (qc ? String(qc.last_tick_ts || "") : "");
    const lastTime = lastTs ? fmtTime(lastTs) : "";
    let lag = "";
    try {
      if (active && lastTs) lag = fmtAgeSec((Date.now() - Date.parse(lastTs)) / 1000.0);
    } catch (e) {}
    if (lastDay || lastTime) {
      lastTickCell = [
        '<div class="mono text-xs">' + esc(lastDay || "--") + "</div>",
        lastTime
          ? ('<div class="muted text-xs">last: ' + esc(lastTime) + (active && lag ? (" (lag " + esc(lag) + ")") : "") + "</div>")
          : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    // L5 start
    let l5Cell = "<span class=\"muted\">--</span>";
    const l5Start = qc ? String(qc.first_l5_day || "") : "";
    if (l5Start) {
      let l5Days = "";
      try {
        const ld = (qc && qc.l5_days !== null && qc.l5_days !== undefined) ? Number(qc.l5_days) : 0;
        if (isFinite(ld) && ld > 0) l5Days = String(ld) + "d";
      } catch (e) {}
      l5Cell = [
        '<div class="mono text-xs">' + esc(l5Start) + "</div>",
        l5Days ? ('<div class="muted text-xs">' + esc(l5Days) + "</div>") : '<div class="muted text-xs">--</div>',
      ].join("");
    }

    return [
      "<tr data-symbol=\"" + r.symbol + "\">",
        "<td class=\"mono\">" + esc(r.symbol) + "</td>",
        "<td>" + activeCell + "</td>",
        "<td>" + statusCell + "</td>",
        "<td class=\"mono text-xs\">" + expectedCell + "</td>",
        "<td class=\"mono text-xs\">" + presentCell + "</td>",
        "<td>" + missingCell + "</td>",
        "<td>" + noDataCell + "</td>",
        "<td class=\"mono text-xs\">" + lastTickCell + "</td>",
        "<td class=\"mono text-xs\">" + l5Cell + "</td>",
      "</tr>"
    ].join("");
  }

  let _contractsReqSeq = 0;

  async function fetchContracts(opts) {
    opts = opts || {};
    const ex = elExchange.value;
    const v = elVar.value;
    const refresh = opts.refresh ? "1" : "0";
    const url = window.ghTrader.withToken(
      "/api/contracts?mode=cache&exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&refresh=" + refresh
    );
    const label = String(opts.label || (opts.refresh ? "Refreshing contracts..." : "Loading contracts..."));
    const timeoutMs = Number(opts.timeoutMs || 30000);
    const controller = new AbortController();
    const startedAt = Date.now();
    const tick = setInterval(() => {
      const s = Math.floor((Date.now() - startedAt) / 1000);
      setStatus(label + " (" + s + "s)");
    }, 1000);
    const to = setTimeout(() => controller.abort(), timeoutMs);
    try {
      setStatus(label + " (0s)");
      const resp = await window.ghTrader.fetchApi(url, { signal: controller.signal });
      const body = await resp.json();
      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }
      if (body && body.ok === false && String(body.error || "") === "contracts_snapshot_building") {
        return body;
      }
      if (!body || body.ok !== true) {
        const err = (body && (body.error || body.detail)) ? String(body.error || body.detail) : ("HTTP " + resp.status);
        if (String(err).toLowerCase().includes("catalog_cache_missing_or_stale") || String(err).toLowerCase().includes("cache_missing")) {
          throw new Error("Catalog cache missing. Click Refresh to fetch catalog (requires network + TQSDK creds).");
        }
        throw new Error(err);
      }
      return body;
    } catch (e) {
      if (String(e && e.name) === "AbortError") {
        throw new Error("Timed out after " + Math.round(timeoutMs / 1000) + "s");
      }
      throw e;
    } finally {
      clearInterval(tick);
      clearTimeout(to);
    }
  }

  let _contractsPollTimer = null;
  function stopContractsPolling() {
    if (_contractsPollTimer) {
      clearTimeout(_contractsPollTimer);
      _contractsPollTimer = null;
    }
  }

  function setDbDependentDisabled(disabled) {
    [
      btnHealth,
      btnRepair,
      btnUpdateAll,
      btnIndexBootstrap,
      btnL5Start,
      covRefreshBtn,
      qRefreshBtn,
      qDiagnoseBtn,
    ].forEach((el) => {
      if (el) el.disabled = !!disabled;
    });
  }

  function applyContractsBody(body) {
    const rows = body.contracts || [];
    window._contractsLoaded = true;
    document.getElementById("contractsBadge").textContent = rows.length;
    if (!rows.length) {
      elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">No contracts returned.</td></tr>";
      setStatus("No contracts returned.");
      return;
    }
    lastRows = rows;
    lastQuestdbOk = !!(body.questdb && body.questdb.ok);

    // Disable DB-dependent actions when QuestDB is offline
    setDbDependentDisabled(!lastQuestdbOk);

    if (questdbBanner) {
      if (body.questdb && body.questdb.ok === false) {
        questdbBanner.style.display = "flex";
        const err = (body.questdb && body.questdb.error) ? String(body.questdb.error) : "";
        if (questdbBannerText) questdbBannerText.textContent = err ? err : "QuestDB connection failed";
      } else {
        questdbBanner.style.display = "none";
      }
    }

    renderRows();
    updateStepStatuses(body);

    const meta = [];
    const catSrc = (body.catalog_source || body.catalog_source === "") ? String(body.catalog_source) : "";
    const catAt = body.catalog_cached_at ? String(body.catalog_cached_at) : "";
    const catOk = (body.catalog_ok === true);
    if (catSrc || catAt) meta.push("catalog " + (catSrc || "--") + (catAt ? (" @" + catAt) : "") + (catOk ? "" : " (stale)"));
    if (body.questdb && body.questdb.ok === true) meta.push("QuestDB ok");
    else meta.push("QuestDB offline");
    if (body.snapshot_cached_at || body.local_checked_at || body.generated_at) meta.push("checked " + String(body.snapshot_cached_at || body.local_checked_at || body.generated_at));
    if (body.timings_ms && body.timings_ms.total !== undefined) meta.push("t=" + String(body.timings_ms.total) + "ms");
    setStatus("Loaded " + rows.length + " contracts" + (meta.length ? (" — " + meta.join(" • ")) : ""));
  }

  function pollForSnapshot(opts) {
    opts = opts || {};
    const reqId = opts.reqId;
    const prevSnap = Number(opts.prevSnapshotUnix || 0);
    const label = String(opts.label || "Updating contracts snapshot...");
    const startedAt = Date.now();
    const maxWaitMs = Number(opts.maxWaitMs || 120000);
    const silent = !!opts.silent;

    stopContractsPolling();
    const tick = async () => {
      if (reqId !== _contractsReqSeq) return;
      const waited = Date.now() - startedAt;
      if (waited > maxWaitMs) {
        if (!silent) setStatus("Timed out waiting for snapshot update.");
        return;
      }
      try {
        const body = await fetchContracts({ refresh: false, timeoutMs: 10000, label: label });
        if (reqId !== _contractsReqSeq) return;
        if (body && body.ok === true) {
          const curSnap = Number(body.snapshot_cached_at_unix || 0);
          if (!prevSnap || (curSnap && curSnap > prevSnap)) {
            applyContractsBody(body);
            return;
          }
        }
      } catch (e) {
        // Best-effort polling
      }
      _contractsPollTimer = setTimeout(tick, 2000);
    };
    _contractsPollTimer = setTimeout(tick, 1200);
  }

  function renderRows() {
    const q = String(elSearch.value || "").trim().toLowerCase();
    const activeMode = String(elActiveFilter.value || "all");
    const missingOnly = !!elOnlyMissing.checked;
    const rows = (lastRows || []).filter((r) => {
      const sym = String((r && r.symbol) || "").toLowerCase();
      if (q && sym.indexOf(q) < 0) return false;
      const isActive = (r && r.expired === false);
      if (activeMode === "active" && !isActive) return false;
      if (activeMode === "expired" && isActive) return false;
      if (missingOnly) {
        const st = String((r && r.status) || "");
        if (st === "complete") return false;
      }
      return true;
    });
    if (!rows.length) {
      elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">No matching contracts.</td></tr>";
      return;
    }
    elTbody.innerHTML = rows.map(rowHtml).join("");
  }

  async function refreshTable(opts) {
    const reqId = ++_contractsReqSeq;
    try {
      stopContractsPolling();
      const body = await fetchContracts(opts);
      if (reqId !== _contractsReqSeq) return;
      if (body && body.ok === false && String(body.error || "") === "contracts_snapshot_building") {
        const hasTable = Array.isArray(lastRows) && lastRows.length > 0;
        if (!hasTable) {
          elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">Building contracts snapshot...</td></tr>";
        }
        const jobId = (body.snapshot_job && body.snapshot_job.job_id) ? String(body.snapshot_job.job_id) : "";
        setStatus("Building contracts snapshot..." + (jobId ? (" (" + jobId + ")") : ""));
        pollForSnapshot({ reqId, prevSnapshotUnix: 0, label: "Building contracts snapshot...", silent: true });
        return;
      }

      applyContractsBody(body);

      const prevSnap = Number(body.snapshot_cached_at_unix || 0);
      if (opts && opts.refresh) {
        pollForSnapshot({ reqId, prevSnapshotUnix: prevSnap, label: "Refreshing contracts snapshot...", silent: false });
      } else if (body && body.cache_stale) {
        pollForSnapshot({ reqId, prevSnapshotUnix: prevSnap, label: "Updating contracts snapshot...", silent: true });
      }
    } catch (e) {
      if (reqId !== _contractsReqSeq) return;
      const msg = String(e.message || e);
      const hasTable = Array.isArray(lastRows) && lastRows.length > 0;
      if (!hasTable) {
        elTbody.innerHTML = "<tr><td colspan=\"9\" class=\"muted\">Failed to load contracts.</td></tr>";
      }
      if (questdbBanner) questdbBanner.style.display = "none";
      if (!opts || !opts.silent) {
        setStatus("Error: " + msg + (hasTable ? " — still showing cached results" : ""));
      }
      if (opts && opts.refresh) {
        window.ghTrader.toast("Failed to refresh contracts: " + msg, "error");
      } else if (!hasTable) {
        window.ghTrader.toast("Failed to load contracts: " + msg, "error");
      }
    }
  }

  async function loadContractsSnapshot() {
    await refreshTable({ refresh: false, timeoutMs: 10000, label: "Loading contracts..." });
  }

  // Step 0: Refresh
  btnRefresh.addEventListener("click", () => {
    refreshTable({ refresh: true, timeoutMs: 10000, label: "Refreshing contracts..." });
  });

  // Step 1: Index Bootstrap
  if (btnIndexBootstrap) {
    btnIndexBootstrap.addEventListener("click", async () => {
      try {
        setStatus("Enqueuing index bootstrap job...");
        const body = await window.ghTrader.postJson("/api/data/enqueue-index-bootstrap", { exchange: elExchange.value, var: elVar.value, force: true });
        if (body.ok === false) {
          throw new Error(body.error || body.message || "failed");
        }
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Index bootstrap job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Index bootstrap job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // Step 4: Update All
  btnUpdateAll.addEventListener("click", async () => {
    try {
      setStatus("Enqueuing update job...");
      const body = await window.ghTrader.postJson("/api/contracts/enqueue-update", { exchange: elExchange.value, var: elVar.value, recent_expired_days: 10, refresh_catalog: true });
      const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
      setStatus("Update job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
      window.ghTrader.toast("Update job enqueued", "success");
    } catch (e) {
      setStatus("Error: " + String(e.message || e));
      window.ghTrader.toast("Failed: " + e.message, "error");
    }
  });

  // Step 5: Compute L5 Start
  if (btnL5Start) {
    btnL5Start.addEventListener("click", async () => {
      try {
        setStatus("Enqueuing L5-start job...");
        const start = toolsStart ? toolsStart.value : "";
        const end = toolsEnd ? toolsEnd.value : "";
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        const body = await window.ghTrader.postJson("/api/data/enqueue-l5-start", { exchange: elExchange.value, var: elVar.value, start: start, end: end, refresh_catalog: refresh });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("L5-start job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("L5-start job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  const renderRowsDebounced = window.ghTrader.debounce(renderRows, 120);
  elSearch.addEventListener("input", () => renderRowsDebounced());

  function onScopeChanged() {
    _advancedLoaded = false;
    _qualityLoaded = false;
    stopContractsPolling();
    window._contractsLoaded = false;
    lastRows = [];
    renderRows();
    refreshTable({ refresh: false, timeoutMs: 10000, label: "Loading contracts..." });
    if (advancedPanel && advancedPanel.style.display !== "none") loadToolsReports();
    const qPane = document.getElementById("tab-quality");
    if (qPane && qPane.classList.contains("active")) loadQualitySummary(false);
  }
  elExchange.addEventListener("change", () => onScopeChanged());
  elVar.addEventListener("change", () => onScopeChanged());
  elActiveFilter.addEventListener("change", () => renderRowsDebounced());
  elOnlyMissing.addEventListener("change", () => renderRowsDebounced());

  // -------------------------------------------------------------------------
  // Quality tab (QuestDB-first ledgers)
  // -------------------------------------------------------------------------

  const qRefreshBtn = document.getElementById("qualityRefreshBtn");
  const qDiagnoseBtn = document.getElementById("qualityDiagnoseBtn");
  const qStatus = document.getElementById("qualityStatus");
  const qUpdatedAt = document.getElementById("qualityUpdatedAt");
  const qSearch = document.getElementById("qualitySearch");
  const qLimit = document.getElementById("qualityLimit");
  const qOnlyIssues = document.getElementById("qualityOnlyIssues");
  const qTbody = document.getElementById("qualityTbody");
  const qDetailMeta = document.getElementById("qualityDetailMeta");
  const qDetailJson = document.getElementById("qualityDetailJson");

  const qKpiCompleteness = document.getElementById("qKpiCompleteness");
  const qKpiCompletenessSub = document.getElementById("qKpiCompletenessSub");
  const qKpiFieldQuality = document.getElementById("qKpiFieldQuality");
  const qKpiFieldQualitySub = document.getElementById("qKpiFieldQualitySub");
  const qKpiAnomalies = document.getElementById("qKpiAnomalies");
  const qKpiAnomaliesSub = document.getElementById("qKpiAnomaliesSub");
  const qKpiFreshness = document.getElementById("qKpiFreshness");
  const qKpiFreshnessSub = document.getElementById("qKpiFreshnessSub");

  function setQualityStatus(msg) {
    if (qStatus) qStatus.textContent = msg || "--";
  }

  function fmtPct(x) {
    if (x === null || x === undefined) return "--";
    const n = Number(x);
    if (!isFinite(n)) return "--";
    return n.toFixed(1) + "%";
  }

  function fmtAgeSec(sec) {
    if (sec === null || sec === undefined) return "--";
    const s = Number(sec);
    if (!isFinite(s)) return "--";
    if (s < 60) return Math.round(s) + "s";
    if (s < 3600) return Math.round(s / 60) + "m";
    return (s / 3600).toFixed(1) + "h";
  }

  function pillForStatus(st) {
    const s = String(st || "");
    if (s === "error") return '<span class="pill pill-failed">error</span>';
    if (s === "warning") return '<span class="pill pill-running">warning</span>';
    if (s === "ok") return '<span class="pill pill-succeeded">ok</span>';
    return '<span class="pill">--</span>';
  }

  async function loadQualitySummary(force) {
    if (!qTbody) return;
    if (_qualityLoaded && !force) return;
    _qualityLoaded = true;
    const ex = elExchange.value;
    const v = elVar.value;
    const q = (qSearch && qSearch.value) ? String(qSearch.value).trim() : "";
    const lim = qLimit && qLimit.value ? Number(qLimit.value) : 300;
    const onlyIssues = !!(qOnlyIssues && qOnlyIssues.checked);
    setQualityStatus("Loading...");
    try {
      const refresh = force ? "1" : "0";
      const url = window.ghTrader.withToken(
        "/api/data/quality-summary?exchange=" + encodeURIComponent(ex) +
        "&var=" + encodeURIComponent(v) +
        "&limit=" + encodeURIComponent(String(lim || 300)) +
        "&search=" + encodeURIComponent(q) +
        "&issues_only=" + encodeURIComponent(String(onlyIssues)) +
        "&refresh=" + encodeURIComponent(refresh)
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));

      const k = body.kpis || {};
      if (qKpiCompleteness) qKpiCompleteness.textContent = fmtPct(k.completeness_pct);
      if (qKpiCompletenessSub) qKpiCompletenessSub.textContent = ex + "." + v;
      if (qKpiFieldQuality) qKpiFieldQuality.textContent = fmtPct(k.field_quality_pct);
      if (qKpiFieldQualitySub) qKpiFieldQualitySub.textContent = (body.sources && body.sources.field_quality_ok) ? "QuestDB ledger" : "ledger unavailable";
      if (qKpiAnomalies) qKpiAnomalies.textContent = String(k.anomalies_total ?? "--");
      if (qKpiAnomaliesSub) qKpiAnomaliesSub.textContent = "latest per symbol";
      if (qKpiFreshness) qKpiFreshness.textContent = fmtAgeSec(k.freshness_max_age_sec);
      if (qKpiFreshnessSub) qKpiFreshnessSub.textContent = "max age";

      const rows = Array.isArray(body.rows) ? body.rows : [];
      if (rows.length === 0) {
        qTbody.innerHTML = '<tr><td colspan="6" class="muted">No rows.</td></tr>';
      } else {
        qTbody.innerHTML = rows.map((r) => {
          const sym = esc(r.symbol);
          const st = pillForStatus(r.status);
          const miss = (r.missing_days === null || r.missing_days === undefined) ? "--" : String(r.missing_days);
          const qScore = (r.field_quality_score === null || r.field_quality_score === undefined) ? "--" : (Number(r.field_quality_score).toFixed(1) + "%");
          const gaps = r.gaps || {};
          const outs = r.outliers || {};
          const anomalies = Number((gaps.abnormal || 0) + (gaps.critical || 0) + (outs.price_jump || 0) + (outs.volume_spike || 0) + (outs.spread_anomaly || 0)) || 0;
          const lastTick = r.last_tick_ts ? esc(r.last_tick_ts) : "--";
          return (
            '<tr data-symbol="' + sym + '" style="cursor:pointer;">' +
              '<td class="mono">' + sym + '</td>' +
              '<td>' + st + '</td>' +
              '<td class="mono">' + esc(miss) + '</td>' +
              '<td class="mono">' + esc(qScore) + '</td>' +
              '<td class="mono">' + esc(String(anomalies)) + '</td>' +
              '<td class="mono text-xs">' + lastTick + '</td>' +
            '</tr>'
          );
        }).join("");
      }
      setQualityStatus("Loaded " + String(body.count || rows.length || 0) + " rows.");
      _setUpdatedAt(qUpdatedAt, body.generated_at);
    } catch (e) {
      setQualityStatus("Failed: " + String(e.message || e));
      qTbody.innerHTML = '<tr><td colspan="6" class="muted">Failed to load.</td></tr>';
      _setUpdatedAt(qUpdatedAt, null);
    }
  }

  async function loadQualityDetail(symbol) {
    if (!qDetailJson) return;
    const sym = String(symbol || "").trim();
    if (!sym) return;
    if (qDetailMeta) qDetailMeta.textContent = "Loading " + sym + "...";
    qDetailJson.textContent = "--";
    try {
      const url = window.ghTrader.withToken("/api/data/quality-detail/" + encodeURIComponent(sym) + "?limit=30");
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
      if (qDetailMeta) qDetailMeta.textContent = sym + " • field_quality " + (body.field_quality || []).length + " • gaps " + (body.tick_gaps || []).length;
      qDetailJson.textContent = JSON.stringify(body, null, 2);
    } catch (e) {
      if (qDetailMeta) qDetailMeta.textContent = "Failed (" + String(e.message || e) + ")";
      qDetailJson.textContent = "--";
    }
  }

  if (qTbody) {
    qTbody.addEventListener("click", (ev) => {
      const tr = ev.target && ev.target.closest ? ev.target.closest("tr[data-symbol]") : null;
      if (!tr) return;
      const sym = tr.getAttribute("data-symbol");
      loadQualityDetail(sym);
    });
  }

  const loadQualityDebounced = window.ghTrader.debounce(() => loadQualitySummary(true), 150);
  if (qSearch) qSearch.addEventListener("input", () => loadQualityDebounced());
  if (qLimit) qLimit.addEventListener("change", () => loadQualitySummary(true));
  if (qOnlyIssues) qOnlyIssues.addEventListener("change", () => loadQualitySummary(true));
  if (qRefreshBtn) qRefreshBtn.addEventListener("click", () => loadQualitySummary(true));
  if (qDiagnoseBtn) {
    qDiagnoseBtn.addEventListener("click", async () => {
      try {
        const ex = elExchange.value;
        const v = elVar.value;
        setQualityStatus("Enqueuing diagnose job...");
        const start = _readDateInput(toolsStart);
        const end = _readDateInput(toolsEnd);
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        const forceFull = !!(toolsForceFullScan && toolsForceFullScan.checked);
        const th = _readThoroughnessInput();
        const cw = _readIntInput(toolsCheckWorkers, 0);
        const msg =
          "Diagnose will run for this scope.\n\n" +
          "Target: " + ex + "." + v + "\n" +
          (start ? ("Start: " + start + "\n") : "") +
          (end ? ("End: " + end + "\n") : "") +
          (refresh ? "Catalog: refresh from TqSdk\n" : "Catalog: use cached\n") +
          (forceFull ? "Scan: force full\n" : "Scan: incremental\n") +
          "Thoroughness: " + th + "\n" +
          "Check workers: " + String(cw) + "\n" +
          "\nProceed?";
        if (!window.confirm(msg)) return;
        const body = await window.ghTrader.postJson("/api/data/diagnose", {
          exchange: ex,
          var: v,
          thoroughness: th,
          check_workers: cw,
          start: start,
          end: end,
          refresh_catalog: refresh,
          force_full_scan: forceFull,
        });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setQualityStatus("Diagnose enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Diagnose job enqueued", "success");
      } catch (e) {
        setQualityStatus("Failed: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // -------------------------------------------------------------------------
  // Advanced panel (date overrides + latest reports)
  // -------------------------------------------------------------------------

  function _readDateInput(el) {
    try {
      const v = el && el.value ? String(el.value) : "";
      return v && v.length >= 10 ? v.slice(0, 10) : "";
    } catch (e) {
      return "";
    }
  }

  function _readIntInput(el, fallback) {
    try {
      const v = el && el.value !== undefined ? String(el.value).trim() : "";
      const n = parseInt(v, 10);
      return isFinite(n) ? n : fallback;
    } catch (e) {
      return fallback;
    }
  }

  function _readThoroughnessInput() {
    const v = toolsThoroughness && toolsThoroughness.value ? String(toolsThoroughness.value) : "comprehensive";
    if (v === "quick" || v === "standard" || v === "comprehensive") return v;
    return "comprehensive";
  }

  async function loadToolsReports() {
    const ex = elExchange.value;
    const v = elVar.value;

    _latestDiagnoseReportPath = null;

    // Diagnose report
    if (toolsDiagnoseMeta) toolsDiagnoseMeta.textContent = "Loading...";
    if (toolsDiagnoseJson) toolsDiagnoseJson.textContent = "--";
    try {
      const url = window.ghTrader.withToken(
        "/api/data/reports?kind=diagnose&exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&limit=1"
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (body && body.ok === false && String(body.error || "") === "no_reports") {
        if (toolsDiagnoseMeta) toolsDiagnoseMeta.textContent = "No reports yet.";
        if (toolsDiagnoseJson) toolsDiagnoseJson.textContent = "--";
      } else {
        if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
        const rep = (body.reports && body.reports[0]) ? body.reports[0] : null;
        if (!rep) {
          if (toolsDiagnoseMeta) toolsDiagnoseMeta.textContent = "No reports yet.";
          if (toolsDiagnoseJson) toolsDiagnoseJson.textContent = "--";
        } else {
          _latestDiagnoseReportPath = rep._path || null;
          const s = rep.summary || {};
          const f = (s && s.findings) ? s.findings : {};
          const msg = "generated " + String(rep.generated_at || rep._path || "--") +
            " • auto_fixable " + String(f.auto_fixable || 0) +
            " • manual_review " + String(f.manual_review || 0) +
            " • unfixable " + String(f.unfixable || 0);
          if (toolsDiagnoseMeta) toolsDiagnoseMeta.textContent = msg;
          if (toolsDiagnoseJson) toolsDiagnoseJson.textContent = JSON.stringify(rep, null, 2);
        }
      }
    } catch (e) {
      if (toolsDiagnoseMeta) toolsDiagnoseMeta.textContent = "Failed to load (" + String(e.message || e) + ")";
      if (toolsDiagnoseJson) toolsDiagnoseJson.textContent = "--";
    }

    // Repair report
    if (toolsRepairMeta) toolsRepairMeta.textContent = "Loading...";
    if (toolsRepairJson) toolsRepairJson.textContent = "--";
    try {
      const url = window.ghTrader.withToken(
        "/api/data/reports?kind=repair&exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&limit=1"
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (body && body.ok === false && String(body.error || "") === "no_reports") {
        if (toolsRepairMeta) toolsRepairMeta.textContent = "No reports yet.";
        if (toolsRepairJson) toolsRepairJson.textContent = "--";
      } else {
        if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
        const rep = (body.reports && body.reports[0]) ? body.reports[0] : null;
        if (!rep) {
          if (toolsRepairMeta) toolsRepairMeta.textContent = "No reports yet.";
          if (toolsRepairJson) toolsRepairJson.textContent = "--";
        } else {
          const result = rep.result || {};
          const ok = (result.ok === true) ? "ok" : ((result.ok === false) ? "failed" : "--");
          const finished = result.finished_at || rep.result_path || rep.plan_path || "--";
          const actions = Array.isArray(result.actions) ? result.actions.length : 0;
          const msg = "finished " + String(finished) + " • " + ok + " • actions " + String(actions);
          if (toolsRepairMeta) toolsRepairMeta.textContent = msg;
          if (toolsRepairJson) toolsRepairJson.textContent = JSON.stringify(rep, null, 2);
        }
      }
    } catch (e) {
      if (toolsRepairMeta) toolsRepairMeta.textContent = "Failed to load (" + String(e.message || e) + ")";
      if (toolsRepairJson) toolsRepairJson.textContent = "--";
    }

    // L5-start report
    if (toolsL5Meta) toolsL5Meta.textContent = "Loading...";
    if (toolsL5Json) toolsL5Json.textContent = "--";
    try {
      const url = window.ghTrader.withToken(
        "/api/data/l5-start?exchange=" + encodeURIComponent(ex) + "&var=" + encodeURIComponent(v) + "&limit=1"
      );
      const resp = await window.ghTrader.fetchApi(url);
      const body = await resp.json();
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      if (!body || body.ok !== true) throw new Error(String((body && (body.error || body.detail)) || "failed"));
      const rep = (body.reports && body.reports[0]) ? body.reports[0] : null;
      if (!rep) {
        if (toolsL5Meta) toolsL5Meta.textContent = "No reports yet.";
        if (toolsL5Json) toolsL5Json.textContent = "--";
      } else {
        const msg = "generated " + String(rep.generated_at || rep._path || "--") +
          " • variety_first_l5_day " + String(rep.variety_first_l5_day || "--") +
          " • symbols_with_l5 " + String(rep.symbols_with_l5 || 0);
        if (toolsL5Meta) toolsL5Meta.textContent = msg;
        if (toolsL5Json) {
          toolsL5Json.textContent = JSON.stringify({
            generated_at: rep.generated_at,
            exchange: rep.exchange,
            var: rep.var,
            dataset_version: rep.dataset_version,
            index_table: rep.index_table,
            variety_first_l5_day: rep.variety_first_l5_day,
            symbols: rep.symbols,
            symbols_with_l5: rep.symbols_with_l5,
            path: rep._path,
          }, null, 2);
        }
      }
    } catch (e) {
      if (toolsL5Meta) toolsL5Meta.textContent = "Failed to load (" + String(e.message || e) + ")";
      if (toolsL5Json) toolsL5Json.textContent = "--";
    }
  }

  // Step 1: Health
  if (btnHealth) {
    btnHealth.addEventListener("click", async () => {
      try {
        if (!lastQuestdbOk) {
          window.ghTrader.toast("QuestDB is offline. Fix QuestDB first.", "error");
          return;
        }
        const ex = elExchange.value;
        const v = elVar.value;
        const start = _readDateInput(toolsStart);
        const end = _readDateInput(toolsEnd);
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        const forceFull = !!(toolsForceFullScan && toolsForceFullScan.checked);
        const th = _readThoroughnessInput();
        const cw = _readIntInput(toolsCheckWorkers, 0);
        const dw = _readIntInput(toolsDownloadWorkers, 0);
        const chunkDays = _readIntInput(toolsChunkDays, 5);
        const msg =
          "Health will run diagnose + auto-repair for this scope.\n\n" +
          "Target: " + ex + "." + v + "\n" +
          (start ? ("Start: " + start + "\n") : "") +
          (end ? ("End: " + end + "\n") : "") +
          (refresh ? "Catalog: refresh from TqSdk\n" : "Catalog: use cached\n") +
          (forceFull ? "Scan: force full\n" : "Scan: incremental\n") +
          "Thoroughness: " + th + "\n" +
          "Check workers: " + String(cw) + "\n" +
          "Download workers: " + String(dw) + "\n" +
          "Chunk days: " + String(chunkDays) + "\n" +
          "\nProceed?";
        if (!window.confirm(msg)) return;

        setStatus("Enqueuing health job...");
        const body = await window.ghTrader.postJson("/api/data/health", {
          exchange: ex,
          var: v,
          thoroughness: th,
          check_workers: cw,
          start: start,
          end: end,
          refresh_catalog: refresh,
          force_full_scan: forceFull,
          auto_repair: true,
          dry_run: false,
          chunk_days: chunkDays,
          download_workers: dw,
        });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Health job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Health job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  if (btnRepair) {
    btnRepair.addEventListener("click", async () => {
      try {
        if (!lastQuestdbOk) {
          window.ghTrader.toast("QuestDB is offline. Fix QuestDB first.", "error");
          return;
        }
        if (!_latestDiagnoseReportPath) {
          await loadToolsReports();
        }
        if (!_latestDiagnoseReportPath) {
          window.ghTrader.toast("No diagnose report found yet. Run Health first.", "error");
          return;
        }
        const refresh = !!(toolsRefreshCatalog && toolsRefreshCatalog.checked);
        const dw = _readIntInput(toolsDownloadWorkers, 0);
        const chunkDays = _readIntInput(toolsChunkDays, 5);
        const msg =
          "Repair will run auto-only actions from the latest diagnose report:\n\n" +
          String(_latestDiagnoseReportPath) + "\n" +
          (refresh ? "Catalog: refresh from TqSdk\n" : "Catalog: use cached\n") +
          "Download workers: " + String(dw) + "\n" +
          "Chunk days: " + String(chunkDays) + "\n" +
          "\nProceed?";
        if (!window.confirm(msg)) return;

        setStatus("Enqueuing repair job...");
        const body = await window.ghTrader.postJson("/api/data/repair", {
          report_path: _latestDiagnoseReportPath,
          auto_only: true,
          dry_run: false,
          refresh_catalog: refresh,
          chunk_days: chunkDays,
          download_workers: dw,
        });
        const jobId = (body.enqueued && body.enqueued[0]) ? body.enqueued[0] : null;
        setStatus("Repair job enqueued" + (jobId ? (" (" + jobId + ")") : "") + ". Check Jobs.");
        window.ghTrader.toast("Repair job enqueued", "success");
      } catch (e) {
        setStatus("Error: " + String(e.message || e));
        window.ghTrader.toast("Failed: " + e.message, "error");
      }
    });
  }

  // Tabs
  window.ghTrader.initTabs({
    updateHash: true,
    onTab: function(tabId) {
      if (String(tabId || "") === "quality") {
        loadQualitySummary(false);
      }
    }
  });

  // Contracts is the primary workflow: load immediately on page load.
  setTimeout(loadContractsSnapshot, 0);

  // -------------------------------------------------------------------------
  // Ingest jobs auto-refresh (from Ops)
  // -------------------------------------------------------------------------
  const tokenQs = "{{ token_qs }}";
  const ingestSpeedState = new Map();

  function fmtDurationSec(sec) {
    const s = Math.max(0, Math.floor(sec || 0));
    const h = Math.floor(s / 3600);
    const m = Math.floor((s % 3600) / 60);
    const ss = s % 60;
    if (h > 0) return h + "h" + String(m).padStart(2, "0") + "m";
    if (m > 0) return m + "m" + String(ss).padStart(2, "0") + "s";
    return ss + "s";
  }

  function fmtSpeedDaysPerMin(x) {
    const v = Number(x);
    if (!isFinite(v) || v <= 0) return "";
    return v.toFixed(2) + " days/min";
  }

  function speedAndEtaForStatus(s) {
    const kind = String(s.kind || "");
    const sum = s.summary || {};
    let done = null;
    let expected = null;
    if (kind === "download_contract_range") {
      done = (sum.days_done_total ?? null);
      expected = (sum.days_expected_total ?? null);
    } else if (kind === "download") {
      done = (sum.days_done ?? null);
      expected = (sum.days_expected ?? null);
    } else {
      return { speedText: "", etaText: "" };
    }
    if (done === null || done === undefined) return { speedText: "", etaText: "" };
    const jobId = String(s.job_id || "");
    const nowMs = Date.now();
    const prev = ingestSpeedState.get(jobId);
    ingestSpeedState.set(jobId, { atMs: nowMs, daysDone: Number(done) });
    if (!prev) return { speedText: "", etaText: "" };
    const dtSec = (nowMs - Number(prev.atMs || 0)) / 1000.0;
    const dd = Number(done) - Number(prev.daysDone || 0);
    const sp = (dtSec > 0) ? (dd / dtSec) * 60.0 : 0;
    const speedText = fmtSpeedDaysPerMin(sp);
    let etaText = "";
    if (speedText && expected !== null && expected !== undefined && sp > 0) {
      const rem = Math.max(0, Number(expected) - Number(done));
      etaText = "ETA " + fmtDurationSec((rem / sp) * 60.0);
    }
    return { speedText, etaText };
  }

  async function refreshIngestJobs() {
    try {
      const resp = await window.ghTrader.fetchApi("/api/ingest/status?limit=50");
      if (!resp.ok) return;
      const data = await resp.json();
      const jobs = data.jobs || [];

      const tbody = document.getElementById("ingestJobsBody");
      if (!tbody) return;

      if (jobs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="muted">No ingest jobs running</td></tr>';
        return;
      }

      tbody.innerHTML = jobs.map(s => {
        const current = s.kind === "download_contract_range" ? (s.current_symbol || "") :
                        s.kind === "download" ? (s.symbol || "") : (s.current_symbol || "");
        const pct = s.summary && s.summary.pct !== null ? s.summary.pct : null;
        const pctText = pct !== null ? (pct * 100).toFixed(1) + "%" : "-";
        const se = speedAndEtaForStatus(s);
        const extra = [se.speedText, se.etaText].filter(Boolean).join(", ");
        const pctBar = pct !== null ?
          '<div class="progressBar"><div style="width:' + (pct * 100).toFixed(1) + '%"></div></div>' +
          '<div class="mono text-xs" style="margin-top:4px;">' + pctText + (extra ? (' · ' + extra) : '') + '</div>' : '-';

        return [
          '<tr>',
          '<td class="mono text-xs">' + (s.job_id || "").substring(0, 8) + '</td>',
          '<td><span class="pill pill-' + (s.job_status || "queued") + '">' + (s.job_status || "") + '</span></td>',
          '<td class="mono">' + (s.kind || "") + '</td>',
          '<td class="mono">' + current + '</td>',
          '<td>' + pctBar + '</td>',
          '<td><a href="/jobs/' + (s.job_id || "") + tokenQs + '">View</a></td>',
          '</tr>'
        ].join("");
      }).join("");
    } catch (e) {
      // Ignore errors
    }
  }

  // Bulk cancel downloads
  const cancelAllBtn = document.getElementById("cancelAllDownloadsBtn");
  if (cancelAllBtn) {
    cancelAllBtn.addEventListener("click", async () => {
      if (!window.confirm("Cancel ALL download jobs (download + download-contract-range)?")) return;
      try {
        const resp = await window.ghTrader.postJson("/api/jobs/cancel-batch", {
          kinds: ["download", "download_contract_range"],
          statuses: ["running", "queued"],
          include_unstarted_queued: true,
        });
        window.alert("Cancelled: " + (resp.cancelled || 0) + " / matched: " + (resp.matched || 0));
        refreshIngestJobs();
      } catch (e) {
        window.alert("Cancel failed: " + (e && e.message ? e.message : String(e)));
      }
    });
  }

  // Initial refresh and auto-refresh every 10s
  refreshIngestJobs();
  setInterval(refreshIngestJobs, 10000);
})();
</script>
{% endblock %}
