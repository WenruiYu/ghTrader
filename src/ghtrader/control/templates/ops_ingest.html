{% extends "base.html" %}
{% block content %}
  <h2>Ingest</h2>

  <div class="card">
    <h3>Running ingest jobs</h3>
    <p class="muted">
      Auto-refreshes every ~15s. Progress is computed from <span class="mono">data/lake</span> (v1) or <span class="mono">data/lake_v2</span> (v2) partitions + no-data markers;
      “current” symbol/chunk hints are parsed from job logs.
    </p>

    <table class="table" id="ingestJobsTable">
      <thead>
        <tr>
          <th>ID</th><th>Status</th><th>Kind</th><th>Source</th><th>Current</th><th>Progress</th><th>Title</th><th></th>
        </tr>
      </thead>
      <tbody id="ingestJobsBody">
        {% for s in ingest_statuses %}
          <tr>
            <td class="mono">{{ s.job_id }}</td>
            <td><span class="pill pill-{{ s.job_status }}">{{ s.job_status }}</span></td>
            <td class="mono">{{ s.kind }}</td>
            <td class="mono">{{ s.source or "" }}</td>
            <td class="mono">
              {% if s.kind == "download_contract_range" %}
                {{ s.current_symbol or "" }}
              {% elif s.kind == "download" %}
                {{ s.symbol or "" }}
              {% else %}
                {{ s.current_symbol or "" }}
              {% endif %}
            </td>
            <td class="mono">
              {% if s.kind == "download_contract_range" and s.summary %}
                {{ (s.summary.pct * 100) | round(1) }}%
                ({{ s.summary.days_done_total }}/{{ s.summary.days_expected_total }})
                contracts {{ s.summary.contracts_done }}/{{ s.summary.contracts_total }}
              {% elif s.kind == "download" and s.summary %}
                {{ (s.summary.pct * 100) | round(1) }}%
                ({{ s.summary.days_done }}/{{ s.summary.days_expected }})
              {% else %}
                -
              {% endif %}
            </td>
            <td>{{ s.title or "" }}</td>
            <td><a href="/jobs/{{ s.job_id }}{{ token_qs }}">View</a></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card" id="rangeDetailsCard" style="display:none;">
    <h3>Range details</h3>
    <div id="rangeDetailsMeta" class="muted"></div>
    <table class="table">
      <thead>
        <tr>
          <th>Contract</th><th>Status</th><th>Current</th><th>Expected</th><th>Done</th><th>%</th><th>min</th><th>max</th>
        </tr>
      </thead>
      <tbody id="rangeDetailsBody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>download</h3>
    <form class="form" method="post" action="/ops/ingest/download{{ token_qs }}">
      <div class="grid3">
        <div><label>Symbol</label><input name="symbol" placeholder="SHFE.cu2602"/></div>
        <div><label>Start (YYYY-MM-DD)</label><input name="start_date"/></div>
        <div><label>End (YYYY-MM-DD)</label><input name="end_date"/></div>
      </div>
      <div class="grid3">
        <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        <div><label>Chunk days</label><input name="chunk_days" value="5"/></div>
        <div><label>Lake version</label>
          <select name="lake_version"><option value="v1" selected>v1</option><option value="v2">v2</option></select>
        </div>
      </div>
      <button type="submit">Start download</button>
    </form>
  </div>

  <div class="card">
    <h3>download-contract-range</h3>
    <form class="form" method="post" action="/ops/ingest/download_contract_range{{ token_qs }}">
      <div class="grid3">
        <div><label>Exchange</label><input name="exchange" value="SHFE"/></div>
        <div><label>Var (cu/au/ag)</label><input name="variety" value="cu"/></div>
        <div><label>Chunk days</label><input name="chunk_days" value="5"/></div>
      </div>
      <div class="grid3">
        <div><label>Start contract (YYMM)</label><input name="start_contract" value="1601"/></div>
        <div><label>End contract</label><input name="end_contract" value="auto"/></div>
        <div><label>Refresh akshare</label>
          <select name="refresh_akshare"><option value="false" selected>false</option><option value="true">true</option></select>
        </div>
      </div>
      <div class="grid2">
        <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        <div><label>Lake version</label>
          <select name="lake_version"><option value="v1" selected>v1</option><option value="v2">v2</option></select>
        </div>
      </div>
      <button type="submit">Start range backfill</button>
    </form>
  </div>

  <div class="card">
    <h3>record (live)</h3>
    <form class="form" method="post" action="/ops/ingest/record{{ token_qs }}">
      <div class="grid3">
        <div><label>Symbols (comma-separated)</label><input name="symbols" placeholder="SHFE.cu2602,SHFE.au2602"/></div>
        <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        <div><label>Lake version</label>
          <select name="lake_version"><option value="v1" selected>v1</option><option value="v2">v2</option></select>
        </div>
      </div>
      <button type="submit">Start recorder</button>
    </form>
  </div>

  <script>
    (function() {
      const tokenQs = "{{ token_qs }}";
      const url = "/api/ingest/status" + tokenQs;

      function pillClass(status) {
        return "pill pill-" + (status || "queued");
      }

      function fmtPct(x) {
        if (x === null || x === undefined) return "-";
        return (Math.round(x * 1000) / 10).toFixed(1) + "%";
      }

      function renderJobs(rows) {
        const body = document.getElementById("ingestJobsBody");
        body.innerHTML = "";
        for (const s of rows) {
          const tr = document.createElement("tr");

          const current = (s.kind === "download_contract_range") ? (s.current_symbol || "") :
                          (s.kind === "download") ? (s.symbol || "") :
                          (s.current_symbol || "");

          let progress = "-";
          if (s.kind === "download_contract_range" && s.summary) {
            progress = fmtPct(s.summary.pct) +
              " (" + s.summary.days_done_total + "/" + s.summary.days_expected_total + ")" +
              " contracts " + s.summary.contracts_done + "/" + s.summary.contracts_total;
          } else if (s.kind === "download" && s.summary) {
            progress = fmtPct(s.summary.pct) + " (" + s.summary.days_done + "/" + s.summary.days_expected + ")";
          }

          tr.innerHTML =
            '<td class="mono">' + (s.job_id || "") + '</td>' +
            '<td><span class="' + pillClass(s.job_status) + '">' + (s.job_status || "") + '</span></td>' +
            '<td class="mono">' + (s.kind || "") + '</td>' +
            '<td class="mono">' + (s.source || "") + '</td>' +
            '<td class="mono">' + current + '</td>' +
            '<td class="mono">' + progress + '</td>' +
            '<td>' + (s.title || "") + '</td>' +
            '<td><a href="/jobs/' + (s.job_id || "") + tokenQs + '">View</a></td>';

          body.appendChild(tr);
        }
      }

      function renderFirstRange(rows) {
        const card = document.getElementById("rangeDetailsCard");
        const meta = document.getElementById("rangeDetailsMeta");
        const body = document.getElementById("rangeDetailsBody");

        const s = rows.find(r => r.kind === "download_contract_range" && r.contracts && r.contracts.length);
        if (!s) {
          card.style.display = "none";
          return;
        }

        card.style.display = "block";
        meta.textContent =
          "Job " + (s.job_id || "") + " / " + (s.var || "") + " " +
          (s.start_contract || "") + " -> " + (s.resolved_end_contract || s.end_contract || "") +
          (s.current_symbol ? (" | current: " + s.current_symbol) : "");

        body.innerHTML = "";
        // Render all contracts (acceptable; CU range is manageable). Current contract is flagged.
        for (const c of s.contracts) {
          const tr = document.createElement("tr");
          tr.innerHTML =
            '<td class="mono">' + (c.raw_contract || "") + '</td>' +
            '<td class="mono">' + (c.status || "") + '</td>' +
            '<td class="mono">' + (c.is_current ? "yes" : "") + '</td>' +
            '<td class="mono">' + (c.days_expected ?? "") + '</td>' +
            '<td class="mono">' + (c.days_done ?? "") + '</td>' +
            '<td class="mono">' + fmtPct(c.pct) + '</td>' +
            '<td class="mono">' + (c.min_downloaded || "") + '</td>' +
            '<td class="mono">' + (c.max_downloaded || "") + '</td>';
          if (c.is_current) {
            tr.style.background = "#fff3cd";
          }
          body.appendChild(tr);
        }
      }

      async function refresh() {
        try {
          const resp = await fetch(url);
          if (!resp.ok) return;
          const data = await resp.json();
          const rows = data.jobs || [];
          renderJobs(rows);
          renderFirstRange(rows);
        } catch (e) {}
      }

      refresh();
      setInterval(refresh, 15000);
    })();
  </script>
{% endblock %}

