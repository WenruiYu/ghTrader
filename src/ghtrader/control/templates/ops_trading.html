{% extends "base.html" %}
{% block content %}
  <h2>Trading</h2>

  <div class="card">
    <h3>trade</h3>
    <form class="form" method="post" action="/ops/trading/trade{{ token_qs }}">
      <div class="grid3">
        <div>
          <label>Mode</label>
          <select name="mode" id="tradeMode">
            <option value="paper" selected>paper</option>
            <option value="sim">sim</option>
            <option value="live">live</option>
          </select>
        </div>
        <div>
          <label>Sim account</label>
          <select name="sim_account">
            <option value="tqsim" selected>tqsim</option>
            <option value="tqkq">tqkq</option>
          </select>
        </div>
        <div>
          <label>Executor</label>
          <select name="executor">
            <option value="targetpos" selected>targetpos</option>
            <option value="direct">direct</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin:12px 0;">
        <div class="inlineControls">
          <label><input type="checkbox" id="monitorOnly" name="monitor_only" checked/> monitor-only (no orders)</label>
          <span class="muted">Recommended for first real-account testing.</span>
        </div>
      </div>

      <div class="grid3">
        <div><label>Model</label><input name="model" value="xgboost"/></div>
        <div><label>Horizon</label><input name="horizon" value="50"/></div>
        <div><label>Position size</label><input name="position_size" value="1"/></div>
      </div>

      <div class="grid3">
        <div><label>Threshold up</label><input name="threshold_up" value="0.6"/></div>
        <div><label>Threshold down</label><input name="threshold_down" value="0.6"/></div>
        <div><label>Snapshot interval (sec)</label><input name="snapshot_interval_sec" value="10"/></div>
      </div>

      <div>
        <label>Symbols (comma-separated)</label>
        <input name="symbols" placeholder="SHFE.cu2602,KQ.m@SHFE.cu"/>
      </div>

      <h4>Risk</h4>
      <div class="grid3">
        <div><label>Max position</label><input name="max_position" value="1"/></div>
        <div><label>Max order size</label><input name="max_order_size" value="1"/></div>
        <div><label>Max ops/sec</label><input name="max_ops_per_sec" value="10"/></div>
      </div>
      <div class="grid3">
        <div><label>Max daily loss</label><input name="max_daily_loss" placeholder="(optional)"/></div>
        <div>
          <label>Enforce trading time</label>
          <select name="enforce_trading_time"><option value="true" selected>true</option><option value="false">false</option></select>
        </div>
        <div id="confirmLiveWrap"><label>Confirm live</label><input name="confirm_live" placeholder="I_UNDERSTAND"/></div>
      </div>

      <h4>TargetPosTask</h4>
      <div class="grid2">
        <div>
          <label>tp price</label>
          <select name="tp_price"><option value="ACTIVE" selected>ACTIVE</option><option value="PASSIVE">PASSIVE</option></select>
        </div>
        <div><label>tp offset priority</label><input name="tp_offset_priority" value="今昨,开"/></div>
      </div>

      <h4>Direct orders</h4>
      <div class="grid2">
        <div>
          <label>direct price mode</label>
          <select name="direct_price_mode"><option value="ACTIVE" selected>ACTIVE</option><option value="PASSIVE">PASSIVE</option></select>
        </div>
        <div>
          <label>direct advanced</label>
          <select name="direct_advanced"><option value="" selected>(none)</option><option value="FAK">FAK</option><option value="FOK">FOK</option></select>
        </div>
      </div>

      <div class="grid3">
        <div><label>Data dir</label><input name="data_dir" value="data"/></div>
        <div><label>Artifacts dir</label><input name="artifacts_dir" value="artifacts"/></div>
        <div><label>Runs dir</label><input name="runs_dir" value="runs"/></div>
      </div>

      <button type="submit">Start trade job</button>
    </form>
  </div>

  <script>
    (function() {
      const mode = document.getElementById("tradeMode");
      const mo = document.getElementById("monitorOnly");
      const confirmWrap = document.getElementById("confirmLiveWrap");

      function sync() {
        const m = (mode && mode.value) ? mode.value : "paper";
        const monitor = !!(mo && mo.checked);
        // Only show confirm-live when doing real order routing.
        if (confirmWrap) {
          confirmWrap.style.display = (m === "live" && !monitor) ? "block" : "none";
        }
        // Auto-enable monitor-only when switching to live (safety-first).
        if (m === "live" && mo && !mo.checked) {
          mo.checked = true;
        }
        // Disable sim_account control unless sim
        const simSelect = document.querySelector('select[name="sim_account"]');
        if (simSelect) simSelect.disabled = (m !== "sim");
      }

      if (mode) mode.addEventListener("change", sync);
      if (mo) mo.addEventListener("change", sync);
      sync();
    })();
  </script>

  <div class="card">
    <h3>Recent trading runs</h3>
    {% if runs and runs|length > 0 %}
      <div class="tableWrap">
        <table class="table">
          <thead><tr><th>run_id</th><th>last_ts</th><th>balance</th><th></th></tr></thead>
          <tbody>
          {% for r in runs %}
            <tr>
              <td class="mono">{{ r.run_id }}</td>
              <td class="mono">{{ r.last_ts }}</td>
              <td class="mono">{{ r.balance }}</td>
              <td><a href="/ops/trading/run/{{ r.run_id }}{{ token_qs }}">view</a></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No runs found under runs/trading/</p>
    {% endif %}
  </div>
{% endblock %}

