{% extends "base.html" %}
{% block content %}
  <div class="section-header">
    <h2>Jobs</h2>
    <div class="section-header-actions">
      <a class="btn btn-secondary btn-sm" href="/jobs{{ token_qs }}">Refresh</a>
    </div>
  </div>

  <div class="card">
    <h3>Start a job (quick)</h3>
    <p class="muted">
      Jobs run as subprocesses and stream logs to <span class="mono">runs/control/logs/</span>.
      For full parameter control, prefer the Ops pages (Ingest/Build/Model/Eval/Trading).
    </p>

    <form class="form" method="post" action="/jobs/start{{ token_qs }}" id="startJobForm">
      <label>Job type</label>
      <select name="job_type" id="jobType">
        <option value="build">build (labels+features)</option>
        <option value="train">train</option>
        <option value="benchmark">benchmark</option>
        <option value="main_schedule">main-schedule (roll schedule)</option>
        <option value="main_l5">main-l5 (derived ticks)</option>
      </select>

      <div class="grid2">
        <div>
          <label>Symbol / Variety</label>
          <input name="symbol_or_var" id="symbolOrVar" placeholder="e.g. SHFE.cu2602 or cu"/>
        </div>
        <div>
          <label>Data dir</label>
          <input name="data_dir" value="data"/>
        </div>
      </div>


      <details id="groupModel">
        <summary>train / benchmark options</summary>
        <div class="grid3">
          <div>
            <label>Model</label>
            <input name="model" value="xgboost"/>
          </div>
          <div>
            <label>Horizon</label>
            <input name="horizon" value="50"/>
          </div>
          <div>
            <label>Artifacts dir</label>
            <input name="artifacts_dir" value="artifacts"/>
          </div>
        </div>
      </details>

      <details id="groupMainSchedule">
        <summary>main-schedule options</summary>
        <div class="grid3">
          <div>
            <label>Start date</label>
            <input name="start_date" placeholder="YYYY-MM-DD"/>
          </div>
          <div>
            <label>End date</label>
            <input name="end_date" placeholder="YYYY-MM-DD"/>
          </div>
          <div>
            <label>Threshold</label>
            <input name="threshold" value="1.1"/>
          </div>
        </div>
      </details>

      <details id="groupMainL5">
        <summary>main-l5 options</summary>
        <div class="grid2">
          <div>
            <label>Derived symbol</label>
            <input name="derived_symbol" value="KQ.m@SHFE.cu"/>
          </div>
          <div>
            <label>Overwrite</label>
            <select name="overwrite">
              <option value="0" selected>no</option>
              <option value="1">yes</option>
            </select>
          </div>
        </div>
      </details>

      <button type="submit">Start</button>
    </form>
  </div>

  <h3>Recent jobs</h3>
  <div class="card">
    <div class="inlineControls">
      <label for="jobsFilter">Filter</label>
      <input id="jobsFilter" placeholder="Search id/title/source..."/>
      <label for="statusFilter">Status</label>
      <select id="statusFilter">
        <option value="" selected>(any)</option>
        <option value="running">running</option>
        <option value="queued">queued</option>
        <option value="succeeded">succeeded</option>
        <option value="failed">failed</option>
        <option value="cancelled">cancelled</option>
      </select>
    </div>
  </div>

  <div class="tableWrap">
    <table class="table" id="jobsTable">
      <thead>
        <tr>
          <th>ID</th><th>Status</th><th>Source</th><th>Title</th><th>Locks</th><th>PID</th><th>Exit</th><th>Created</th><th></th>
        </tr>
      </thead>
      <tbody>
        {% for j in jobs %}
        <tr data-status="{{ j.status }}">
          <td class="mono">{{ j.id }}</td>
          <td><span class="pill pill-{{ j.status }}">{{ j.status }}</span></td>
          <td class="mono">{{ j.source or "" }}</td>
          <td>{{ j.title }}</td>
          <td class="mono">
            {% if j.held_locks %}
              <div class="muted">held</div>
              {% for k in j.held_locks %}<div>{{ k }}</div>{% endfor %}
            {% endif %}
            {% if j.waiting_locks %}
              <div class="muted" style="margin-top:6px;">waiting</div>
              {% for k in j.waiting_locks %}<div>{{ k }}</div>{% endfor %}
            {% endif %}
          </td>
          <td class="mono">{{ j.pid or "" }}</td>
          <td class="mono">{{ j.exit_code if j.exit_code is not none else "" }}</td>
          <td class="mono">{{ j.created_at }}</td>
          <td><a href="/jobs/{{ j.id }}{{ token_qs }}">View</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    (function() {
      const jobType = document.getElementById("jobType");
      const symbolOrVar = document.getElementById("symbolOrVar");

      const groups = {
        model: document.getElementById("groupModel"),
        mainSchedule: document.getElementById("groupMainSchedule"),
        mainL5: document.getElementById("groupMainL5"),
      };

      function setGroupVisible(el, on) {
        if (!el) return;
        el.style.display = on ? "block" : "none";
      }

      function syncFormByType() {
        const t = (jobType && jobType.value) ? jobType.value : "";
        setGroupVisible(groups.model, t === "train" || t === "benchmark" || t === "build");
        setGroupVisible(groups.mainSchedule, t === "main_schedule");
        setGroupVisible(groups.mainL5, t === "main_l5");

        // Open the relevant section by default to reduce missed-required-fields.
        if (groups.model) groups.model.open = (t === "train" || t === "benchmark" || t === "build");
        if (groups.mainSchedule) groups.mainSchedule.open = (t === "main_schedule");
        if (groups.mainL5) groups.mainL5.open = (t === "main_l5");

        if (!symbolOrVar) return;
        if (t === "main_schedule" || t === "main_l5") {
          symbolOrVar.placeholder = "e.g. cu";
        } else {
          symbolOrVar.placeholder = "e.g. SHFE.cu2602";
        }
      }
      if (jobType) jobType.addEventListener("change", syncFormByType);
      syncFormByType();

      const filter = document.getElementById("jobsFilter");
      const status = document.getElementById("statusFilter");
      const table = document.getElementById("jobsTable");

      function applyFilter() {
        if (!table) return;
        const q = (filter && filter.value ? filter.value : "").trim().toLowerCase();
        const s = (status && status.value ? status.value : "").trim().toLowerCase();
        const rows = table.querySelectorAll("tbody tr");
        for (const tr of rows) {
          const t = (tr.textContent || "").toLowerCase();
          const st = (tr.getAttribute("data-status") || "").toLowerCase();
          const okQ = !q || t.includes(q);
          const okS = !s || st === s;
          tr.style.display = (okQ && okS) ? "" : "none";
        }
      }
      if (filter) filter.addEventListener("input", applyFilter);
      if (status) status.addEventListener("change", applyFilter);
    })();
  </script>
{% endblock %}

