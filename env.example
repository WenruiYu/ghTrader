# ghTrader configuration (example)
#
# Copy to `.env` and fill in values:
#   cp env.example .env
#
# Never commit `.env` (it is gitignored).

# --- TqSdk Pro credentials (required for tq_dl historical downloads) ---
TQSDK_USER=
TQSDK_PASSWORD=

# --- Live trading account (TqAccount) ---
# Used by AccountGateway when desired mode is sim/live_monitor/live_trade (DANGEROUS).
# The live order-routing mode (`live_trade`) is safety-gated by:
# - GHTRADER_LIVE_ENABLED=true
# - confirm_live=I_UNDERSTAND in runs/gateway/account=<PROFILE>/desired.json
TQ_BROKER_ID=
TQ_ACCOUNT_ID=
TQ_ACCOUNT_PASSWORD=

# --- Optional: multiple broker accounts (env profiles) ---
# Use profiles when you want to monitor multiple real accounts in parallel.
#
# Example:
#   GHTRADER_TQ_ACCOUNT_PROFILES=main,alt
#   TQ_BROKER_ID_MAIN=...
#   TQ_ACCOUNT_ID_MAIN=...
#   TQ_ACCOUNT_PASSWORD_MAIN=...
#   TQ_BROKER_ID_ALT=...
#   TQ_ACCOUNT_ID_ALT=...
#   TQ_ACCOUNT_PASSWORD_ALT=...
GHTRADER_TQ_ACCOUNT_PROFILES=

# --- Safety gate (research-only by default) ---
# Set to "true" only if/when live trading is explicitly enabled.
GHTRADER_LIVE_ENABLED=false

# --- Optional: override default directories ---
GHTRADER_DATA_DIR=data
GHTRADER_ARTIFACTS_DIR=artifacts
GHTRADER_RUNS_DIR=runs

# --- Required: L5 start date (manual, per variety) ---
# Set these after running:
#   ghtrader data l5-start --exchange SHFE --var cu
#   ghtrader data l5-start --exchange SHFE --var au
#   ghtrader data l5-start --exchange SHFE --var ag
#
# Canonical per-var keys:
GHTRADER_L5_START_DATE_CU=
GHTRADER_L5_START_DATE_AU=
GHTRADER_L5_START_DATE_AG=
# Legacy fallback (optional, compatibility only):
GHTRADER_L5_START_DATE=

# --- Trading calendar (Shinny holiday list; no akshare) ---
# Optional: override the holiday list URL used to compute trading days.
# If unset, ghTrader uses Shinny's public holiday list URL.
TQ_CHINESE_HOLIDAY_URL=https://files.shinnytech.com/shinny_chinese_holiday.json

# --- TqSdk retry (optional) ---
# Retry transient network failures during main_l5 download.
GHTRADER_TQ_RETRY_MAX=3
GHTRADER_TQ_RETRY_BASE_S=10
GHTRADER_TQ_RETRY_MAX_S=300
# For timeout-like errors, reset TqApi only after N consecutive retries (reduce reconnect churn).
GHTRADER_TQ_TIMEOUT_RESET_AFTER=2
# Wait out the daily maintenance window (seconds). Set 0 to disable.
GHTRADER_TQ_MAINTENANCE_WAIT_S=2100

# --- main_l5 validation (optional) ---
# Best-effort TqSdk source checks for gap attribution (slow).
GHTRADER_L5_VALIDATE_TQ_CHECK=1
GHTRADER_L5_VALIDATE_TQ_CHECK_MAX_DAYS=2
GHTRADER_L5_VALIDATE_TQ_CHECK_MAX_SEGMENTS=8
# Limit stored gap segments per trading day in reports.
GHTRADER_L5_VALIDATE_MAX_SEGMENTS_PER_DAY=200
# Gap detection threshold (seconds) for missing segments.
GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S=5
# Optional per-session overrides (seconds); useful when day/night sparsity differs.
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_DAY=5
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_NIGHT=5
# Optional per-var/per-session overrides (var uppercased, e.g. CU).
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_CU=5
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_CU_DAY=5
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_CU_NIGHT=5
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_AU=5
# GHTRADER_L5_VALIDATE_GAP_THRESHOLD_S_AG=5
# Minimum ratio of seconds with >=2 ticks to enforce strict 0.5s cadence.
GHTRADER_L5_VALIDATE_STRICT_RATIO=0.8
# Optional per-var strict ratio profile.
# GHTRADER_L5_VALIDATE_STRICT_RATIO_CU=0.65
# GHTRADER_L5_VALIDATE_STRICT_RATIO_AU=0.75
# GHTRADER_L5_VALIDATE_STRICT_RATIO_AG=0.80
# Half-second miss policy on strict-cadence days (ratio over strict expected seconds).
# info: warning only; block: fail validation when exceeded.
GHTRADER_L5_VALIDATE_MISSING_HALF_INFO_RATIO=0.02
GHTRADER_L5_VALIDATE_MISSING_HALF_BLOCK_RATIO=0.10
# Optional per-var half-second policy.
# GHTRADER_L5_VALIDATE_MISSING_HALF_INFO_RATIO_CU=0.03
# GHTRADER_L5_VALIDATE_MISSING_HALF_BLOCK_RATIO_CU=0.18
# Max allowed >30s gaps before validation blocks (0=zero-tolerance).
GHTRADER_L5_VALIDATE_GAP_BLOCK_GT30=100
# Optional per-var override.
# GHTRADER_L5_VALIDATE_GAP_BLOCK_GT30_CU=700
# Average missing segments per day above which state degrades to warn (0=disabled).
GHTRADER_L5_VALIDATE_SEGMENTS_WARN_AVG_PER_DAY=500
# Max outside-session seconds before blocking (0=zero-tolerance); small boundary offsets are tolerated as warn.
GHTRADER_L5_VALIDATE_OUTSIDE_SESSIONS_BLOCK_S=60
# Source-layer policy (Layer B): warn by default, optional blocking mode + tolerated missing days.
GHTRADER_L5_VALIDATE_SOURCE_BLOCKING=false
GHTRADER_L5_VALIDATE_SOURCE_MISSING_DAYS_TOLERANCE=0
# Optional per-var source policy.
# GHTRADER_L5_VALIDATE_SOURCE_BLOCKING_AU=true
# GHTRADER_L5_VALIDATE_SOURCE_MISSING_DAYS_TOLERANCE_AU=1
# Max days included in the JSON validation report (QuestDB retains full summary).
GHTRADER_L5_VALIDATE_REPORT_MAX_DAYS=200
# Keep JSON report compact by default; use QuestDB gap APIs for full detail.
GHTRADER_L5_VALIDATE_REPORT_INCLUDE_SEGMENTS=0
# When segments are omitted, keep a small per-day sample for debugging.
GHTRADER_L5_VALIDATE_REPORT_SEGMENTS_SAMPLE=5
# Cap exchange-event rows embedded in report JSON.
GHTRADER_L5_VALIDATE_REPORT_MAX_EVENTS=200

# --- QuestDB (canonical data store; required for data workflows) ---
# ghTrader is QuestDB-first/only:
# - ticks: ghtrader_ticks_main_l5_v2
# - schedule: ghtrader_main_schedule_v2
# - features/labels (optional): ghtrader_features_v2 / ghtrader_labels_v2 (+ build metadata tables)
GHTRADER_QUESTDB_HOST=127.0.0.1
GHTRADER_QUESTDB_ILP_PORT=9009
GHTRADER_QUESTDB_PG_PORT=8812
GHTRADER_QUESTDB_PG_USER=admin
GHTRADER_QUESTDB_PG_PASSWORD=quest
GHTRADER_QUESTDB_PG_DBNAME=qdb
GHTRADER_QUESTDB_METRICS_PORT=9003
# Query/read timeout for QuestDB PGWire API calls
GHTRADER_QDB_QUERY_CONNECT_TIMEOUT_S=2

# ILP write strategy (high-throughput ingest)
# Batch rows per ILP dataframe() call (large values improve throughput, use with care)
GHTRADER_QDB_ILP_BATCH_ROWS=200000
# Flush every N batches to reduce per-batch flush overhead
GHTRADER_QDB_ILP_FLUSH_EVERY_BATCHES=2
# Reuse ILP sender per worker thread for lower connection churn
GHTRADER_QDB_ILP_PERSISTENT_SENDER=true
# Retry count for recoverable ILP sender transport faults (closed/broken pipe/reset)
GHTRADER_QDB_ILP_RETRY_MAX=1

# Optional Redis query cache (QuestDB read paths)
GHTRADER_QDB_REDIS_CACHE_ENABLED=true
GHTRADER_QDB_REDIS_HOST=127.0.0.1
GHTRADER_QDB_REDIS_PORT=6379
GHTRADER_QDB_REDIS_DB=0
GHTRADER_QDB_REDIS_TIMEOUT_S=0.2
GHTRADER_QDB_REDIS_TTL_S=300
# Per-query-family TTL overrides
GHTRADER_QDB_BOUNDS_TTL_S=300
GHTRADER_QDB_TRADING_DAYS_TTL_S=300

# --- Unified worker policy (static) ---
# Auto sizing uses CPU count and the QuestDB PG connection limit.
# Keep GHTRADER_QDB_PG_NET_CONNECTION_LIMIT in sync with QuestDB's QDB_PG_NET_CONNECTION_LIMIT.
GHTRADER_WORKERS_GLOBAL_MAX=128
GHTRADER_QDB_PG_NET_CONNECTION_LIMIT=512
GHTRADER_QDB_CONN_RESERVE=32
# Per-kind caps
GHTRADER_DIAGNOSE_MAX_WORKERS=96
# SQL pushdown worker pool (0=auto, clamped to QDB limit - reserve)
GHTRADER_DIAGNOSE_PUSHDOWN_WORKERS=0
# Ingest/download workers: leave 0/empty for auto policy; can be overridden for experiments.
GHTRADER_INGEST_WORKERS=0
GHTRADER_DOWNLOAD_MAX_WORKERS=16
# Extra download-side QuestDB connection budget to avoid exhausting PGWire under high concurrency.
GHTRADER_DOWNLOAD_QDB_CONN_BUDGET=120
# main_l5 orchestration budget:
# - TOTAL_WORKERS limits aggregate download concurrency for one main-l5 run.
# - SEGMENT_WORKERS limits parallel segments. Per-segment workers are derived from TOTAL_WORKERS / SEGMENT_WORKERS.
GHTRADER_MAIN_L5_TOTAL_WORKERS=
GHTRADER_MAIN_L5_SEGMENT_WORKERS=
GHTRADER_QUERY_MAX_WORKERS=64
GHTRADER_INDEX_BOOTSTRAP_WORKERS=96
GHTRADER_INDEX_BOOTSTRAP_BATCH_SYMBOLS=100

# --- Pipeline health gate / lock recovery ---
# Require each pipeline step to finish in a healthy persisted state.
GHTRADER_PIPELINE_ENFORCE_HEALTH=true
GHTRADER_MAIN_SCHEDULE_ENFORCE_HEALTH=true
GHTRADER_MAIN_L5_ENFORCE_HEALTH=true
# main_l5 health gate: tolerate provider-anomaly missing days (engineering missing days are always blocking).
GHTRADER_MAIN_L5_MISSING_DAYS_TOLERANCE=0
# Optional per-var tolerance.
# GHTRADER_MAIN_L5_MISSING_DAYS_TOLERANCE_AU=1
# Lock wait + auto preempt for stuck owners (SIGTERM -> SIGKILL) when timeout is reached.
GHTRADER_LOCK_WAIT_TIMEOUT_S=120
GHTRADER_LOCK_POLL_INTERVAL_S=1
GHTRADER_LOCK_FORCE_CANCEL_ON_TIMEOUT=true
GHTRADER_LOCK_PREEMPT_GRACE_S=8
# main-l5-validate lock policy: fail fast when same-symbol main-l5 is running.
GHTRADER_MAIN_L5_VALIDATE_LOCK_WAIT_TIMEOUT_S=3
# Health-check WAL wait: max seconds to retry row-count check after QuestDB WAL write.
GHTRADER_HEALTH_WAL_WAIT_S=30

# --- Training runtime (DDP / DataLoader) ---
# Override torchrun binary path if needed (default: torchrun from PATH)
GHTRADER_TORCHRUN_BIN=torchrun
# Auto DataLoader workers when CLI --num-workers=0
GHTRADER_TRAIN_NUM_WORKERS_AUTO=32
GHTRADER_TRAIN_PREFETCH_FACTOR=2
GHTRADER_TRAIN_PERSISTENT_WORKERS=true

# --- Observability / SLO thresholds ---
GHTRADER_SLO_QUEUE_WARN=64
GHTRADER_SLO_QUEUE_CRIT=128
GHTRADER_SLO_GPU_MIN=8
GHTRADER_SLO_REQUIRE_QUESTDB=true
GHTRADER_SLO_REQUIRE_REDIS=false

# --- Gap/outlier session whitelist ---
# When enabled, gap and outlier detection ignore cross-session deltas.
GHTRADER_GAP_SESSION_WHITELIST=true
# Optional: ignore the first/last N minutes of each session for outlier detection.
GHTRADER_OUTLIER_SESSION_WARMUP_MINUTES=0
GHTRADER_OUTLIER_SESSION_COOLDOWN_MINUTES=0
# Optional per-exchange-var session overrides (format: HH:MM-HH:MM;HH:MM-HH:MM;... or comma-separated).
# Examples for SHFE CU/AU/AG:
#   21:00-01:00;09:00-10:15;10:30-11:30;13:30-15:00
GHTRADER_GAP_SESSION_SHFE_CU=
GHTRADER_GAP_SESSION_SHFE_AU=
GHTRADER_GAP_SESSION_SHFE_AG=

# --- Optional: dashboard auth token (defense-in-depth) ---
# If set, dashboard requires access with: ?token=<TOKEN>
GHTRADER_DASHBOARD_TOKEN=

# --- Optional: daily Update scheduler (dashboard) ---
# If set, the dashboard will enqueue one `ghtrader update` job per trading day.
# Format examples:
# - SHFE:cu
# - SHFE:cu,SHFE:au
GHTRADER_DAILY_UPDATE_TARGETS=
GHTRADER_DAILY_UPDATE_RECENT_EXPIRED_DAYS=10
GHTRADER_DAILY_UPDATE_CATALOG_TTL_SECONDS=3600
GHTRADER_DAILY_UPDATE_POLL_SECONDS=60
GHTRADER_DAILY_UPDATE_MAX_CATCHUP_DAYS=0
GHTRADER_DAILY_UPDATE_RETRY_BACKOFF_SECONDS=300

